<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3DVR - Group Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="score.js"></script>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top, #1f2937 0%, #0f172a 65%);
      color: #e2e8f0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 20px 40px;
      gap: 32px;
    }

    a {
      color: inherit;
    }

    .page-width {
      width: 100%;
      max-width: 1120px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-height: 0;
    }

    .utility-links {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }

    .utility-links a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 18px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      border: 1px solid rgba(148, 163, 184, 0.28);
      text-decoration: none;
      font-weight: 500;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .utility-links a:hover {
      border-color: rgba(148, 163, 184, 0.5);
      transform: translateY(-1px);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(2rem, 2.6vw, 2.75rem);
      letter-spacing: -0.01em;
    }

    header p {
      margin: 0;
      color: rgba(226, 232, 240, 0.8);
      font-size: 1rem;
    }

    header strong {
      color: #38bdf8;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(240px, 280px) minmax(0, 1fr);
      gap: 24px;
      min-height: 0;
    }

    aside {
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-height: 0;
    }

    .sidebar-card {
      background: rgba(15, 23, 42, 0.78);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar-card h3 {
      margin: 0;
      font-size: 1.05rem;
      color: #f8fafc;
    }

    .sidebar-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: rgba(226, 232, 240, 0.8);
    }

    .sidebar-card li {
      display: grid;
      grid-template-columns: 20px minmax(0, 1fr);
      gap: 10px;
      line-height: 1.45;
    }

    .conversation {
      background: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 22px;
      box-shadow: 0 28px 60px rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(14px);
      padding: 26px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 0;
    }

    .conversation-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .conversation-header h2 {
      margin: 0;
      font-size: 1.6rem;
      color: #f8fafc;
    }

    .conversation-header p {
      margin: 0;
      color: rgba(226, 232, 240, 0.75);
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
      align-items: start;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: rgba(15, 23, 42, 0.72);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.32);
      padding: 16px;
      min-height: 0;
    }

    .field-label {
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(226, 232, 240, 0.7);
    }

    .field-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: #38bdf8;
      word-break: break-word;
    }

    .field-hint {
      margin: 0;
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.7);
      line-height: 1.4;
    }

    select,
    input,
    button {
      font-family: inherit;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      color: #f8fafc;
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    select:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
    }

    button {
      align-self: flex-start;
      padding: 12px 18px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #22d3ee);
      color: #0f172a;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(34, 211, 238, 0.35);
    }

    form#new-message {
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(15, 23, 42, 0.72);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 16px;
    }

    form#new-message button {
      white-space: nowrap;
    }

    #messages {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 6px;
    }

    #messages:focus-visible {
      outline: 2px solid #38bdf8;
      outline-offset: 2px;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.4);
      border-radius: 999px;
    }

    .message {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.12), rgba(14, 165, 233, 0.08));
      border-radius: 16px;
      padding: 16px 18px;
      color: #f8fafc;
      box-shadow: inset 0 0 0 1px rgba(56, 189, 248, 0.26);
      transition: transform 0.2s ease;
    }

    .message:hover {
      transform: translateY(-1px);
    }

    .message strong {
      color: #38bdf8;
    }

    .meta {
      margin-top: 6px;
      font-size: 0.8rem;
      color: rgba(226, 232, 240, 0.7);
    }

    footer {
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.7);
      text-align: center;
    }

    footer a {
      color: #38bdf8;
      text-decoration: none;
      font-weight: 500;
    }

    footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 1024px) {
      body {
        padding: 28px 16px 32px;
      }

      main {
        grid-template-columns: 1fr;
      }

      aside {
        order: 2;
      }

      .conversation {
        order: 1;
      }

      .control-grid {
        grid-template-columns: 1fr;
      }

      form#new-message {
        flex-direction: column;
        align-items: stretch;
      }

      form#new-message button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page-width">
    <nav class="utility-links" aria-label="Quick links">
      <a href="index.html">üè† Portal Home</a>
      <a href="profile.html">üßë Profile</a>
      <a href="https://3dvr.tech/#subscribe" target="_blank" rel="noreferrer">‚≠ê Subscribe</a>
      <a href="https://github.com/tmsteph/3dvr-portal" target="_blank" rel="noreferrer">üöÄ Contribute on GitHub</a>
    </nav>

    <header>
      <h1>Group Chat</h1>
      <p>üí¨ You earn <strong>+1 point</strong> for every message you send.</p>
    </header>

    <main>
      <aside>
        <section class="sidebar-card">
          <h3>Rooms at a glance</h3>
          <ul>
            <li><span>üåé</span><span><strong>General:</strong> Daily updates and community announcements.</span></li>
            <li><span>üí°</span><span><strong>Ideas:</strong> Workshop product concepts and feature pitches.</span></li>
            <li><span>üõü</span><span><strong>Support:</strong> Ask questions and get unstuck fast.</span></li>
            <li><span>üé≤</span><span><strong>Random:</strong> Celebrate wins, share inspiration, and connect.</span></li>
          </ul>
        </section>

        <section class="sidebar-card">
          <h3>Community rhythm</h3>
          <ul>
            <li><span>üóìÔ∏è</span><span>Host stand-ups in <strong>#general</strong> to keep everyone aligned.</span></li>
            <li><span>‚ú®</span><span>Use mentions to spotlight teammates and unblock decisions.</span></li>
            <li><span>üìå</span><span>Bookmark takeaways so newcomers land with full context.</span></li>
          </ul>
        </section>
      </aside>

      <section class="conversation" aria-labelledby="conversation-title">
        <div class="conversation-header">
          <h2 id="conversation-title">Live conversations</h2>
          <p>Switch rooms, catch up on the scrollback, and drop a note right away.</p>
        </div>

        <div class="control-grid">
          <label class="field" id="room-select">
            <span class="field-label">Room</span>
            <select id="room" onchange="changeRoom()">
              <option value="general">üåé General</option>
              <option value="ideas">üí° Ideas</option>
              <option value="support">üõü Support</option>
              <option value="random">üé≤ Random</option>
            </select>
            <p class="field-hint">Hop between conversations without losing context.</p>
          </label>

          <div class="field chat-identity">
            <span class="field-label">You</span>
            <span class="field-value" id="current-username">Loading‚Ä¶</span>
            <p class="field-hint">Messages here earn community points.</p>
          </div>

          <div class="field" id="notification-settings">
            <span class="field-label">Notifications</span>
            <button id="notification-toggle" type="button" onclick="toggleNotifications()">Enable Notifications</button>
            <span class="field-hint" id="notification-status">Checking permissions‚Ä¶</span>
          </div>
        </div>

        <form id="new-message" autocomplete="off">
          <label for="message-input" class="sr-only">Message</label>
          <input type="text" id="message-input" name="message" placeholder="Type your message‚Ä¶" aria-label="Message" />
          <button type="submit">Send</button>
        </form>

        <div id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>
      </section>
    </main>
  </div>

  <footer>
    3DVR.Tech &copy; 2025 - Open Web for Everyone | Visit <a href="https://3dvr.tech">3DVR.Tech</a> | <a href="https://github.com/tmsteph/3dvr-portal">Contribute on GitHub</a>
  </footer>

  <script>
const gun = Gun([
  'https://gun-relay-3dvr.fly.dev/gun',
]);
const portalRoot = gun.get('3dvr-portal');
const gunSupportsUser = typeof gun.user === 'function';
const portalUser = gunSupportsUser ? gun.user() : null;
const scoreManager = window.ScoreSystem && typeof window.ScoreSystem.getManager === 'function'
  ? window.ScoreSystem.getManager({
      gun: gunSupportsUser ? gun : null,
      user: portalUser,
      portalRoot
    })
  : null;
let currentRoom = 'general';
let chat = gun.get('3dvr-chat').get(currentRoom);
let userId = '';
let cachedUsername = 'Guest';
let currentRoomStream = null;
let isGuestIdentity = false;
const notifiedMessageIdsByRoom = {};
const notifiedMessageQueueByRoom = {};
const roomInitialSyncTimers = {};
const notificationStateStorageKey = '3dvrChatNotificationState_v1';
const notificationToggleButton = document.getElementById('notification-toggle');
const notificationStatusText = document.getElementById('notification-status');
const currentUsernameEl = document.getElementById('current-username');
const messageForm = document.getElementById('new-message');
const notificationsSupported = 'Notification' in window && 'serviceWorker' in navigator;

if (messageForm) {
  messageForm.addEventListener('submit', event => {
    event.preventDefault();
    sendMessage();
  });
}

function safeGetStorage(key) {
  try {
    return localStorage.getItem(key) || '';
  } catch (error) {
    console.warn('Unable to read from storage', error);
    return '';
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, value);
  } catch (error) {
    console.warn('Unable to write to storage', error);
  }
}

function safeRemoveStorage(key) {
  try {
    localStorage.removeItem(key);
  } catch (error) {
    console.warn('Unable to remove from storage', error);
  }
}

function fetchSenderUsername(senderId, callback) {
  if (!gunSupportsUser || !senderId) {
    callback('');
    return;
  }

  try {
    gun.user(senderId).get('alias').once(alias => {
      if (typeof alias === 'string' && alias.trim()) {
        callback(alias.trim());
      } else {
        callback('');
      }
    });
  } catch (error) {
    console.warn('Failed to fetch alias', error);
    callback('');
  }
}

function loadUser() {
  if (!portalUser) {
    isGuestIdentity = true;
    const storedGuestId = safeGetStorage('guestId');
    if (storedGuestId) {
      userId = storedGuestId;
    } else {
      userId = `guest_${Math.random().toString(36).slice(2, 10)}`;
      safeSetStorage('guestId', userId);
    }
    const storedGuestName = safeGetStorage('guestDisplayName').trim();
    cachedUsername = storedGuestName || derivePreferredUsername('');
    applyUsernameToUI(cachedUsername);
    return;
  }

  portalUser.recall({ sessionStorage: true }, ({ err }) => {
    if (err) {
      console.warn('Error recalling user', err);
      isGuestIdentity = true;
      userId = `guest_${Math.random().toString(36).slice(2, 10)}`;
      safeSetStorage('guestId', userId);
      cachedUsername = derivePreferredUsername('');
      applyUsernameToUI(cachedUsername);
      return;
    }

    portalUser.auth(safeGetStorage('alias'), safeGetStorage('pass'), authResult => {
      if (authResult && authResult.err) {
        console.warn('Auth error', authResult.err);
        isGuestIdentity = true;
        userId = `guest_${Math.random().toString(36).slice(2, 10)}`;
        safeSetStorage('guestId', userId);
        cachedUsername = derivePreferredUsername('');
        applyUsernameToUI(cachedUsername);
        return;
      }

      const alias = safeGetStorage('alias');
      const pub = safeGetStorage('pub');
      if (alias && pub) {
        userId = pub;
        isGuestIdentity = false;
        fetchSenderUsername(userId, name => {
          const preferred = derivePreferredUsername(name);
          cachedUsername = preferred;
          applyUsernameToUI(preferred);
        });
      } else {
        isGuestIdentity = true;
        userId = `guest_${Math.random().toString(36).slice(2, 10)}`;
        safeSetStorage('guestId', userId);
        cachedUsername = derivePreferredUsername('');
        applyUsernameToUI(cachedUsername);
      }
    });
  });
}

loadUser();

function loadNotificationState() {
  try {
    const raw = localStorage.getItem(notificationStateStorageKey);
    if (!raw) {
      return { rooms: {} };
    }

    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object') {
      return { rooms: {} };
    }

    if (!parsed.rooms || typeof parsed.rooms !== 'object') {
      parsed.rooms = {};
    }

    Object.keys(parsed.rooms).forEach(room => {
      const roomState = parsed.rooms[room];
      if (!roomState || typeof roomState !== 'object') {
        parsed.rooms[room] = {
          lastSeenTimestamp: 0,
          lastSeenMessageIds: [],
          initialSync: true,
          initialSyncCutoff: 0
        };
        return;
      }

      if (typeof roomState.lastSeenTimestamp !== 'number' || !Number.isFinite(roomState.lastSeenTimestamp)) {
        roomState.lastSeenTimestamp = 0;
      }

      if (!Array.isArray(roomState.lastSeenMessageIds)) {
        roomState.lastSeenMessageIds = [];
      }

      roomState.initialSync = Boolean(roomState.initialSync);
      roomState.initialSyncCutoff = typeof roomState.initialSyncCutoff === 'number'
        ? roomState.initialSyncCutoff
        : 0;
    });

    return parsed;
  } catch (error) {
    console.warn('Unable to load notification state', error);
    return { rooms: {} };
  }
}

const notificationState = loadNotificationState();

function persistNotificationState() {
  try {
    localStorage.setItem(notificationStateStorageKey, JSON.stringify(notificationState));
  } catch (error) {
    console.warn('Failed to persist notification state', error);
  }
}

function getRoomNotificationState(room) {
  if (!notificationState.rooms || typeof notificationState.rooms !== 'object') {
    notificationState.rooms = {};
  }

  if (!notificationState.rooms[room]) {
    notificationState.rooms[room] = {
      lastSeenTimestamp: 0,
      lastSeenMessageIds: [],
      initialSync: true,
      initialSyncCutoff: 0
    };
  } else {
    const roomState = notificationState.rooms[room];
    if (typeof roomState.lastSeenTimestamp !== 'number' || !Number.isFinite(roomState.lastSeenTimestamp)) {
      roomState.lastSeenTimestamp = 0;
    }
    if (!Array.isArray(roomState.lastSeenMessageIds)) {
      roomState.lastSeenMessageIds = [];
    }
    if (typeof roomState.initialSync !== 'boolean') {
      roomState.initialSync = true;
    }
    if (typeof roomState.initialSyncCutoff !== 'number' || !Number.isFinite(roomState.initialSyncCutoff)) {
      roomState.initialSyncCutoff = 0;
    }
  }

  return notificationState.rooms[room];
}

function updateRoomStateWithMessage(roomState, createdAt, id) {
  if (!roomState) return;

  const timestamp = typeof createdAt === 'number' && Number.isFinite(createdAt)
    ? createdAt
    : 0;

  if (!timestamp) {
    if (id) {
      const ids = roomState.lastSeenMessageIds;
      if (!ids.includes(id)) {
        ids.push(id);
        if (ids.length > 10) {
          ids.splice(0, ids.length - 10);
        }
      }
    }
    return;
  }

  if (!roomState.lastSeenTimestamp || timestamp > roomState.lastSeenTimestamp) {
    roomState.lastSeenTimestamp = timestamp;
    roomState.lastSeenMessageIds = id ? [id] : [];
    return;
  }

  if (timestamp === roomState.lastSeenTimestamp && id) {
    const ids = roomState.lastSeenMessageIds;
    if (!ids.includes(id)) {
      ids.push(id);
      if (ids.length > 10) {
        ids.splice(0, ids.length - 10);
      }
    }
  }
}

function clearInitialSyncTimer(room) {
  const timer = roomInitialSyncTimers[room];
  if (timer) {
    clearTimeout(timer);
    delete roomInitialSyncTimers[room];
  }
}

function beginRoomNotificationSync(room) {
  const roomState = getRoomNotificationState(room);
  roomState.initialSync = true;
  clearInitialSyncTimer(room);
  roomInitialSyncTimers[room] = setTimeout(() => {
    const state = getRoomNotificationState(room);
    state.initialSync = false;
    state.initialSyncCutoff = Date.now();
    persistNotificationState();
  }, 4000);
}

function markRoomAsSeen(room, message) {
  const state = getRoomNotificationState(room);
  if (!state) return;
  updateRoomStateWithMessage(state, message.createdAt, message.id);
  persistNotificationState();
}

function showNotification(message, id) {
  if (!notificationsSupported || Notification.permission !== 'granted') return;

  const bodyParts = [];
  if (message.username) {
    bodyParts.push(`${message.username}:`);
  }
  bodyParts.push(message.text || 'New message');
  const body = bodyParts.join(' ');

  navigator.serviceWorker.ready.then(registration => {
    registration.showNotification('3DVR Chat', {
      body,
      tag: `chat-${currentRoom}-${id}`,
      data: { room: currentRoom, messageId: id },
      icon: 'icons/icon-192.png',
      badge: 'icons/icon-96.png'
    });
  }).catch(error => {
    console.warn('Notification failed', error);
  });
}

function maybeNotifyNewMessage(message, id) {
  if (!message || !id) return;
  const roomState = getRoomNotificationState(currentRoom);
  if (!roomState) return;

  if (roomState.initialSync) {
    updateRoomStateWithMessage(roomState, message.createdAt, id);
    return;
  }

  const cutoff = roomState.initialSyncCutoff || 0;
  if (message.createdAt && message.createdAt <= cutoff) {
    updateRoomStateWithMessage(roomState, message.createdAt, id);
    return;
  }

  const queue = notifiedMessageQueueByRoom[currentRoom] || (notifiedMessageQueueByRoom[currentRoom] = []);
  const seenIds = notifiedMessageIdsByRoom[currentRoom] || (notifiedMessageIdsByRoom[currentRoom] = new Set());

  if (seenIds.has(id)) {
    return;
  }

  seenIds.add(id);
  queue.push({ id, message });

  if (queue.length > 3) {
    const removed = queue.shift();
    if (removed) {
      seenIds.delete(removed.id);
    }
  }

  showNotification(message, id);
  updateRoomStateWithMessage(roomState, message.createdAt, id);
  persistNotificationState();
}

const messages = {};

function resetNotifiedStateForRoom(room) {
  if (!room) return;
  const set = notifiedMessageIdsByRoom[room];
  const queue = notifiedMessageQueueByRoom[room];
  if (set) {
    set.clear();
  }
  if (queue) {
    queue.length = 0;
  }
}

function timeAgoOrFullDate(timestamp) {
  const now = Date.now();
  const diff = Math.floor((now - timestamp) / 1000);
  if (diff < 60) return `${diff}s ago`;
  const mins = Math.floor(diff / 60);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const date = new Date(timestamp);
  return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function displayMessages() {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';

  const sorted = Object.entries(messages).sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));
  for (const [id, message] of sorted) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    msgDiv.id = id;

    const username = (typeof message.username === 'string' ? message.username.trim() : '') ||
      (message.sender || 'Anonymous');
    const time = message.createdAt ? timeAgoOrFullDate(message.createdAt) : '';

    msgDiv.innerHTML = `<div><strong>${username}:</strong> ${message.text}</div><div class="meta">${time}</div>`;
    messagesDiv.appendChild(msgDiv);
  }

  messagesDiv.scrollTop = 0;
}

function loadRoom(roomName) {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  Object.keys(messages).forEach(key => delete messages[key]);
  resetNotifiedStateForRoom(roomName);
  beginRoomNotificationSync(roomName);

  if (currentRoomStream && typeof currentRoomStream.off === 'function') {
    currentRoomStream.off();
  }

  chat = gun.get('3dvr-chat').get(roomName);
  const roomStream = chat.map();
  currentRoomStream = roomStream;

  roomStream.on((message, id) => {
    if (!message || messages[id]) return;

    if (message.sender) {
      const existingUsername = typeof message.username === 'string'
        ? message.username.trim()
        : '';
      if (existingUsername) {
        message.username = existingUsername;
        messages[id] = message;
        displayMessages();
        maybeNotifyNewMessage(message, id);
        return;
      }

      fetchSenderUsername(message.sender, resolvedName => {
        const finalName = resolvedName || message.sender;
        message.username = finalName;
        messages[id] = message;
        displayMessages();
        maybeNotifyNewMessage(message, id);
      });
    } else {
      messages[id] = message;
      displayMessages();
      maybeNotifyNewMessage(message, id);
    }
  });
}

function changeRoom() {
  currentRoom = document.getElementById('room').value;
  loadRoom(currentRoom);
}

loadRoom(currentRoom);

function initNotifications() {
  if (!notificationToggleButton || !notificationStatusText) return;

  if (!notificationsSupported) {
    notificationToggleButton.style.display = 'none';
    notificationStatusText.textContent = 'Notifications are not supported in this browser.';
    return;
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(() => {
      notificationStatusText.textContent = 'Notifications are ready when you are.';
    }).catch(() => {
      notificationStatusText.textContent = 'Notifications require service worker support.';
    });
  }

  if (Notification.permission === 'granted') {
    notificationToggleButton.textContent = 'Notifications Enabled';
    notificationToggleButton.disabled = true;
    notificationToggleButton.setAttribute('aria-disabled', 'true');
    notificationStatusText.textContent = 'Notifications are enabled.';
  } else if (Notification.permission === 'denied') {
    notificationToggleButton.style.display = 'none';
    notificationStatusText.textContent = 'Notifications are blocked in your browser settings.';
  } else {
    notificationToggleButton.disabled = false;
    notificationToggleButton.removeAttribute('aria-disabled');
    notificationToggleButton.style.display = '';
    notificationStatusText.textContent = 'Enable push updates for new chat activity.';
  }
}

initNotifications();

function toggleNotifications() {
  if (!notificationsSupported || !notificationToggleButton || !notificationStatusText) return;

  if (Notification.permission === 'granted') {
    notificationStatusText.textContent = 'Notifications are already enabled. You can disable them in your browser settings.';
    return;
  }

  Notification.requestPermission().then(permission => {
    if (permission === 'granted') {
      notificationToggleButton.textContent = 'Notifications Enabled';
      notificationToggleButton.disabled = true;
      notificationToggleButton.setAttribute('aria-disabled', 'true');
      notificationStatusText.textContent = 'Notifications are enabled.';
    } else if (permission === 'denied') {
      notificationToggleButton.style.display = 'none';
      notificationStatusText.textContent = 'Notifications are blocked in your browser settings.';
    } else {
      notificationToggleButton.disabled = false;
      notificationToggleButton.removeAttribute('aria-disabled');
      notificationToggleButton.style.display = '';
      notificationStatusText.textContent = 'Enable push updates for new chat activity.';
    }
  }).catch(() => {
    notificationStatusText.textContent = 'Unable to change notification settings right now.';
  });
}

function applyUsernameToUI(name) {
  const normalized = typeof name === 'string' ? name.trim() : '';
  const finalName = normalized || 'Guest';
  cachedUsername = finalName;
  if (normalized) {
    if (isGuestIdentity) {
      safeSetStorage('guestDisplayName', normalized);
    } else {
      safeSetStorage('username', normalized);
    }
  } else {
    if (isGuestIdentity) {
      safeSetStorage('guestDisplayName', 'Guest');
    } else {
      safeRemoveStorage('username');
    }
  }
  if (!currentUsernameEl) return;
  currentUsernameEl.innerText = finalName;
}

function derivePreferredUsername(existingName) {
  const normalizedExisting = typeof existingName === 'string' ? existingName.trim() : '';
  const storedGuestName = isGuestIdentity ? safeGetStorage('guestDisplayName').trim() : '';
  const storedUsername = safeGetStorage('username').trim();

  if (isGuestIdentity && storedGuestName) {
    return storedGuestName;
  }

  if (!isGuestIdentity && storedUsername) {
    return storedUsername;
  }

  const aliasValue = safeGetStorage('alias').trim();
  const aliasName = aliasValue
    ? (aliasValue.includes('@') ? aliasValue.split('@')[0] : aliasValue)
    : '';

  if (aliasName && (!normalizedExisting || isGeneratedName(normalizedExisting))) {
    return aliasName;
  }

  if (normalizedExisting) return normalizedExisting;

  if (aliasName) return aliasName;

  if (isGuestIdentity && storedGuestName) {
    return storedGuestName;
  }

  const suffix = extractIdSuffix(userId);
  const baseLabel = 'Guest';
  return suffix ? `${baseLabel} ${suffix}` : baseLabel;
}

function extractIdSuffix(id) {
  if (!id) return '';
  const parts = id.split('_');
  const lastPart = parts[parts.length - 1] || '';
  return lastPart.slice(-4).toUpperCase();
}

function isGeneratedName(name) {
  if (!name) return false;
  const lower = name.toLowerCase();
  return lower === 'guest' ||
    lower.startsWith('guest ') ||
    lower.startsWith('guest_') ||
    lower === 'user' ||
    lower.startsWith('user ') ||
    lower.startsWith('user_');
}

function sendMessage() {
  const input = document.getElementById('message-input');
  const text = input.value.trim();
  if (!text) return;

  chat.set({
    text,
    sender: userId,
    username: cachedUsername,
    createdAt: Date.now()
  });

  input.value = '';

  if (scoreManager) {
    scoreManager.increment(1);
  }
}

function initKeyboardShortcuts() {
  const input = document.getElementById('message-input');
  if (!input) return;

  input.addEventListener('keydown', event => {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  });
}

initKeyboardShortcuts();

function loadStoredUsername() {
  const stored = safeGetStorage('username').trim();
  if (stored) {
    cachedUsername = stored;
    applyUsernameToUI(stored);
  }
}

loadStoredUsername();

function setupRoomObserver(roomName) {
  if (!roomName) return;
  resetNotifiedStateForRoom(roomName);
  beginRoomNotificationSync(roomName);
}

setupRoomObserver(currentRoom);
  </script>
</body>
</html>
