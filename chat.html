<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3DVR - Group Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #e9f0f5;
      color: #222;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 2.5rem;
      margin: 0;
    }

    header p {
      color: #555;
      font-size: 1.1rem;
    }

    #profile-mini {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center;
      width: 100%;
      max-width: 500px;
      margin-bottom: 20px;
    }

    #notification-settings {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center;
      width: 100%;
      max-width: 500px;
      margin-bottom: 20px;
    }

    #notification-settings button {
      margin-top: 10px;
    }

    #notification-status {
      display: block;
      margin-top: 5px;
      color: #555;
      font-size: 0.95rem;
    }

    #room-select {
      margin-bottom: 20px;
      text-align: center;
    }

    #room-select select {
      padding: 10px;
      border-radius: 8px;
      font-size: 1rem;
    }

    #new-message {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      width: 100%;
      max-width: 700px;
    }

    input[type="text"], button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
    }

    input[type="text"] {
      flex-grow: 1;
    }

    button {
      background: #66c2b0;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #5ca0d3;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      max-width: 700px;
      width: 100%;
    }

    .message {
      background: #ffffff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      color: #333;
    }

    .meta {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }

    footer {
      margin-top: 40px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      color: #888;
      text-align: center;
    }

    footer a {
      color: #5ca0d3;
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">üè† Portal Home</a>
  <a href="profile.html">üßë Profile</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ Contribute on GitHub</a>
</div>

<header>
  <h1>Group Chat</h1>
  <p>üí¨ You earn <strong>+1 point</strong> for every message you send!</p>
</header>

<div id="notification-settings">
  <strong>üîî Chat notifications</strong>
  <span id="notification-status">Checking permissions‚Ä¶</span>
  <button id="notification-toggle" onclick="toggleNotifications()">Enable Notifications</button>
</div>

<div id="profile-mini">
  <p><strong>Username:</strong> <span id="current-username">Loading...</span></p>
</div>

<div id="room-select">
  <label for="room">Select Room:</label>
  <select id="room" onchange="changeRoom()">
    <option value="general">üåé General</option>
    <option value="ideas">üí° Ideas</option>
    <option value="support">üõü Support</option>
    <option value="random">üé≤ Random</option>
  </select>
</div>

<div id="new-message">
  <input type="text" id="message-input" placeholder="Type your message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<div id="messages"></div>

<footer>
  3DVR.Tech &copy; 2025 - Open Web for Everyone | Visit <a href="https://3dvr.tech">3DVR.Tech</a> | <a href="https://github.com/tmsteph/3dvr-portal">Contribute on GitHub</a>
</footer>

<script>
const gun = Gun([
  'https://gun-relay-3dvr.fly.dev/gun',          // üëà primary
]);
let currentRoom = 'general';
let chat = gun.get('3dvr-chat').get(currentRoom);

const notificationToggleButton = document.getElementById('notification-toggle');
const notificationStatusText = document.getElementById('notification-status');
const notificationsSupported = 'Notification' in window;
const notificationsPreferenceKey = 'chatNotificationsEnabled';
const notificationIconPath = '/icons/icon-192.png';
let notificationsEnabled = false;
let serviceWorkerRegistration = null;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'notification-clicked') {
      window.focus();
    }
  });
}

const currentUsernameEl = document.getElementById('current-username');
let cachedUsername = '';

const userId = localStorage.getItem('userId') || (() => {
  const id = 'user_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('userId', id);
  return id;
})();
const user = gun.get('3dvr-users').get(userId);

// Auto import old chats into General (only runs if in General and no messages exist)
if (currentRoom === 'general') {
  gun.get('3dvr-chat').map().once((message, id) => {
    if (!message) return;
    chat.get(id).once(existing => {
      if (!existing) {
        chat.get(id).put(message);
        console.log('Imported old message:', id);
      }
    });
  });
}

const initialUsername = derivePreferredUsername();
applyUsernameToUI(initialUsername);

user.get('username').once(existingName => {
  const resolvedName = derivePreferredUsername(existingName);
  applyUsernameToUI(resolvedName);
  const normalizedExisting = typeof existingName === 'string' ? existingName.trim() : '';
  if (normalizedExisting !== resolvedName) {
    user.get('username').put(resolvedName);
  }
});

user.get('username').on(name => {
  const normalized = typeof name === 'string' ? name.trim() : '';
  if (!normalized) return;
  applyUsernameToUI(normalized);
});

function applyUsernameToUI(name) {
  const normalized = typeof name === 'string' ? name.trim() : '';
  const finalName = normalized || 'Guest';
  cachedUsername = finalName;
  if (!currentUsernameEl) return;
  currentUsernameEl.innerText = finalName;
}

function derivePreferredUsername(existingName) {
  const storedUsername = (localStorage.getItem('username') || '').trim();
  if (storedUsername) return storedUsername;

  const aliasValue = (localStorage.getItem('alias') || '').trim();
  const aliasName = aliasValue
    ? (aliasValue.includes('@') ? aliasValue.split('@')[0] : aliasValue)
    : '';

  const existing = typeof existingName === 'string' ? existingName.trim() : '';
  if (aliasName && (!existing || isGeneratedName(existing))) {
    return aliasName;
  }

  if (existing) return existing;

  if (aliasName) return aliasName;

  const suffix = extractIdSuffix(userId);
  const baseLabel = 'Guest';
  return suffix ? `${baseLabel} ${suffix}` : baseLabel;
}

function extractIdSuffix(id) {
  if (!id) return '';
  const parts = id.split('_');
  const lastPart = parts[parts.length - 1] || '';
  return lastPart.slice(-4).toUpperCase();
}

function isGeneratedName(name) {
  if (!name) return false;
  const lower = name.toLowerCase();
  return lower === 'guest' ||
    lower.startsWith('guest ') ||
    lower.startsWith('guest_') ||
    lower === 'user' ||
    lower.startsWith('user ') ||
    lower.startsWith('user_');
}

function sendMessage() {
  const input = document.getElementById('message-input');
  const text = input.value.trim();
  if (!text) return;

  chat.set({
    text,
    sender: userId,
    username: cachedUsername,
    createdAt: Date.now()
  });

  input.value = '';

  user.get('score').once(currentScore => {
    const newScore = (currentScore || 0) + 1;
    user.get('score').put(newScore);
  });
}

const messages = {};

function timeAgoOrFullDate(timestamp) {
  const now = Date.now();
  const diff = Math.floor((now - timestamp) / 1000);
  if (diff < 60) return `${diff}s ago`;
  const mins = Math.floor(diff / 60);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const date = new Date(timestamp);
  return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function displayMessages() {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';

  const sorted = Object.entries(messages).sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));
  for (const [id, message] of sorted) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    msgDiv.id = id;

    const username = (typeof message.username === 'string' ? message.username.trim() : '') ||
      (message.sender || 'Anonymous');
    const time = message.createdAt ? timeAgoOrFullDate(message.createdAt) : '';

    msgDiv.innerHTML = `<div><strong>${username}:</strong> ${message.text}</div><div class="meta">${time}</div>`;
    messagesDiv.appendChild(msgDiv);
  }
}

function loadRoom(roomName) {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  Object.keys(messages).forEach(key => delete messages[key]);

  chat = gun.get('3dvr-chat').get(roomName);
  chat.map().on((message, id) => {
    if (!message || messages[id]) return;

    if (message.sender) {
      const existingUsername = typeof message.username === 'string'
        ? message.username.trim()
        : '';
      if (existingUsername) {
        message.username = existingUsername;
        messages[id] = message;
        displayMessages();
        maybeNotifyNewMessage(message, id);
        return;
      }

      gun.get('3dvr-users').get(message.sender).get('username').once(name => {
        const resolvedUsername = typeof name === 'string'
          ? name.trim()
          : '';
        message.username = resolvedUsername || message.sender;
        messages[id] = message;
        displayMessages();
        maybeNotifyNewMessage(message, id);
      });
    } else {
      messages[id] = message;
      displayMessages();
      maybeNotifyNewMessage(message, id);
    }
  });
}

function changeRoom() {
  currentRoom = document.getElementById('room').value;
  loadRoom(currentRoom);
}

loadRoom(currentRoom);

function initNotifications() {
  if (!notificationToggleButton || !notificationStatusText) return;

  if (!notificationsSupported) {
    notificationToggleButton.style.display = 'none';
    notificationStatusText.textContent = 'Notifications are not supported in this browser.';
    return;
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(existingRegistration => {
      if (existingRegistration) {
        serviceWorkerRegistration = existingRegistration;
        return existingRegistration;
      }
      return navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
        .then(registration => {
          serviceWorkerRegistration = registration;
          return registration;
        });
    }).catch(error => {
      console.error('Service worker registration failed for chat notifications', error);
    });
  }

  const savedPreference = localStorage.getItem(notificationsPreferenceKey) === 'true';
  if (savedPreference && Notification.permission === 'granted') {
    notificationsEnabled = true;
  }

  updateNotificationUI();
}

function updateNotificationUI() {
  if (!notificationToggleButton || !notificationStatusText) return;

  if (!notificationsSupported) {
    notificationToggleButton.style.display = 'none';
    notificationStatusText.textContent = 'Notifications are not supported in this browser.';
    return;
  }

  if (Notification.permission === 'denied') {
    notificationToggleButton.disabled = true;
    notificationStatusText.textContent = 'Notifications are blocked in your browser settings.';
    return;
  }

  notificationToggleButton.disabled = false;
  notificationToggleButton.textContent = notificationsEnabled ? 'Disable Notifications' : 'Enable Notifications';

  if (notificationsEnabled && Notification.permission === 'granted') {
    notificationStatusText.textContent = 'Notifications are on. We will alert you about new messages.';
  } else {
    notificationStatusText.textContent = 'Notifications are off. Click enable to stay updated.';
  }
}

function toggleNotifications() {
  if (!notificationsSupported) return;

  if (notificationsEnabled) {
    notificationsEnabled = false;
    localStorage.setItem(notificationsPreferenceKey, 'false');
    updateNotificationUI();
    return;
  }

  if (Notification.permission === 'granted') {
    notificationsEnabled = true;
    localStorage.setItem(notificationsPreferenceKey, 'true');
    updateNotificationUI();
    sendNotificationPreview();
    return;
  }

  Notification.requestPermission().then(permission => {
    notificationsEnabled = permission === 'granted';
    localStorage.setItem(notificationsPreferenceKey, notificationsEnabled ? 'true' : 'false');

    if (permission === 'denied') {
      notificationStatusText.textContent = 'Notifications are blocked in your browser settings.';
    }

    updateNotificationUI();

    if (permission === 'granted') {
      sendNotificationPreview();
    }
  });
}

async function attemptServiceWorkerNotification(registration, title, options) {
  if (!registration) return false;

  try {
    if (registration.active && typeof registration.active.postMessage === 'function') {
      registration.active.postMessage({
        type: 'show-notification',
        payload: { title, options }
      });
      return true;
    }

    if (typeof registration.showNotification === 'function') {
      await registration.showNotification(title, options);
      return true;
    }
  } catch (error) {
    console.error('Service worker notification attempt failed', error);
  }

  return false;
}

async function showChatNotification(title, options = {}, config = {}) {
  if (!notificationsEnabled || !notificationsSupported) return;
  if (!title || Notification.permission !== 'granted') return;

  const { requireHidden = true } = config;
  if (requireHidden && document.visibilityState === 'visible') return;

  const enrichedOptions = {
    ...options,
    icon: options.icon || notificationIconPath,
    badge: options.badge || notificationIconPath,
    timestamp: Date.now(),
    data: {
      ...options.data,
      url: options.data?.url || `/chat.html#${currentRoom}`,
      room: currentRoom
    }
  };

  const fallbackToPageNotification = () => {
    try {
      const notification = new Notification(title, enrichedOptions);
      setTimeout(() => notification.close(), 8000);
    } catch (error) {
      console.error('Unable to show notification', error);
    }
  };

  if (!('serviceWorker' in navigator)) {
    fallbackToPageNotification();
    return;
  }

  if (await attemptServiceWorkerNotification(serviceWorkerRegistration, title, enrichedOptions)) {
    return;
  }

  try {
    const registration = await navigator.serviceWorker.ready;
    serviceWorkerRegistration = registration;

    const success = await attemptServiceWorkerNotification(registration, title, enrichedOptions);
    if (!success) {
      fallbackToPageNotification();
    }
  } catch (error) {
    console.error('Service worker readiness error', error);
    fallbackToPageNotification();
  }
}

function sendNotificationPreview() {
  showChatNotification(
    'Chat notifications enabled',
    {
      body: 'We will let you know when someone posts a new message.',
      tag: 'chat-notification-preview',
      data: { messageId: 'preview' }
    },
    { requireHidden: false }
  );
}

function maybeNotifyNewMessage(message, id) {
  if (!message || message.sender === userId) return;

  const username = (typeof message.username === 'string' ? message.username.trim() : '') ||
    message.sender ||
    'Someone';

  const rawPreview = typeof message.text === 'string'
    ? message.text.trim()
    : String(message.text || '').trim();
  const notificationBody = rawPreview.length > 160 ? `${rawPreview.slice(0, 157)}...` : rawPreview;

  const title = `${username} in #${currentRoom}`;
  const options = {
    body: notificationBody || 'New message',
    tag: `${currentRoom}-${id}`,
    data: {
      messageId: id
    }
  };

  showChatNotification(title, options, { requireHidden: true });
}

initNotifications();
</script>

</body>
</html>
