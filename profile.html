<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3DVR - Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    body {
      background: #e9f0f5;
      color: #222;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #333;
      font-size: 2.4rem;
      margin-top: 0;
    }
    #profile {
      background: #ffffff;
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    #profile p {
      margin: 10px 0;
      font-size: 1.1rem;
    }
    input {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 80%;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      border-radius: 8px;
      background: #66c2b0;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #5ca0d3;
    }
    .progress-bar {
      width: 100%;
      background-color: #eee;
      border-radius: 8px;
      margin-top: 20px;
      overflow: hidden;
    }
    .progress {
      height: 20px;
      background-color: #66c2b0;
      width: 0%;
      transition: width 0.5s ease;
    }
    .teaser {
      margin-top: 20px;
      color: #666;
      font-size: 0.9rem;
    }
    .reset-btn {
      margin-top: 20px;
      font-size: 0.8rem;
      background: none;
      border: none;
      color: #5ca0d3;
      text-decoration: underline;
      cursor: pointer;
    }
    .reset-btn:hover {
      color: #3498db;
    }
  </style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">üè† Portal</a>
  <a href="notes.html">üìù Shared Notes</a>
  <a href="tasks.html">‚úÖ Task Board</a>
  <a href="games.html">üéÆ Mini Games</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ GitHub</a>
</div>

<h1>üë§ Profile</h1>

<div id="profile">
  <p><strong>Username:</strong> <span id="username">Guest</span></p>
  <p><strong>Score:</strong> <span id="score">0</span></p>
  <p><strong>Level:</strong> <span id="level">Explorer</span></p>

  <div class="progress-bar">
    <div class="progress" id="progress"></div>
  </div>

  <input type="text" id="name-input" placeholder="Enter new username...">
  <button onclick="saveUsername()">Save Username</button>

  <div class="teaser">
    üìö Unlock Education at 500 Score ‚Ä¢ üõ†Ô∏è Become a Creator at 1500 ‚Ä¢ üöÄ Become a Builder at 3000
  </div>

  <button onclick="addPoints(100)">+100 Points</button>
  <button class="reset-btn" onclick="resetProfile()">Reset Profile</button>
</div>

<script>
const gun = Gun(['https://gun-relay-3dvr.fly.dev/gun']);
const user = gun.user();
user.recall({ sessionStorage: true });

let activeProfile = user;
let latestProfileName = '';
let aliasName = '';
let isSignedIn = localStorage.getItem('signedIn') === 'true';
let portalStoredName = (localStorage.getItem('username') || '').trim();
let guestStoredName = (localStorage.getItem('guestDisplayName') || '').trim();

const usernameEl = document.getElementById('username');
const scoreEl = document.getElementById('score');
const levelEl = document.getElementById('level');
const progressEl = document.getElementById('progress');

function computeDisplayName() {
  if (latestProfileName) return latestProfileName;
  if (isSignedIn) {
    if (portalStoredName) return portalStoredName;
    if (aliasName) return aliasName;
  } else {
    if (guestStoredName) return guestStoredName;
  }
  if (!isSignedIn && aliasName) return aliasName;
  return 'Guest';
}

function applyDisplayName() {
  usernameEl.innerText = computeDisplayName();
}

function handleProfileName(name) {
  const normalized = typeof name === 'string' ? name.trim() : '';
  latestProfileName = normalized;
  if (normalized) {
    if (isSignedIn) {
      portalStoredName = normalized;
      localStorage.setItem('username', portalStoredName);
    } else {
      guestStoredName = normalized;
      localStorage.setItem('guestDisplayName', guestStoredName);
    }
  }
  applyDisplayName();
}

function normalizeScore(value) {
  const numeric = typeof value === 'number' ? value : Number(value);
  if (!Number.isFinite(numeric)) return 0;
  return Math.max(0, Math.round(numeric));
}

function updateProfile(scoreValue) {
  const safeScore = normalizeScore(scoreValue);
  scoreEl.innerText = safeScore;

  let level = 'Explorer';
  let progress = (safeScore / 500) * 100;

  if (safeScore >= 3000) {
    level = 'Builder';
    progress = ((safeScore - 3000) / 1000) * 100;
  } else if (safeScore >= 1500) {
    level = 'Creator';
    progress = ((safeScore - 1500) / 1500) * 100;
  } else if (safeScore >= 500) {
    level = 'Apprentice';
    progress = ((safeScore - 500) / 1000) * 100;
  }

  levelEl.innerText = level;
  progressEl.style.width = `${Math.max(0, Math.min(progress, 100))}%`;
}

function watchProfile(node) {
  node.get('username').on(handleProfileName);
  node.get('score').on(updateProfile);
}

function ensureGuestDefaults(node) {
  const fallbackName = guestStoredName || 'Guest';
  node.get('username').once(name => {
    const normalized = typeof name === 'string' ? name.trim() : '';
    if (!normalized) {
      node.get('username').put(fallbackName);
      latestProfileName = fallbackName;
      applyDisplayName();
    }
  });
  node.get('score').once(score => {
    const numericValue = Number(score);
    if (!Number.isFinite(numericValue)) {
      node.get('score').put(0);
      updateProfile(0);
    } else {
      updateProfile(numericValue);
    }
  });
}

function aliasToDisplay(alias) {
  const normalized = typeof alias === 'string' ? alias.trim() : '';
  if (!normalized) return '';
  if (normalized.includes('@')) {
    return normalized.split('@')[0];
  }
  return normalized;
}

function setAliasDisplay(alias) {
  const display = aliasToDisplay(alias);
  if (!display) return;
  aliasName = display;
  applyDisplayName();
}

function migrateLegacyGuestId() {
  const legacyId = localStorage.getItem('userId');
  if (legacyId && !localStorage.getItem('guestId')) {
    localStorage.setItem('guestId', legacyId);
  }
  if (legacyId) {
    localStorage.removeItem('userId');
  }
}

function setupGuestProfile() {
  isSignedIn = false;
  portalStoredName = '';
  aliasName = '';
  migrateLegacyGuestId();
  const guestId = localStorage.getItem('guestId') || (() => {
    const id = `guest_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('guestId', id);
    return id;
  })();
  localStorage.setItem('guest', 'true');

  activeProfile = gun.get('3dvr-guests').get(guestId);
  if (!guestStoredName) {
    guestStoredName = 'Guest';
    localStorage.setItem('guestDisplayName', guestStoredName);
  }
  latestProfileName = '';
  applyDisplayName();
  ensureGuestDefaults(activeProfile);
  watchProfile(activeProfile);
}

function finalizeSignedInProfile() {
  isSignedIn = true;
  portalStoredName = (localStorage.getItem('username') || '').trim();
  localStorage.removeItem('guest');
  localStorage.removeItem('guestDisplayName');
  localStorage.removeItem('guestId');
  guestStoredName = '';
  latestProfileName = '';
  activeProfile = user;
  user.get('alias').once(setAliasDisplay);
  user.get('alias').on(setAliasDisplay);
  watchProfile(activeProfile);
  activeProfile.get('score').once(score => {
    const numericValue = Number(score);
    if (!Number.isFinite(numericValue)) {
      activeProfile.get('score').put(0);
      updateProfile(0);
    } else {
      updateProfile(numericValue);
    }
  });
  applyDisplayName();
}

const signedInAlias = localStorage.getItem('alias');
const signedInPassword = localStorage.getItem('password');

if (isSignedIn && signedInAlias && signedInPassword) {
  setAliasDisplay(signedInAlias);
  if (user.is) {
    finalizeSignedInProfile();
  } else {
    user.auth(signedInAlias, signedInPassword, ack => {
      if (ack && ack.err) {
        alert('Session expired. Please sign in again.');
        localStorage.removeItem('signedIn');
        localStorage.removeItem('alias');
        localStorage.removeItem('username');
        localStorage.removeItem('password');
        setupGuestProfile();
      } else {
        finalizeSignedInProfile();
      }
    });
  }
} else {
  setupGuestProfile();
}

function saveUsername() {
  const nameInput = document.getElementById('name-input');
  const name = nameInput.value.trim();
  if (!name) return;
  latestProfileName = name;
  if (isSignedIn) {
    portalStoredName = name;
    localStorage.setItem('username', portalStoredName);
  } else {
    guestStoredName = name;
    localStorage.setItem('guestDisplayName', guestStoredName);
  }
  applyDisplayName();
  activeProfile.get('username').put(name);
  nameInput.value = '';
}

function addPoints(amount) {
  const bonus = Number(amount);
  if (!Number.isFinite(bonus) || bonus <= 0) return;
  activeProfile.get('score').once(current => {
    const base = normalizeScore(current);
    const updated = base + bonus;
    activeProfile.get('score').put(updated);
  });
}

function resetProfile() {
  if (isSignedIn) {
    try {
      user.leave();
    } catch (err) {
      console.warn('Error signing out user', err);
    }
    localStorage.removeItem('signedIn');
    localStorage.removeItem('alias');
    localStorage.removeItem('username');
    localStorage.removeItem('password');
  }
  localStorage.removeItem('guest');
  localStorage.removeItem('guestId');
  localStorage.removeItem('guestDisplayName');
  localStorage.removeItem('userId');
  window.location.href = 'sign-in.html';
}
</script>

</body>
</html>
