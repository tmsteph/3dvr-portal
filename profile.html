<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3DVR - Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="score.js"></script>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    body {
      background: #e9f0f5;
      color: #222;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #333;
      font-size: 2.4rem;
      margin-top: 0;
    }
    #profile {
      background: #ffffff;
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    #profile p {
      margin: 10px 0;
      font-size: 1.1rem;
    }
    input {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 80%;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      border-radius: 8px;
      background: #66c2b0;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #5ca0d3;
    }
    .progress-bar {
      width: 100%;
      background-color: #eee;
      border-radius: 8px;
      margin-top: 20px;
      overflow: hidden;
    }
    .progress {
      height: 20px;
      background-color: #66c2b0;
      width: 0%;
      transition: width 0.5s ease;
    }
    .teaser {
      margin-top: 20px;
      color: #666;
      font-size: 0.9rem;
    }
    .reset-btn {
      margin-top: 20px;
      font-size: 0.8rem;
      background: none;
      border: none;
      color: #5ca0d3;
      text-decoration: underline;
      cursor: pointer;
    }
    .reset-btn:hover {
      color: #3498db;
    }
  </style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">üè† Portal</a>
  <a href="notes/">üìù Shared Notes</a>
  <a href="tasks.html">‚úÖ Task Board</a>
  <a href="games.html">üéÆ Mini Games</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ GitHub</a>
</div>

<h1>üë§ Profile</h1>

<div id="profile">
  <p><strong>Username:</strong> <span id="username">Guest</span></p>
  <p><strong>Score:</strong> <span id="score">0</span></p>
  <p><strong>Level:</strong> <span id="level">Explorer</span></p>

  <div class="progress-bar">
    <div class="progress" id="progress"></div>
  </div>

  <input type="text" id="name-input" placeholder="Enter new username...">
  <button onclick="saveUsername()">Save Username</button>

  <div class="teaser">
    üìö Unlock Education at 500 Score ‚Ä¢ üõ†Ô∏è Become a Creator at 1500 ‚Ä¢ üöÄ Become a Builder at 3000
  </div>

  <button onclick="addPoints(100)">+100 Points</button>
  <button class="reset-btn" onclick="resetProfile()">Reset Profile</button>
</div>

<script>
const gun = Gun(['https://gun-relay-3dvr.fly.dev/gun']);
const user = gun.user();
const portalRoot = gun.get('3dvr-portal');

if (window.ScoreSystem && typeof window.ScoreSystem.recallUserSession === 'function') {
  window.ScoreSystem.recallUserSession(user);
} else {
  try {
    user.recall({ sessionStorage: true, localStorage: true });
  } catch (err) {
    console.warn('Unable to recall user session', err);
  }
}

let isSignedIn = localStorage.getItem('signedIn') === 'true';
if (!isSignedIn && window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
  window.ScoreSystem.ensureGuestIdentity();
}

const scoreManager = window.ScoreSystem
  ? window.ScoreSystem.getManager({ gun, user, portalRoot })
  : null;

let authState = scoreManager
  ? scoreManager.getState()
  : (window.ScoreSystem && typeof window.ScoreSystem.computeAuthState === 'function'
    ? window.ScoreSystem.computeAuthState()
    : { mode: 'anon' });

isSignedIn = authState.mode === 'user';
let isGuest = authState.mode === 'guest';

let activeProfile = scoreManager ? scoreManager.getNode() : null;
let latestProfileName = '';
let aliasName = '';
let portalStoredName = (localStorage.getItem('username') || '').trim();
let guestStoredName = (localStorage.getItem('guestDisplayName') || '').trim();
let scoreUnsubscribe = null;

const usernameEl = document.getElementById('username');
const scoreEl = document.getElementById('score');
const levelEl = document.getElementById('level');
const progressEl = document.getElementById('progress');

function aliasToDisplay(alias) {
  const normalized = typeof alias === 'string' ? alias.trim() : '';
  if (!normalized) return '';
  return normalized.includes('@') ? normalized.split('@')[0] : normalized;
}

function computeDisplayName() {
  if (latestProfileName) return latestProfileName;
  if (isSignedIn) {
    if (portalStoredName) return portalStoredName;
    if (aliasName) return aliasName;
    return 'Guest';
  }
  if (isGuest) {
    if (guestStoredName) return guestStoredName;
    return aliasName || 'Guest';
  }
  return aliasName || 'Guest';
}

function applyDisplayName() {
  usernameEl.innerText = computeDisplayName();
}

function updateProfile(scoreValue) {
  const safeScore = window.ScoreSystem && typeof window.ScoreSystem.sanitizeScore === 'function'
    ? window.ScoreSystem.sanitizeScore(scoreValue)
    : (() => {
      const numeric = typeof scoreValue === 'number' ? scoreValue : Number(scoreValue);
      if (!Number.isFinite(numeric)) return 0;
      return Math.max(0, Math.round(numeric));
    })();

  scoreEl.innerText = safeScore;

  let level = 'Explorer';
  let progress = (safeScore / 500) * 100;

  if (safeScore >= 3000) {
    level = 'Builder';
    progress = ((safeScore - 3000) / 1000) * 100;
  } else if (safeScore >= 1500) {
    level = 'Creator';
    progress = ((safeScore - 1500) / 1500) * 100;
  } else if (safeScore >= 500) {
    level = 'Apprentice';
    progress = ((safeScore - 500) / 1000) * 100;
  }

  levelEl.innerText = level;
  progressEl.style.width = `${Math.max(0, Math.min(progress, 100))}%`;
}

function handleProfileName(name) {
  const normalized = typeof name === 'string' ? name.trim() : '';
  latestProfileName = normalized;
  if (normalized) {
    if (isSignedIn) {
      portalStoredName = normalized;
      localStorage.setItem('username', portalStoredName);
    } else if (isGuest) {
      guestStoredName = normalized;
      localStorage.setItem('guestDisplayName', guestStoredName);
    }
  }
  applyDisplayName();
}

function ensureGuestProfileNode() {
  if (window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
    const guestId = window.ScoreSystem.ensureGuestIdentity();
    if (!guestStoredName) {
      guestStoredName = 'Guest';
      localStorage.setItem('guestDisplayName', guestStoredName);
    }
    return gun.get('3dvr-guests').get(guestId);
  }

  const legacyId = localStorage.getItem('userId');
  if (legacyId && !localStorage.getItem('guestId')) {
    localStorage.setItem('guestId', legacyId);
  }
  if (legacyId) {
    localStorage.removeItem('userId');
  }

  let guestId = localStorage.getItem('guestId');
  if (!guestId) {
    guestId = `guest_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('guestId', guestId);
  }
  localStorage.setItem('guest', 'true');
  if (!guestStoredName) {
    guestStoredName = 'Guest';
    localStorage.setItem('guestDisplayName', guestStoredName);
  }
  return gun.get('3dvr-guests').get(guestId);
}

function watchUsername(node) {
  if (!node) return;
  node.get('username').on(handleProfileName);
  node.get('username').once(name => {
    const normalized = typeof name === 'string' ? name.trim() : '';
    if (normalized) {
      handleProfileName(normalized);
      return;
    }
    const fallback = isSignedIn
      ? (portalStoredName || aliasName || 'Guest')
      : (guestStoredName || 'Guest');
    node.get('username').put(fallback);
    handleProfileName(fallback);
  });
}

function subscribeToScore() {
  if (!scoreManager) {
    updateProfile(0);
    return;
  }
  if (scoreUnsubscribe) return;
  scoreUnsubscribe = scoreManager.subscribe(updateProfile);
  scoreManager.whenReady().then(value => updateProfile(value));
}

function initializeSignedInProfile() {
  isSignedIn = true;
  isGuest = false;
  localStorage.removeItem('guest');
  localStorage.removeItem('guestId');
  localStorage.removeItem('guestDisplayName');
  guestStoredName = '';
  activeProfile = user;

  if (!window.ScoreSystem || typeof window.ScoreSystem.recallUserSession !== 'function') {
    try {
      user.recall({ sessionStorage: true, localStorage: true });
    } catch (err) {
      console.warn('Unable to recall user session', err);
    }
  } else {
    window.ScoreSystem.recallUserSession(user);
  }

  user.get('alias').on(value => {
    aliasName = aliasToDisplay(value);
    applyDisplayName();
  });

  watchUsername(activeProfile);
  applyDisplayName();
  subscribeToScore();
}

function initializeGuestProfile() {
  isSignedIn = false;
  isGuest = true;
  aliasName = '';
  activeProfile = ensureGuestProfileNode();
  watchUsername(activeProfile);
  applyDisplayName();
  subscribeToScore();
}

const signedInAlias = (localStorage.getItem('alias') || '').trim();
const signedInPassword = localStorage.getItem('password');

if (isSignedIn && signedInAlias && signedInPassword) {
  aliasName = aliasToDisplay(signedInAlias);
  if (user.is) {
    initializeSignedInProfile();
  } else {
    user.auth(signedInAlias, signedInPassword, ack => {
      if (ack && ack.err) {
        alert('Session expired. Please sign in again.');
        localStorage.removeItem('signedIn');
        localStorage.removeItem('alias');
        localStorage.removeItem('username');
        localStorage.removeItem('password');
        initializeGuestProfile();
      } else {
        initializeSignedInProfile();
      }
    });
  }
} else {
  initializeGuestProfile();
}

function saveUsername() {
  const nameInput = document.getElementById('name-input');
  const name = nameInput.value.trim();
  if (!name || !activeProfile) return;

  latestProfileName = name;
  if (isSignedIn) {
    portalStoredName = name;
    localStorage.setItem('username', portalStoredName);
  } else if (isGuest) {
    guestStoredName = name;
    localStorage.setItem('guestDisplayName', guestStoredName);
  }

  applyDisplayName();
  activeProfile.get('username').put(name);
  nameInput.value = '';
}

function addPoints(amount) {
  const bonus = Number(amount);
  if (!Number.isFinite(bonus) || bonus <= 0 || !scoreManager) return;
  scoreManager.increment(bonus);
}

function resetProfile() {
  if (isSignedIn) {
    try {
      user.leave();
    } catch (err) {
      console.warn('Error signing out user', err);
    }
    if (window.ScoreSystem && typeof window.ScoreSystem.resetManager === 'function') {
      window.ScoreSystem.resetManager();
    }
    localStorage.removeItem('signedIn');
    localStorage.removeItem('alias');
    localStorage.removeItem('username');
    localStorage.removeItem('password');
  }
  localStorage.removeItem('guest');
  localStorage.removeItem('guestId');
  localStorage.removeItem('guestDisplayName');
  localStorage.removeItem('userId');
  window.location.href = 'sign-in.html';
}
</script>

</body>
</html>
