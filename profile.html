<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3DVR - Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="gun-init.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="score.js"></script>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    body.profile-page {
      background: var(--page-background);
      color: var(--color-text);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0 1.25rem 2.5rem;
      min-height: 100vh;
    }

    .page-shell {
      max-width: 1080px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin: 1.5rem auto 2rem;
      max-width: 720px;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent-strong);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.8rem;
      border: 1px solid rgba(37, 99, 235, 0.18);
    }

    h1 {
      margin: 0.85rem 0 0.35rem;
      font-size: clamp(2rem, 3vw, 2.6rem);
      color: var(--color-text);
    }

    .lede {
      margin: 0;
      color: var(--color-text-muted);
      font-size: 1.05rem;
      line-height: 1.65;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.25rem;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--surface-border);
      border-radius: var(--radius-lg);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.08);
      padding: 1.4rem;
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 12% 20%, rgba(37, 99, 235, 0.08), transparent 35%),
        radial-gradient(circle at 82% 12%, rgba(37, 99, 235, 0.06), transparent 28%);
      pointer-events: none;
      z-index: 0;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .profile-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .avatar {
      width: 64px;
      height: 64px;
      display: grid;
      place-items: center;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.14), rgba(37, 99, 235, 0.26));
      border: 1px solid rgba(37, 99, 235, 0.18);
      font-size: 1.8rem;
      color: var(--color-text);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .label {
      margin: 0;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-text-muted);
      font-weight: 700;
    }

    .display-name {
      margin: 0.15rem 0 0.25rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
      line-height: 1.2;
    }

    .helper-text {
      margin: 0;
      color: var(--color-text-muted);
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
      margin: 1rem 0;
    }

    .stat {
      padding: 0.9rem 1rem;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px solid var(--surface-border);
    }

    .stat-value {
      margin: 0.2rem 0 0;
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--color-text);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.4rem 0.85rem;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent-strong);
      font-weight: 700;
      border: 1px solid rgba(37, 99, 235, 0.18);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .progress-wrap {
      margin: 1rem 0;
    }

    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
      color: var(--color-text-muted);
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      background-color: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(15, 23, 42, 0.05);
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      height: 16px;
    }

    .progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2563eb, #22c55e);
      transition: width 0.5s ease;
    }

    .unlock-hints {
      margin: 0.5rem 0 1.25rem;
      padding: 0.85rem 1rem;
      border-radius: var(--radius-md);
      background: rgba(37, 99, 235, 0.08);
      color: var(--color-text);
      border: 1px dashed rgba(37, 99, 235, 0.32);
      font-weight: 600;
      line-height: 1.5;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      align-items: center;
    }

    .identity-note {
      margin: 0.75rem 0 0;
      color: var(--color-text-muted);
      line-height: 1.55;
    }

    input {
      padding: 0.75rem 0.9rem;
      border-radius: var(--radius-md);
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: #fff;
      font-size: 1rem;
      width: 100%;
      color: var(--color-text);
    }

    input:focus {
      outline: 2px solid rgba(37, 99, 235, 0.35);
      outline-offset: 2px;
    }

    button {
      padding: 0.8rem 1rem;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      border: 1px solid rgba(37, 99, 235, 0.4);
      font-weight: 700;
      cursor: pointer;
      transition: transform var(--transition-base), box-shadow var(--transition-base), opacity var(--transition-base);
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.3);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 36px rgba(37, 99, 235, 0.36);
    }

    button:active {
      transform: translateY(0);
      opacity: 0.95;
    }

    .ghost {
      background: rgba(15, 23, 42, 0.04);
      color: var(--color-text);
      border-color: rgba(15, 23, 42, 0.08);
      box-shadow: none;
    }

    .ghost:hover {
      background: rgba(15, 23, 42, 0.08);
      box-shadow: none;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
      margin-top: 0.25rem;
    }

    .actions a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.65rem 1rem;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.04);
      color: var(--color-text);
      font-weight: 700;
      border: 1px solid rgba(15, 23, 42, 0.08);
      transition: transform var(--transition-base), box-shadow var(--transition-base);
    }

    .actions a:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
    }

    .admin-card {
      padding: 1.6rem;
      text-align: left;
    }

    .admin-card h2 {
      margin: 0 0 0.35rem;
      font-size: 1.35rem;
      color: var(--color-text);
    }

    .admin-subtitle {
      margin: 0 0 0.75rem;
      color: var(--color-text-muted);
      line-height: 1.55;
    }

    .admin-status {
      margin: 0.25rem 0 0.85rem;
      color: var(--color-text);
      font-weight: 700;
    }

    .admin-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .admin-actions a {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.85rem 1rem;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.04);
      color: var(--color-text);
      font-weight: 700;
      border: 1px solid var(--surface-border);
      transition: transform var(--transition-base), background var(--transition-base), border-color var(--transition-base);
    }

    .admin-actions a:hover {
      transform: translateY(-2px);
      background: rgba(37, 99, 235, 0.08);
      border-color: rgba(37, 99, 235, 0.28);
    }

    .admin-actions a[aria-disabled="true"] {
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
      background: rgba(15, 23, 42, 0.02);
    }

    .admin-score {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px dashed rgba(37, 99, 235, 0.32);
    }

    .admin-create {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: var(--radius-md);
      background: rgba(37, 99, 235, 0.06);
      border: 1px solid rgba(37, 99, 235, 0.2);
      display: grid;
      gap: 0.65rem;
    }

    .admin-create .input-grid {
      display: grid;
      gap: 0.35rem;
    }

    .admin-create .inline-inputs {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
    }

    .admin-score .input-row {
      margin-top: 0.5rem;
    }

    .admin-score button[disabled],
    .admin-score input[disabled] {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .user-search {
      margin-top: 1rem;
      display: grid;
      gap: 0.5rem;
    }

    .user-search input[type="search"] {
      width: 100%;
    }

    .user-results {
      display: grid;
      gap: 0.4rem;
      max-height: 180px;
      overflow-y: auto;
    }

    .user-result {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.65rem 0.75rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--surface-border);
      background: rgba(15, 23, 42, 0.02);
      cursor: pointer;
      transition: transform var(--transition-base), border-color var(--transition-base);
    }

    .user-result:hover {
      transform: translateY(-1px);
      border-color: rgba(37, 99, 235, 0.24);
    }

    .user-result.active {
      border-color: rgba(37, 99, 235, 0.28);
      background: rgba(37, 99, 235, 0.08);
    }

    .user-meta {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .user-meta strong {
      color: var(--color-text);
    }

    .user-meta small {
      color: var(--color-text-muted);
    }

    .user-points {
      font-weight: 800;
      color: var(--accent-strong);
    }

    @media (max-width: 640px) {
      .input-row {
        grid-template-columns: 1fr;
      }

      .actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="profile-page theme-dark">

<div class="top-buttons">
  <a href="index.html">üè† Portal</a>
  <a href="notes/">üìù Shared Notes</a>
  <a href="/tasks/">‚úÖ Task Board</a>
  <a href="games.html">üéÆ Mini Games</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ GitHub</a>
</div>

<main class="page-shell">
  <header class="page-header">
    <div class="eyebrow">Identity & score</div>
    <h1>üë§ Profile</h1>
    <p class="lede">Curate your display name, check your score, and jump into the admin tools that keep the 3DVR portal humming.</p>
  </header>

  <section class="profile-grid">
    <article class="card" id="profile" aria-live="polite">
      <div class="profile-meta">
        <div class="avatar" aria-hidden="true">ü™ê</div>
        <div>
          <p class="label">Display name</p>
          <p class="display-name" id="username">Guest</p>
          <p class="helper-text">Tied to your Gun identity and visible across shared spaces.</p>
        </div>
      </div>

      <div class="stat-row">
        <div class="stat">
          <p class="label">Score</p>
          <p class="stat-value" id="score">0</p>
        </div>
        <div class="stat">
          <p class="label">Level</p>
          <div class="chip" id="level">Explorer</div>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-header">
          <span>Progress to next tier</span>
          <span class="chip">Live sync</span>
        </div>
        <div class="progress-bar" aria-label="Score progress">
          <div class="progress" id="progress"></div>
        </div>
      </div>

      <div class="unlock-hints">
        üìö Education unlocks at 500 ‚Ä¢ üõ†Ô∏è Creator tools at 1500 ‚Ä¢ üöÄ Builder status at 3000
      </div>

      <p class="identity-note">
        Your display name syncs from your signed-in account. Guests will keep a temporary name until they sign in.
      </p>

      <div class="actions">
        <button type="button" class="ghost" onclick="resetScore()">Reset Score</button>
        <a href="sign-in.html">Sign in / Sign up</a>
      </div>
    </article>

    <article class="card admin-card" aria-live="polite">
      <h2><span id="admin-badge">Admin</span> Control</h2>
      <p class="admin-subtitle">Quick links that keep the portal healthy, curated, and in sync for everyone.</p>
      <p class="admin-status" id="admin-status">Sign in to unlock admin shortcuts.</p>
      <div class="admin-actions" id="admin-actions">
        <a href="/admin/" role="button">üõ†Ô∏è Portal Admin</a>
        <a href="/tasks/" role="button">‚úÖ Task Board</a>
        <a href="/gun-explorer/" role="button">üï∏Ô∏è Gun Explorer</a>
        <a href="/notes/" role="button">üìù Shared Notes</a>
      </div>

      <div class="admin-create" aria-live="polite">
        <p class="label">Create coworker accounts</p>
        <p class="helper-text" id="coworker-helper">Add teammates and optionally seed starter points.</p>
        <div class="input-grid">
          <label class="label" for="coworker-name-input">Coworker handle</label>
          <input
            type="text"
            id="coworker-name-input"
            placeholder="e.g., alex or alex@3dvr"
            autocomplete="username"
          >
        </div>
        <div class="input-grid">
          <label class="label" for="coworker-password-input">Temporary password</label>
          <input
            type="password"
            id="coworker-password-input"
            placeholder="Set a password to share"
            autocomplete="new-password"
          >
        </div>
        <div class="input-grid">
          <label class="label" for="coworker-points-input">Starter points</label>
          <div class="inline-inputs">
            <input
              type="number"
              id="coworker-points-input"
              min="0"
              step="50"
              value="0"
              aria-label="Starter points"
            >
            <button type="button" id="coworker-button" onclick="createCoworkerAccount()">Create account</button>
          </div>
        </div>
      </div>

      <div class="admin-score" aria-live="polite">
        <p class="label">Score controls</p>
        <p class="helper-text" id="admin-score-helper">Sign in as an admin to award points.</p>
        <div class="input-row">
          <input type="number" id="admin-score-input" min="1" step="50" aria-label="Points to award" placeholder="Add points (e.g., 250)">
          <button type="button" id="admin-score-button" onclick="awardAdminScore()">Award Score</button>
        </div>
        <div class="input-row" id="admin-deduct-row">
          <input type="number" id="admin-deduct-input" min="1" step="50" aria-label="Points to deduct" placeholder="Deduct points (e.g., 50)">
          <button type="button" id="admin-deduct-button" onclick="deductAdminScore()">Deduct Score</button>
        </div>
        <div class="user-search" id="user-search" aria-live="polite">
          <label class="label" for="user-search-input">Find a user to reward</label>
          <input type="search" id="user-search-input" placeholder="Search by alias or username" aria-label="Search for user" oninput="handleUserSearch(event)">
          <div class="user-results" id="user-results"></div>
        </div>
      </div>
    </article>
  </section>
</main>

<script>
const gun = Gun(window.__GUN_PEERS__ || [
  'wss://relay.3dvr.tech/gun',
  'wss://gun-relay-3dvr.fly.dev/gun'
]);
const user = gun.user();
const portalRoot = gun.get('3dvr-portal');

if (window.ScoreSystem && typeof window.ScoreSystem.recallUserSession === 'function') {
  window.ScoreSystem.recallUserSession(user);
} else {
  try {
    user.recall({ sessionStorage: true, localStorage: true });
  } catch (err) {
    console.warn('Unable to recall user session', err);
  }
}

let storedSignedIn = localStorage.getItem('signedIn') === 'true';
if (!storedSignedIn && user && user.is && user.is.alias) {
  storedSignedIn = true;
  try {
    localStorage.setItem('signedIn', 'true');
    localStorage.setItem('alias', user.is.alias);
  } catch (err) {
    console.warn('Failed to persist signed-in state from session', err);
  }
}
let isSignedIn = storedSignedIn;
if (!isSignedIn && window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
  window.ScoreSystem.ensureGuestIdentity();
}

const scoreManager = window.ScoreSystem
  ? window.ScoreSystem.getManager({ gun, user, portalRoot })
  : null;

const portalAdminsNode = portalRoot.get('admins');

let authState = scoreManager
  ? scoreManager.getState()
  : (window.ScoreSystem && typeof window.ScoreSystem.computeAuthState === 'function'
    ? window.ScoreSystem.computeAuthState()
    : { mode: 'anon' });

isSignedIn = authState.mode === 'user' || storedSignedIn;
let isGuest = authState.mode === 'guest' && !isSignedIn;
let isAdmin = false;

let activeProfile = scoreManager ? scoreManager.getNode() : null;
let latestProfileName = '';
let aliasName = '';
let portalStoredName = (localStorage.getItem('username') || '').trim();
let guestStoredName = (localStorage.getItem('guestDisplayName') || '').trim();
let scoreUnsubscribe = null;

const usernameEl = document.getElementById('username');
const scoreEl = document.getElementById('score');
const levelEl = document.getElementById('level');
const progressEl = document.getElementById('progress');
const adminStatusEl = document.getElementById('admin-status');
const adminActionsEl = document.getElementById('admin-actions');
const adminBadgeEl = document.getElementById('admin-badge');
const adminScoreInput = document.getElementById('admin-score-input');
const adminScoreButton = document.getElementById('admin-score-button');
const adminDeductInput = document.getElementById('admin-deduct-input');
const adminDeductButton = document.getElementById('admin-deduct-button');
const adminScoreHelper = document.getElementById('admin-score-helper');
const coworkerHelper = document.getElementById('coworker-helper');
const coworkerNameInput = document.getElementById('coworker-name-input');
const coworkerPasswordInput = document.getElementById('coworker-password-input');
const coworkerPointsInput = document.getElementById('coworker-points-input');
const coworkerButton = document.getElementById('coworker-button');
const userSearchEl = document.getElementById('user-search');
const userSearchInput = document.getElementById('user-search-input');
const userResultsEl = document.getElementById('user-results');

const userIndexNode = portalRoot.get('userIndex');
const userStatsNode = portalRoot.get('userStats');
// adminScoreGrants keeps a per-admin log of recent awards for rate limiting and auditability.
const adminGrantsNode = portalRoot.get('adminScoreGrants');
const ADMIN_RATE_LIMIT = {
  windowMs: 15 * 60 * 1000,
  maxGrants: 5,
  maxPointsPerGrant: 10000
};

const knownUsers = new Map();
const knownStats = new Map();
let grantHistory = [];
let selectedUserAlias = '';
let selectedUserName = '';

function aliasToDisplay(alias) {
  const normalized = typeof alias === 'string' ? alias.trim() : '';
  if (!normalized) return '';
  return normalized.includes('@') ? normalized.split('@')[0] : normalized;
}

function normalizeAliasInput(raw) {
  const trimmed = (raw || '').trim().toLowerCase();
  if (!trimmed) return '';
  const cleaned = trimmed
    .replace(/[^a-z0-9.@_-]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-+|-+$/g, '');
  if (!cleaned) return '';
  if (cleaned.includes('@')) return cleaned;
  return `${cleaned}@3dvr`;
}

function sanitizeScoreValue(scoreValue) {
  if (window.ScoreSystem && typeof window.ScoreSystem.sanitizeScore === 'function') {
    return window.ScoreSystem.sanitizeScore(scoreValue);
  }
  const numeric = typeof scoreValue === 'number' ? scoreValue : Number(scoreValue);
  if (!Number.isFinite(numeric)) return 0;
  return Math.max(0, Math.round(numeric));
}

function setCoworkerControlsDisabled(disabled) {
  const inputs = [coworkerNameInput, coworkerPasswordInput, coworkerPointsInput, coworkerButton];
  inputs.forEach(input => {
    if (!input) return;
    if (disabled) {
      input.setAttribute('disabled', 'true');
    } else {
      input.removeAttribute('disabled');
    }
  });
}

function upsertUserDirectory(alias, username) {
  return new Promise(resolve => {
    const recordNode = userIndexNode.get(alias);
    recordNode.once(existing => {
      const createdAt = existing && existing.createdAt ? existing.createdAt : Date.now();
      const lastLogin = existing && existing.lastLogin ? existing.lastLogin : 0;
      recordNode.put({
        username,
        alias,
        createdAt,
        lastLogin
      }, () => resolve({ createdAt, lastLogin }));
    });
  });
}

function ensureKnownUser(alias, username, metadata = {}) {
  knownUsers.set(alias, {
    alias,
    username: username || aliasToDisplay(alias),
    createdAt: metadata.createdAt || 0,
    lastLogin: metadata.lastLogin || 0
  });
  renderUserResults(userSearchInput ? userSearchInput.value.trim().toLowerCase() : '');
}

function computeDisplayName() {
  if (latestProfileName) return latestProfileName;
  if (window.ScoreSystem && typeof window.ScoreSystem.resolveDisplayName === 'function') {
    const resolved = window.ScoreSystem.resolveDisplayName({
      user,
      authState: {
        mode: isSignedIn ? 'user' : (isGuest ? 'guest' : 'anon'),
        alias: aliasName,
        username: portalStoredName,
        guestDisplayName: guestStoredName
      }
    });
    if (resolved) return resolved;
  }
  return isSignedIn ? 'Account' : 'Guest';
}

function applyDisplayName() {
  usernameEl.innerText = computeDisplayName();
}

function updateAdminCard() {
  if (!adminStatusEl || !adminActionsEl || !adminBadgeEl) return;

  if (isSignedIn && isAdmin) {
    adminBadgeEl.innerText = 'Admin (signed in)';
    adminStatusEl.innerText = 'You have access to curation tools and shared system controls.';
    Array.from(adminActionsEl.querySelectorAll('a')).forEach(link => {
      link.setAttribute('aria-disabled', 'false');
    });
    setCoworkerControlsDisabled(false);
    if (coworkerHelper) {
      coworkerHelper.innerText = 'Create portal accounts for teammates without leaving your admin session.';
    }
    if (adminScoreInput && adminScoreButton) {
      adminScoreInput.removeAttribute('disabled');
      adminScoreButton.removeAttribute('disabled');
    }
    if (adminDeductInput && adminDeductButton) {
      adminDeductInput.removeAttribute('disabled');
      adminDeductButton.removeAttribute('disabled');
    }
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Award or deduct points after confirming progress.';
    }
    if (userSearchEl) {
      userSearchEl.style.display = 'grid';
    }
  } else {
    adminBadgeEl.innerText = isSignedIn ? 'Admin (restricted)' : 'Admin (guest view)';
    adminStatusEl.innerText = isSignedIn
      ? 'Only admins can use these curation shortcuts.'
      : 'Sign in to unlock admin shortcuts and synced changes.';
    Array.from(adminActionsEl.querySelectorAll('a')).forEach(link => {
      link.setAttribute('aria-disabled', 'true');
    });
    setCoworkerControlsDisabled(true);
    if (coworkerHelper) {
      coworkerHelper.innerText = isSignedIn
        ? 'Only admins can add coworkers or seed starter points.'
        : 'Sign in to add coworkers or seed their starter points.';
    }
    if (adminScoreInput && adminScoreButton) {
      adminScoreInput.setAttribute('disabled', 'true');
      adminScoreButton.setAttribute('disabled', 'true');
    }
    if (adminDeductInput && adminDeductButton) {
      adminDeductInput.setAttribute('disabled', 'true');
      adminDeductButton.setAttribute('disabled', 'true');
    }
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Only admins can adjust score.';
    }
    if (userSearchEl) {
      userSearchEl.style.display = 'none';
    }
  }
}

function subscribeToAdminStatus() {
  const alias = (localStorage.getItem('alias') || '').trim();
  if (!alias) {
    isAdmin = false;
    updateAdminCard();
    return;
  }

  try {
    portalAdminsNode.get(alias).on(record => {
      isAdmin = Boolean(record);
      updateAdminCard();
    });
  } catch (err) {
    console.warn('Failed to subscribe to admin status', err);
    isAdmin = false;
    updateAdminCard();
  }
}

function updateProfile(scoreValue) {
  const safeScore = sanitizeScoreValue(scoreValue);

  scoreEl.innerText = safeScore;

  let level = 'Explorer';
  let progress = (safeScore / 500) * 100;

  if (safeScore >= 3000) {
    level = 'Builder';
    progress = ((safeScore - 3000) / 1000) * 100;
  } else if (safeScore >= 1500) {
    level = 'Creator';
    progress = ((safeScore - 1500) / 1500) * 100;
  } else if (safeScore >= 500) {
    level = 'Apprentice';
    progress = ((safeScore - 500) / 1000) * 100;
  }

  levelEl.innerText = level;
  progressEl.style.width = `${Math.max(0, Math.min(progress, 100))}%`;
}

async function createCoworkerAccount() {
  if (!coworkerHelper) return;
  if (!isSignedIn) {
    coworkerHelper.innerText = 'Sign in as an admin to create teammate accounts.';
    return;
  }

  const alias = normalizeAliasInput(coworkerNameInput ? coworkerNameInput.value : '');
  if (!alias) {
    coworkerHelper.innerText = 'Enter a coworker handle to create their account.';
    return;
  }

  const password = coworkerPasswordInput ? coworkerPasswordInput.value.trim() : '';
  if (!password || password.length < 6) {
    coworkerHelper.innerText = 'Use a password with at least 6 characters to share with your teammate.';
    return;
  }

  const starterPoints = sanitizeScoreValue(coworkerPointsInput ? coworkerPointsInput.value : 0);

  if (!gun || gun.__isGunStub) {
    coworkerHelper.innerText = 'Gun is offline. Try again once peers reconnect.';
    return;
  }

  if (coworkerButton) {
    coworkerButton.setAttribute('disabled', 'true');
  }
  coworkerHelper.innerText = 'Creating account...';

  const creationUser = typeof gun.user === 'function' ? gun.user() : null;
  if (!creationUser || typeof creationUser.create !== 'function') {
    coworkerHelper.innerText = 'Gun user instance is unavailable. Refresh and try again.';
    if (coworkerButton) {
      coworkerButton.removeAttribute('disabled');
    }
    return;
  }

  let creationAck = null;
  await new Promise(resolve => {
    try {
      creationUser.create(alias, password, ack => {
        creationAck = ack;
        resolve();
      });
    } catch (err) {
      creationAck = { err: err && err.message ? err.message : 'account-creation-failed' };
      resolve();
    }
  });

  const alreadyExists = creationAck && creationAck.err && String(creationAck.err).includes('User already created');
  if (creationAck && creationAck.err && !alreadyExists) {
    coworkerHelper.innerText = `Could not create account: ${creationAck.err}`;
    if (coworkerButton) {
      coworkerButton.removeAttribute('disabled');
    }
    return;
  }

  const username = aliasToDisplay(alias);
  ensureKnownUser(alias, username);
  upsertUserDirectory(alias, username).then(meta => ensureKnownUser(alias, username, meta));

  if (!knownStats.has(alias)) {
    knownStats.set(alias, { alias, username, points: 0 });
  }

  if (starterPoints > 0) {
    coworkerHelper.innerText = alreadyExists
      ? `Account exists for ${username}. Awarding ${starterPoints} starter points now.`
      : `Account ready for ${username}. Awarding ${starterPoints} starter points now.`;
    awardTargetUser(alias, starterPoints);
  } else {
    coworkerHelper.innerText = alreadyExists
      ? `Account exists for ${username}. You can award points as they contribute.`
      : `Account ready for ${username}. Share their login so they can start earning points.`;
  }

  if (coworkerButton) {
    coworkerButton.removeAttribute('disabled');
  }
}

function handleProfileName(name) {
  const normalized = typeof name === 'string' ? name.trim() : '';
  latestProfileName = normalized;
  if (normalized) {
    if (isSignedIn) {
      portalStoredName = normalized;
      localStorage.setItem('username', portalStoredName);
    } else if (isGuest) {
      guestStoredName = normalized;
      localStorage.setItem('guestDisplayName', guestStoredName);
    }
  }
  applyDisplayName();
}

function ensureGuestProfileNode() {
  if (window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
    const guestId = window.ScoreSystem.ensureGuestIdentity();
    if (!guestStoredName) {
      guestStoredName = 'Guest';
      localStorage.setItem('guestDisplayName', guestStoredName);
    }
    return gun.get('3dvr-guests').get(guestId);
  }

  const legacyId = localStorage.getItem('userId');
  if (legacyId && !localStorage.getItem('guestId')) {
    localStorage.setItem('guestId', legacyId);
  }
  if (legacyId) {
    localStorage.removeItem('userId');
  }

  let guestId = localStorage.getItem('guestId');
  if (!guestId) {
    guestId = `guest_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('guestId', guestId);
  }
  localStorage.setItem('guest', 'true');
  if (!guestStoredName) {
    guestStoredName = 'Guest';
    localStorage.setItem('guestDisplayName', guestStoredName);
  }
  return gun.get('3dvr-guests').get(guestId);
}

function watchUsername(node) {
  if (!node) return;
  node.get('username').on(handleProfileName);
  node.get('username').once(name => {
    const normalized = typeof name === 'string' ? name.trim() : '';
    if (normalized) {
      handleProfileName(normalized);
      return;
    }
    const fallback = window.ScoreSystem && typeof window.ScoreSystem.resolveDisplayName === 'function'
      ? window.ScoreSystem.resolveDisplayName({
        user,
        authState: {
          mode: isSignedIn ? 'user' : 'guest',
          alias: aliasName,
          username: portalStoredName,
          guestDisplayName: guestStoredName
        },
        signedInFallback: '',
        guestFallback: 'Guest'
      })
      : '';
    if (!fallback) return;
    node.get('username').put(fallback);
    handleProfileName(fallback);
  });
}

function subscribeToScore() {
  if (!scoreManager) {
    updateProfile(0);
    return;
  }
  if (scoreUnsubscribe) return;
  scoreUnsubscribe = scoreManager.subscribe(updateProfile);
  scoreManager.whenReady().then(value => updateProfile(value));
}

function initializeSignedInProfile() {
  isSignedIn = true;
  isGuest = false;
  latestProfileName = '';
  portalStoredName = (localStorage.getItem('username') || '').trim();
  aliasName = aliasToDisplay(localStorage.getItem('alias'));
  if (!aliasName && user && user.is && user.is.alias) {
    aliasName = aliasToDisplay(user.is.alias);
  }
  if (portalStoredName.toLowerCase() === 'guest' && aliasName) {
    portalStoredName = '';
  }
  localStorage.removeItem('guest');
  localStorage.removeItem('guestId');
  localStorage.removeItem('guestDisplayName');
  guestStoredName = '';
  activeProfile = user;

  if (!window.ScoreSystem || typeof window.ScoreSystem.recallUserSession !== 'function') {
    try {
      user.recall({ sessionStorage: true, localStorage: true });
    } catch (err) {
      console.warn('Unable to recall user session', err);
    }
  } else {
    window.ScoreSystem.recallUserSession(user);
  }

  user.get('alias').on(value => {
    aliasName = aliasToDisplay(value);
    applyDisplayName();
  });

  watchUsername(activeProfile);
  applyDisplayName();
  subscribeToAdminStatus();
  subscribeToScore();
  subscribeToUserDirectory();
  subscribeToGrantLog();
  renderUserResults();
  updateAdminCard();
}

function initializeGuestProfile() {
  isSignedIn = false;
  isGuest = true;
  latestProfileName = '';
  aliasName = '';
  selectedUserAlias = '';
  activeProfile = ensureGuestProfileNode();
  isAdmin = false;
  watchUsername(activeProfile);
  applyDisplayName();
  subscribeToScore();
  updateAdminCard();
}

const signedInAlias = (localStorage.getItem('alias') || '').trim();
const signedInPassword = localStorage.getItem('password');

if (isSignedIn) {
  aliasName = aliasToDisplay(signedInAlias);
  if (user.is) {
    initializeSignedInProfile();
  } else if (signedInAlias && signedInPassword) {
    user.auth(signedInAlias, signedInPassword, ack => {
      if (ack && ack.err) {
        alert('Session expired. Please sign in again.');
        localStorage.removeItem('signedIn');
        localStorage.removeItem('alias');
        localStorage.removeItem('username');
        localStorage.removeItem('password');
        initializeGuestProfile();
      } else {
        initializeSignedInProfile();
      }
    });
  } else {
    initializeSignedInProfile();
  }
} else {
  initializeGuestProfile();
}

function awardAdminScore() {
  if (!isSignedIn || !isAdmin) {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Only admins can award score.';
    }
    return;
  }

  if (!scoreManager || typeof scoreManager.increment !== 'function') {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Score system unavailable. Please try again later.';
    }
    return;
  }

  if (!adminScoreInput) {
    return;
  }

  const bonus = Number(adminScoreInput.value);
  if (!Number.isFinite(bonus) || bonus <= 0) {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Enter a positive number of points to award.';
    }
    return;
  }

  const normalized = Math.round(bonus);
  if (selectedUserAlias) {
    awardTargetUser(selectedUserAlias, normalized);
  } else {
    scoreManager.increment(normalized);
    adminScoreInput.value = '';
    if (adminScoreHelper) {
      adminScoreHelper.innerText = `Awarded ${normalized} points to this profile.`;
    }
  }
}

function deductAdminScore() {
  if (!isSignedIn || !isAdmin) {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Only admins can deduct score.';
    }
    return;
  }

  if (!scoreManager || typeof scoreManager.decrement !== 'function') {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Score system unavailable. Please try again later.';
    }
    return;
  }

  if (!adminDeductInput) {
    return;
  }

  const penalty = Number(adminDeductInput.value);
  if (!Number.isFinite(penalty) || penalty <= 0) {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Enter a positive number of points to deduct.';
    }
    return;
  }

  const normalized = Math.round(penalty);
  if (selectedUserAlias) {
    deductTargetUser(selectedUserAlias, normalized);
  } else {
    scoreManager.decrement(normalized);
    adminDeductInput.value = '';
    if (adminScoreHelper) {
      adminScoreHelper.innerText = `Deducted ${normalized} points from this profile.`;
    }
  }
}

function handleUserSearch(event) {
  const term = typeof event?.target?.value === 'string' ? event.target.value.trim().toLowerCase() : '';
  renderUserResults(term);
}

function renderUserResults(term = '') {
  if (!userResultsEl) return;

  const entries = Array.from(knownUsers.values()).map(profile => {
    const stats = knownStats.get(profile.alias) || {};
    return {
      ...profile,
      points: sanitizeScoreValue(stats.points || 0),
      lastUpdated: stats.lastUpdated
    };
  });

  const filtered = term
    ? entries.filter(item => item.alias.toLowerCase().includes(term) || (item.username || '').toLowerCase().includes(term))
    : entries;

  filtered.sort((a, b) => b.points - a.points);

  if (!filtered.length) {
    userResultsEl.innerHTML = '<p class="helper-text">No users found. Keep typing to search.</p>';
    return;
  }

  const topResults = filtered.slice(0, 8);
  userResultsEl.innerHTML = topResults.map(user => {
    const activeClass = user.alias === selectedUserAlias ? 'user-result active' : 'user-result';
    const safeUsername = user.username || user.alias;
    const lastUpdated = user.lastUpdated ? new Date(user.lastUpdated).toLocaleString() : 'No recent activity';
    return `
      <button type="button" class="${activeClass}" onclick="selectUser('${user.alias.replace(/'/g, "&#39;")}')">
        <span class="user-meta">
          <strong>${safeUsername}</strong>
          <small>${user.alias} ‚Ä¢ ${lastUpdated}</small>
        </span>
        <span class="user-points">${user.points} pts</span>
      </button>
    `;
  }).join('');
}

function selectUser(alias) {
  const record = knownUsers.get(alias);
  const stats = knownStats.get(alias) || {};
  selectedUserAlias = alias;
  selectedUserName = record?.username || alias;
  renderUserResults(userSearchInput ? userSearchInput.value.trim().toLowerCase() : '');

  if (adminScoreHelper) {
    const points = sanitizeScoreValue(stats.points || 0);
    adminScoreHelper.innerText = `Ready to award ${selectedUserName} (${alias}) who currently has ${points} points.`;
  }
}

function subscribeToUserDirectory() {
  // Admin grant tool relies on portal user directory to find recipients.
  // userIndex stores per-alias metadata and userStats tracks published points
  // so we can target their portal stat node, which syncs back to their profile score.
  try {
    userIndexNode.map().on((data, key) => {
      if (!key) return;
      if (!data) {
        knownUsers.delete(key);
      } else {
        knownUsers.set(key, {
          alias: key,
          username: (data.username || '').trim() || key.replace('@3dvr', ''),
          createdAt: data.createdAt || 0,
          lastLogin: data.lastLogin || 0
        });
      }
      renderUserResults(userSearchInput ? userSearchInput.value.trim().toLowerCase() : '');
    });

    userStatsNode.map().on((data, key) => {
      if (!key) return;
      if (!data) {
        knownStats.delete(key);
      } else {
        knownStats.set(key, { ...data });
        if (!knownUsers.has(key)) {
          const username = (data.username || '').trim() || key.replace('@3dvr', '');
          const lastLogin = data.lastUpdated || 0;
          ensureKnownUser(key, username, { lastLogin });
        }
      }
      renderUserResults(userSearchInput ? userSearchInput.value.trim().toLowerCase() : '');
    });
  } catch (err) {
    console.warn('Failed to subscribe to user directory', err);
  }
}

function subscribeToGrantLog() {
  const adminAlias = (localStorage.getItem('alias') || '').trim();
  if (!adminAlias) return;
  try {
    adminGrantsNode.get(adminAlias).map().on((entry, key) => {
      if (!key) return;
      if (!entry) {
        grantHistory = grantHistory.filter(item => item.key !== key);
      } else {
        grantHistory = grantHistory.filter(item => item.key !== key);
        grantHistory.push({
          key,
          at: entry.at || Number(key),
          amount: Number(entry.amount) || 0,
          targetAlias: entry.targetAlias || ''
        });
      }
      grantHistory.sort((a, b) => b.at - a.at);
    });
  } catch (err) {
    console.warn('Failed to subscribe to grant log', err);
  }
}

function isRateLimited(amount) {
  const now = Date.now();
  const recent = grantHistory.filter(item => now - item.at <= ADMIN_RATE_LIMIT.windowMs);
  if (recent.length >= ADMIN_RATE_LIMIT.maxGrants) {
    const minutes = Math.ceil(ADMIN_RATE_LIMIT.windowMs / 60000);
    adminScoreHelper.innerText = `Rate limit: max ${ADMIN_RATE_LIMIT.maxGrants} grants every ${minutes} minutes.`;
    return true;
  }
  if (amount > ADMIN_RATE_LIMIT.maxPointsPerGrant) {
    adminScoreHelper.innerText = `Keep awards under ${ADMIN_RATE_LIMIT.maxPointsPerGrant} points at a time.`;
    return true;
  }
  return false;
}

function awardTargetUser(alias, amount) {
  const adminAlias = (localStorage.getItem('alias') || '').trim();
  if (!adminAlias) {
    adminScoreHelper.innerText = 'Sign in as an admin to grant points to other users.';
    return;
  }
  const recipient = knownUsers.get(alias);
  const currentStats = knownStats.get(alias) || {};
  const currentPoints = sanitizeScoreValue(currentStats.points || 0);

  if (isRateLimited(amount)) {
    return;
  }

  const updatedPoints = sanitizeScoreValue(currentPoints + amount);
  const payload = {
    alias,
    username: (recipient?.username || '').trim() || alias,
    points: updatedPoints,
    lastUpdated: Date.now(),
    lastGrantedBy: adminAlias
  };

  // Persist award to portal stats so the recipient's profile syncs the change and writes it back to their user node.
  userStatsNode.get(alias).put(payload, ack => {
    if (ack && ack.err) {
      console.warn('Failed to grant points to user', ack.err);
      if (adminScoreHelper) {
        adminScoreHelper.innerText = 'Could not save award. Try again in a moment.';
      }
      return;
    }

    const logEntry = { at: Date.now(), amount, targetAlias: alias };
    adminGrantsNode.get(adminAlias).get(String(logEntry.at)).put(logEntry);

    adminScoreInput.value = '';
    if (adminScoreHelper) {
    adminScoreHelper.innerText = `Awarded ${amount} points to ${payload.username}. New total: ${updatedPoints}.`;
    }
  });
}

function deductTargetUser(alias, amount) {
  const adminAlias = (localStorage.getItem('alias') || '').trim();
  if (!adminAlias) {
    adminScoreHelper.innerText = 'Sign in as an admin to grant points to other users.';
    return;
  }

  const recipient = knownUsers.get(alias);
  const currentStats = knownStats.get(alias) || {};
  const currentPoints = sanitizeScoreValue(currentStats.points || 0);

  const updatedPoints = Math.max(0, currentPoints - amount);
  const payload = {
    alias,
    username: (recipient?.username || '').trim() || alias,
    points: updatedPoints,
    lastUpdated: Date.now(),
    lastGrantedBy: adminAlias
  };

  userStatsNode.get(alias).put(payload, ack => {
    if (ack && ack.err) {
      console.warn('Failed to deduct points from user', ack.err);
      if (adminScoreHelper) {
        adminScoreHelper.innerText = 'Could not save deduction. Try again in a moment.';
      }
      return;
    }

    const logEntry = { at: Date.now(), amount: -amount, targetAlias: alias };
    adminGrantsNode.get(adminAlias).get(String(logEntry.at)).put(logEntry);

    adminDeductInput.value = '';
    if (adminScoreHelper) {
      adminScoreHelper.innerText = `Deducted ${amount} points from ${payload.username}. New total: ${updatedPoints}.`;
    }
  });
}

function resetScore() {
  updateProfile(0);

  if (!scoreManager || typeof scoreManager.set !== 'function') {
    return;
  }

  const performReset = () => {
    scoreManager.set(0);
  };

  if (typeof scoreManager.whenReady === 'function' && !scoreManager.ready) {
    scoreManager.whenReady().then(performReset);
    return;
  }

  performReset();
}
</script>

</body>
</html>
