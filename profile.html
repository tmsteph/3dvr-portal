<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3DVR - Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="gun-init.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="score.js"></script>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    body.profile-page {
      background: var(--page-background);
      color: var(--color-text);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0 1.25rem 2.5rem;
      min-height: 100vh;
    }

    .page-shell {
      max-width: 1080px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin: 1.5rem auto 2rem;
      max-width: 720px;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent-strong);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.8rem;
      border: 1px solid rgba(37, 99, 235, 0.18);
    }

    h1 {
      margin: 0.85rem 0 0.35rem;
      font-size: clamp(2rem, 3vw, 2.6rem);
      color: var(--color-text);
    }

    .lede {
      margin: 0;
      color: var(--color-text-muted);
      font-size: 1.05rem;
      line-height: 1.65;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.25rem;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--surface-border);
      border-radius: var(--radius-lg);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.08);
      padding: 1.4rem;
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 12% 20%, rgba(37, 99, 235, 0.08), transparent 35%),
        radial-gradient(circle at 82% 12%, rgba(37, 99, 235, 0.06), transparent 28%);
      pointer-events: none;
      z-index: 0;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .profile-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .avatar {
      width: 64px;
      height: 64px;
      display: grid;
      place-items: center;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.14), rgba(37, 99, 235, 0.26));
      border: 1px solid rgba(37, 99, 235, 0.18);
      font-size: 1.8rem;
      color: var(--color-text);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .label {
      margin: 0;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-text-muted);
      font-weight: 700;
    }

    .display-name {
      margin: 0.15rem 0 0.25rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
      line-height: 1.2;
    }

    .helper-text {
      margin: 0;
      color: var(--color-text-muted);
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
      margin: 1rem 0;
    }

    .stat {
      padding: 0.9rem 1rem;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px solid var(--surface-border);
    }

    .stat-value {
      margin: 0.2rem 0 0;
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--color-text);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.4rem 0.85rem;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent-strong);
      font-weight: 700;
      border: 1px solid rgba(37, 99, 235, 0.18);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .progress-wrap {
      margin: 1rem 0;
    }

    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
      color: var(--color-text-muted);
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      background-color: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(15, 23, 42, 0.05);
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      height: 16px;
    }

    .progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2563eb, #22c55e);
      transition: width 0.5s ease;
    }

    .unlock-hints {
      margin: 0.5rem 0 1.25rem;
      padding: 0.85rem 1rem;
      border-radius: var(--radius-md);
      background: rgba(37, 99, 235, 0.08);
      color: var(--color-text);
      border: 1px dashed rgba(37, 99, 235, 0.32);
      font-weight: 600;
      line-height: 1.5;
    }

    .name-form {
      display: grid;
      gap: 0.55rem;
      margin-top: 0.5rem;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      align-items: center;
    }

    input {
      padding: 0.75rem 0.9rem;
      border-radius: var(--radius-md);
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: #fff;
      font-size: 1rem;
      width: 100%;
      color: var(--color-text);
    }

    input:focus {
      outline: 2px solid rgba(37, 99, 235, 0.35);
      outline-offset: 2px;
    }

    button {
      padding: 0.8rem 1rem;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      border: 1px solid rgba(37, 99, 235, 0.4);
      font-weight: 700;
      cursor: pointer;
      transition: transform var(--transition-base), box-shadow var(--transition-base), opacity var(--transition-base);
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.3);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 36px rgba(37, 99, 235, 0.36);
    }

    button:active {
      transform: translateY(0);
      opacity: 0.95;
    }

    .ghost {
      background: rgba(15, 23, 42, 0.04);
      color: var(--color-text);
      border-color: rgba(15, 23, 42, 0.08);
      box-shadow: none;
    }

    .ghost:hover {
      background: rgba(15, 23, 42, 0.08);
      box-shadow: none;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
      margin-top: 0.25rem;
    }

    .admin-card {
      padding: 1.6rem;
      text-align: left;
    }

    .admin-card h2 {
      margin: 0 0 0.35rem;
      font-size: 1.35rem;
      color: var(--color-text);
    }

    .admin-subtitle {
      margin: 0 0 0.75rem;
      color: var(--color-text-muted);
      line-height: 1.55;
    }

    .admin-status {
      margin: 0.25rem 0 0.85rem;
      color: var(--color-text);
      font-weight: 700;
    }

    .admin-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .admin-actions a {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.85rem 1rem;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.04);
      color: var(--color-text);
      font-weight: 700;
      border: 1px solid var(--surface-border);
      transition: transform var(--transition-base), background var(--transition-base), border-color var(--transition-base);
    }

    .admin-actions a:hover {
      transform: translateY(-2px);
      background: rgba(37, 99, 235, 0.08);
      border-color: rgba(37, 99, 235, 0.28);
    }

    .admin-actions a[aria-disabled="true"] {
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
      background: rgba(15, 23, 42, 0.02);
    }

    .admin-score {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px dashed rgba(37, 99, 235, 0.32);
    }

    .admin-score .input-row {
      margin-top: 0.5rem;
    }

    .admin-score button[disabled],
    .admin-score input[disabled] {
      cursor: not-allowed;
      opacity: 0.6;
    }

    @media (max-width: 640px) {
      .input-row {
        grid-template-columns: 1fr;
      }

      .actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="profile-page theme-dark">

<div class="top-buttons">
  <a href="index.html">üè† Portal</a>
  <a href="notes/">üìù Shared Notes</a>
  <a href="/tasks/">‚úÖ Task Board</a>
  <a href="games.html">üéÆ Mini Games</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ GitHub</a>
</div>

<main class="page-shell">
  <header class="page-header">
    <div class="eyebrow">Identity & score</div>
    <h1>üë§ Profile</h1>
    <p class="lede">Curate your display name, check your score, and jump into the admin tools that keep the 3DVR portal humming.</p>
  </header>

  <section class="profile-grid">
    <article class="card" id="profile" aria-live="polite">
      <div class="profile-meta">
        <div class="avatar" aria-hidden="true">ü™ê</div>
        <div>
          <p class="label">Display name</p>
          <p class="display-name" id="username">Guest</p>
          <p class="helper-text">Tied to your Gun identity and visible across shared spaces.</p>
        </div>
      </div>

      <div class="stat-row">
        <div class="stat">
          <p class="label">Score</p>
          <p class="stat-value" id="score">0</p>
        </div>
        <div class="stat">
          <p class="label">Level</p>
          <div class="chip" id="level">Explorer</div>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-header">
          <span>Progress to next tier</span>
          <span class="chip">Live sync</span>
        </div>
        <div class="progress-bar" aria-label="Score progress">
          <div class="progress" id="progress"></div>
        </div>
      </div>

      <div class="unlock-hints">
        üìö Education unlocks at 500 ‚Ä¢ üõ†Ô∏è Creator tools at 1500 ‚Ä¢ üöÄ Builder status at 3000
      </div>

      <form class="name-form" onsubmit="event.preventDefault(); saveUsername();">
        <label class="label" for="name-input">Update display name</label>
        <div class="input-row">
          <input type="text" id="name-input" placeholder="Enter new username...">
          <button type="submit">Save Username</button>
        </div>
      </form>

      <div class="actions">
        <button type="button" class="ghost" onclick="resetScore()">Reset Score</button>
      </div>
    </article>

    <article class="card admin-card" aria-live="polite">
      <h2><span id="admin-badge">Admin</span> Control</h2>
      <p class="admin-subtitle">Quick links that keep the portal healthy, curated, and in sync for everyone.</p>
      <p class="admin-status" id="admin-status">Sign in to unlock admin shortcuts.</p>
      <div class="admin-actions" id="admin-actions">
        <a href="/admin/" role="button">üõ†Ô∏è Portal Admin</a>
        <a href="/tasks/" role="button">‚úÖ Task Board</a>
        <a href="/gun-explorer/" role="button">üï∏Ô∏è Gun Explorer</a>
        <a href="/notes/" role="button">üìù Shared Notes</a>
      </div>

      <div class="admin-score" aria-live="polite">
        <p class="label">Score controls</p>
        <p class="helper-text" id="admin-score-helper">Sign in as an admin to award points.</p>
        <div class="input-row">
          <input type="number" id="admin-score-input" min="1" step="50" aria-label="Points to award" placeholder="Add points (e.g., 250)">
          <button type="button" id="admin-score-button" onclick="awardAdminScore()">Award Score</button>
        </div>
      </div>
    </article>
  </section>
</main>

<script>
const gun = Gun(window.__GUN_PEERS__ || [
  'wss://relay.3dvr.tech/gun',
  'wss://gun-relay-3dvr.fly.dev/gun'
]);
const user = gun.user();
const portalRoot = gun.get('3dvr-portal');

if (window.ScoreSystem && typeof window.ScoreSystem.recallUserSession === 'function') {
  window.ScoreSystem.recallUserSession(user);
} else {
  try {
    user.recall({ sessionStorage: true, localStorage: true });
  } catch (err) {
    console.warn('Unable to recall user session', err);
  }
}

let isSignedIn = localStorage.getItem('signedIn') === 'true';
if (!isSignedIn && window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
  window.ScoreSystem.ensureGuestIdentity();
}

const scoreManager = window.ScoreSystem
  ? window.ScoreSystem.getManager({ gun, user, portalRoot })
  : null;

let authState = scoreManager
  ? scoreManager.getState()
  : (window.ScoreSystem && typeof window.ScoreSystem.computeAuthState === 'function'
    ? window.ScoreSystem.computeAuthState()
    : { mode: 'anon' });

isSignedIn = authState.mode === 'user';
let isGuest = authState.mode === 'guest';

let activeProfile = scoreManager ? scoreManager.getNode() : null;
let latestProfileName = '';
let aliasName = '';
let portalStoredName = (localStorage.getItem('username') || '').trim();
let guestStoredName = (localStorage.getItem('guestDisplayName') || '').trim();
let scoreUnsubscribe = null;

const usernameEl = document.getElementById('username');
const scoreEl = document.getElementById('score');
const levelEl = document.getElementById('level');
const progressEl = document.getElementById('progress');
const adminStatusEl = document.getElementById('admin-status');
const adminActionsEl = document.getElementById('admin-actions');
const adminBadgeEl = document.getElementById('admin-badge');
const adminScoreInput = document.getElementById('admin-score-input');
const adminScoreButton = document.getElementById('admin-score-button');
const adminScoreHelper = document.getElementById('admin-score-helper');

function aliasToDisplay(alias) {
  const normalized = typeof alias === 'string' ? alias.trim() : '';
  if (!normalized) return '';
  return normalized.includes('@') ? normalized.split('@')[0] : normalized;
}

function computeDisplayName() {
  if (latestProfileName) return latestProfileName;
  if (isSignedIn) {
    if (portalStoredName) return portalStoredName;
    if (aliasName) return aliasName;
    return 'Guest';
  }
  if (isGuest) {
    if (guestStoredName) return guestStoredName;
    return aliasName || 'Guest';
  }
  return aliasName || 'Guest';
}

function applyDisplayName() {
  usernameEl.innerText = computeDisplayName();
}

function updateAdminCard() {
  if (!adminStatusEl || !adminActionsEl || !adminBadgeEl) return;

  if (isSignedIn) {
    adminBadgeEl.innerText = 'Admin (signed in)';
    adminStatusEl.innerText = 'You have access to curation tools and shared system controls.';
    Array.from(adminActionsEl.querySelectorAll('a')).forEach(link => {
      link.setAttribute('aria-disabled', 'false');
    });
    if (adminScoreInput && adminScoreButton) {
      adminScoreInput.removeAttribute('disabled');
      adminScoreButton.removeAttribute('disabled');
    }
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Award points to this profile after confirming progress.';
    }
  } else {
    adminBadgeEl.innerText = 'Admin (guest view)';
    adminStatusEl.innerText = 'Sign in to unlock admin shortcuts and synced changes.';
    Array.from(adminActionsEl.querySelectorAll('a')).forEach(link => {
      link.setAttribute('aria-disabled', 'true');
    });
    if (adminScoreInput && adminScoreButton) {
      adminScoreInput.setAttribute('disabled', 'true');
      adminScoreButton.setAttribute('disabled', 'true');
    }
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Sign in as an admin to award score.';
    }
  }
}

function updateProfile(scoreValue) {
  const safeScore = window.ScoreSystem && typeof window.ScoreSystem.sanitizeScore === 'function'
    ? window.ScoreSystem.sanitizeScore(scoreValue)
    : (() => {
      const numeric = typeof scoreValue === 'number' ? scoreValue : Number(scoreValue);
      if (!Number.isFinite(numeric)) return 0;
      return Math.max(0, Math.round(numeric));
    })();

  scoreEl.innerText = safeScore;

  let level = 'Explorer';
  let progress = (safeScore / 500) * 100;

  if (safeScore >= 3000) {
    level = 'Builder';
    progress = ((safeScore - 3000) / 1000) * 100;
  } else if (safeScore >= 1500) {
    level = 'Creator';
    progress = ((safeScore - 1500) / 1500) * 100;
  } else if (safeScore >= 500) {
    level = 'Apprentice';
    progress = ((safeScore - 500) / 1000) * 100;
  }

  levelEl.innerText = level;
  progressEl.style.width = `${Math.max(0, Math.min(progress, 100))}%`;
}

function handleProfileName(name) {
  const normalized = typeof name === 'string' ? name.trim() : '';
  latestProfileName = normalized;
  if (normalized) {
    if (isSignedIn) {
      portalStoredName = normalized;
      localStorage.setItem('username', portalStoredName);
    } else if (isGuest) {
      guestStoredName = normalized;
      localStorage.setItem('guestDisplayName', guestStoredName);
    }
  }
  applyDisplayName();
}

function ensureGuestProfileNode() {
  if (window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
    const guestId = window.ScoreSystem.ensureGuestIdentity();
    if (!guestStoredName) {
      guestStoredName = 'Guest';
      localStorage.setItem('guestDisplayName', guestStoredName);
    }
    return gun.get('3dvr-guests').get(guestId);
  }

  const legacyId = localStorage.getItem('userId');
  if (legacyId && !localStorage.getItem('guestId')) {
    localStorage.setItem('guestId', legacyId);
  }
  if (legacyId) {
    localStorage.removeItem('userId');
  }

  let guestId = localStorage.getItem('guestId');
  if (!guestId) {
    guestId = `guest_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('guestId', guestId);
  }
  localStorage.setItem('guest', 'true');
  if (!guestStoredName) {
    guestStoredName = 'Guest';
    localStorage.setItem('guestDisplayName', guestStoredName);
  }
  return gun.get('3dvr-guests').get(guestId);
}

function watchUsername(node) {
  if (!node) return;
  node.get('username').on(handleProfileName);
  node.get('username').once(name => {
    const normalized = typeof name === 'string' ? name.trim() : '';
    if (normalized) {
      handleProfileName(normalized);
      return;
    }
    const fallback = isSignedIn
      ? (portalStoredName || aliasName || 'Guest')
      : (guestStoredName || 'Guest');
    node.get('username').put(fallback);
    handleProfileName(fallback);
  });
}

function subscribeToScore() {
  if (!scoreManager) {
    updateProfile(0);
    return;
  }
  if (scoreUnsubscribe) return;
  scoreUnsubscribe = scoreManager.subscribe(updateProfile);
  scoreManager.whenReady().then(value => updateProfile(value));
}

function initializeSignedInProfile() {
  isSignedIn = true;
  isGuest = false;
  localStorage.removeItem('guest');
  localStorage.removeItem('guestId');
  localStorage.removeItem('guestDisplayName');
  guestStoredName = '';
  activeProfile = user;

  if (!window.ScoreSystem || typeof window.ScoreSystem.recallUserSession !== 'function') {
    try {
      user.recall({ sessionStorage: true, localStorage: true });
    } catch (err) {
      console.warn('Unable to recall user session', err);
    }
  } else {
    window.ScoreSystem.recallUserSession(user);
  }

  user.get('alias').on(value => {
    aliasName = aliasToDisplay(value);
    applyDisplayName();
  });

  watchUsername(activeProfile);
  applyDisplayName();
  subscribeToScore();
  updateAdminCard();
}

function initializeGuestProfile() {
  isSignedIn = false;
  isGuest = true;
  aliasName = '';
  activeProfile = ensureGuestProfileNode();
  watchUsername(activeProfile);
  applyDisplayName();
  subscribeToScore();
  updateAdminCard();
}

const signedInAlias = (localStorage.getItem('alias') || '').trim();
const signedInPassword = localStorage.getItem('password');

if (isSignedIn && signedInAlias && signedInPassword) {
  aliasName = aliasToDisplay(signedInAlias);
  if (user.is) {
    initializeSignedInProfile();
  } else {
    user.auth(signedInAlias, signedInPassword, ack => {
      if (ack && ack.err) {
        alert('Session expired. Please sign in again.');
        localStorage.removeItem('signedIn');
        localStorage.removeItem('alias');
        localStorage.removeItem('username');
        localStorage.removeItem('password');
        initializeGuestProfile();
      } else {
        initializeSignedInProfile();
      }
    });
  }
} else {
  initializeGuestProfile();
}

function saveUsername() {
  const nameInput = document.getElementById('name-input');
  const name = nameInput.value.trim();
  if (!name || !activeProfile) return;

  latestProfileName = name;
  if (isSignedIn) {
    portalStoredName = name;
    localStorage.setItem('username', portalStoredName);
  } else if (isGuest) {
    guestStoredName = name;
    localStorage.setItem('guestDisplayName', guestStoredName);
  }

  applyDisplayName();
  activeProfile.get('username').put(name);
  nameInput.value = '';
}

function awardAdminScore() {
  if (!isSignedIn) {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Sign in as an admin to award score.';
    }
    return;
  }

  if (!scoreManager || typeof scoreManager.increment !== 'function') {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Score system unavailable. Please try again later.';
    }
    return;
  }

  if (!adminScoreInput) {
    return;
  }

  const bonus = Number(adminScoreInput.value);
  if (!Number.isFinite(bonus) || bonus <= 0) {
    if (adminScoreHelper) {
      adminScoreHelper.innerText = 'Enter a positive number of points to award.';
    }
    return;
  }

  const normalized = Math.round(bonus);
  scoreManager.increment(normalized);
  adminScoreInput.value = '';

  if (adminScoreHelper) {
    adminScoreHelper.innerText = `Awarded ${normalized} points to this profile.`;
  }
}

function resetScore() {
  updateProfile(0);

  if (!scoreManager || typeof scoreManager.set !== 'function') {
    return;
  }

  const performReset = () => {
    scoreManager.set(0);
  };

  if (typeof scoreManager.whenReady === 'function' && !scoreManager.ready) {
    scoreManager.whenReady().then(performReset);
    return;
  }

  performReset();
}
</script>

</body>
</html>
