<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Chatbot</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #e9f0f5;
      color: #222;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 2.5rem;
      margin: 0;
    }

    header p {
      color: #555;
      font-size: 1.1rem;
    }

    #profile-mini {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center;
      width: 100%;
      max-width: 500px;
      margin-bottom: 20px;
    }

    #profile-mini input {
      padding: 8px;
      width: 70%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    #profile-mini button {
      padding: 8px 16px;
      background: #66c2b0;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    #profile-mini button:hover {
      background: #5ca0d3;
    }

    #room-select {
      margin-bottom: 20px;
      text-align: center;
    }

    #room-select select {
      padding: 10px;
      border-radius: 8px;
      font-size: 1rem;
    }

    #new-message {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      width: 100%;
      max-width: 700px;
    }

    input[type="text"], button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
    }

    input[type="text"] {
      flex-grow: 1;
    }

    button {
      background: #66c2b0;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #5ca0d3;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      max-width: 700px;
      width: 100%;
    }

    .message {
      background: #ffffff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      color: #333;
    }

    .meta {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }

    footer {
      margin-top: 40px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      color: #888;
      text-align: center;
    }

    footer a {
      color: #5ca0d3;
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">üè† Portal</a>
  <a href="notes/">üìù Shared Notes</a>
  <a href="tasks.html">‚úÖ Task Board</a>
  <a href="games.html">üéÆ Mini Games</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ GitHub</a>
</div>

<h1>AI Chatbot</h1>

<section id="api-key-panel" aria-label="API key configuration">
  <h2>Bring your own OpenAI key</h2>
  <p>
    Paste your OpenAI API key to call GPT-4o or GPT-4o mini directly from the portal.
    The key is stored locally in your browser and never sent to GunJS or our servers.
  </p>
  <label for="api-key">OpenAI API Key</label>
  <input type="password" id="api-key" placeholder="sk-..." aria-describedby="api-key-help" />
  <button id="save-key">Save key locally</button>
  <p id="api-key-help" class="meta">
    Your key is saved to localStorage only. Remove it any time with the "Clear key" button.
  </p>
  <button id="clear-key" class="secondary">Clear key</button>
</section>

<section id="chat-panel" aria-label="Chat controls">
  <h2>Chat with Codex / GPT</h2>
  <label for="model-select">Model</label>
  <select id="model-select">
    <option value="gpt-4o" selected>gpt-4o (multimodal)</option>
    <option value="gpt-4o-mini">gpt-4o-mini</option>
  </select>

  <label for="message">Your Message</label>
  <input type="text" id="message" placeholder="Ask for code, content, or portal edits..." />

  <button id="submit-btn">Send to OpenAI</button>

  <label for="output">Assistant Response</label>
  <div id="output">Waiting for response...</div>
</section>

<section id="preview-panel" aria-label="Live preview">
  <h2>Live preview (sandboxed)</h2>
  <p class="meta">
    Ask the model to return HTML/CSS snippets and apply them below to see how they render before committing changes.
  </p>
  <button id="apply-preview">Apply response to preview</button>
  <iframe id="response-preview" title="AI response preview" sandbox="">Your browser does not support iframes.</iframe>
</section>

<section id="history-panel" aria-label="Shared transcript">
  <h2>Shared transcript (GunDB)</h2>
  <p class="meta">
    Prompts and responses (not your API key) are saved to a shared GunJS node so your teammates can see what worked.
  </p>
  <ul id="history"></ul>
</section>

<script>
  const gun = Gun();
  const sessionKey = 'ai-chat-session';
  const storedSession = localStorage.getItem(sessionKey);
  const sessionId = storedSession || Gun.text.random();
  localStorage.setItem(sessionKey, sessionId);
  // Store chat history at gun.get('ai').get('sessions').get(sessionId)
  // Each entry is { prompt, response, createdAt }
  const transcriptNode = gun.get('ai').get('sessions').get(sessionId);

  const apiKeyInput = document.getElementById('api-key');
  const saveKeyBtn = document.getElementById('save-key');
  const clearKeyBtn = document.getElementById('clear-key');
  const modelSelect = document.getElementById('model-select');
  const messageInput = document.getElementById('message');
  const outputBox = document.getElementById('output');
  const historyList = document.getElementById('history');
  const previewFrame = document.getElementById('response-preview');
  const applyPreviewBtn = document.getElementById('apply-preview');

  const apiKeyStorageKey = 'openai-api-key';
  const systemPrompt = [
    'You are the 3dvr portal co-pilot.',
    'Suggest concise, actionable edits.',
    'When providing HTML/CSS/JS, keep it minimal and ready for copy/paste.'
  ].join(' ');

  function loadStoredKey() {
    const stored = localStorage.getItem(apiKeyStorageKey);
    if (stored) {
      apiKeyInput.value = stored;
    }
  }

  function renderHistoryItem(entry) {
    const listItem = document.createElement('li');
    listItem.className = 'message';
    const prompt = document.createElement('div');
    prompt.textContent = entry.prompt || '[no prompt]';
    const response = document.createElement('div');
    response.textContent = entry.response || '[no response]';
    const meta = document.createElement('div');
    meta.className = 'meta';
    const date = entry.createdAt ? new Date(entry.createdAt).toLocaleString() : 'unknown time';
    meta.textContent = `Saved ${date}`;
    listItem.appendChild(prompt);
    listItem.appendChild(response);
    listItem.appendChild(meta);
    historyList.prepend(listItem);
  }

  function startHistorySubscription() {
    transcriptNode.map().once((data) => {
      if (!data) return;
      renderHistoryItem(data);
    });
  }

  async function sendToOpenAI() {
    const apiKey = apiKeyInput.value.trim();
    const prompt = messageInput.value.trim();
    const model = modelSelect.value;

    if (!apiKey) {
      outputBox.textContent = 'Add your OpenAI API key to start chatting.';
      return;
    }

    if (!prompt) {
      outputBox.textContent = 'Type a prompt to send to the model.';
      return;
    }

    outputBox.textContent = 'Sending to OpenAI...';

    const body = {
      model,
      messages: [
        {
          role: 'system',
          content: systemPrompt
        },
        {
          role: 'user',
          content: prompt
        }
      ]
    };

    try {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${apiKey}`
        },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API Error ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      const reply = data.choices?.[0]?.message?.content || 'No reply received.';
      outputBox.textContent = reply;

      transcriptNode.set({ prompt, response: reply, createdAt: Date.now() });
    } catch (error) {
      outputBox.textContent = `Error: ${error.message}`;
    }
  }

  function applyPreview() {
    const content = outputBox.textContent || '';
    const previewStyle = "<style>body{font-family:'Poppins',sans-serif;padding:16px;background:#f8fbff;color:#1d1d1f;}</style>";
    previewFrame.srcdoc = `${previewStyle}${content}`;
  }

  saveKeyBtn.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    if (!key) {
      outputBox.textContent = 'Enter a valid API key first.';
      return;
    }
    localStorage.setItem(apiKeyStorageKey, key);
    outputBox.textContent = 'API key saved locally.';
  });

  clearKeyBtn.addEventListener('click', () => {
    localStorage.removeItem(apiKeyStorageKey);
    apiKeyInput.value = '';
    outputBox.textContent = 'API key cleared from this browser.';
  });

  document.getElementById('submit-btn').addEventListener('click', sendToOpenAI);
  applyPreviewBtn.addEventListener('click', applyPreview);

  loadStoredKey();
  startHistorySubscription();
</script>

</body>
</html>
