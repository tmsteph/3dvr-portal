<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3DVR Portal – Calendar Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles/global.css">
  <link rel="stylesheet" href="/calendar/calendar.css">
  <link rel="stylesheet" href="/styles/install-banner.css">
  <link rel="manifest" href="/app-manifests/calendar.webmanifest">
  <meta name="theme-color" content="#0e1116">
  <script defer src="/_vercel/insights/script.js"></script>
  <script src="/pwa-install.js" defer></script>
</head>
<body>
  <header class="calendar-header">
    <a class="calendar-header__back" href="../index.html">⬅ Back to Portal</a>
    <h1 class="calendar-header__title">Calendar Hub</h1>
    <p class="calendar-header__subtitle">
      Manage your schedule directly in the portal. Events live in your local calendar first, with optional
      syncs to Google or Outlook when you need them.
    </p>
  </header>

  <div class="install-banner" data-install-banner hidden>
    <div class="install-banner__text">
      <p class="install-banner__title">Install Calendar Hub</p>
      <p class="install-banner__meta">Open your schedule instantly and keep entries available offline.</p>
    </div>
    <button type="button" class="install-banner__action" data-install-button>Install app</button>
  </div>

  <main class="calendar-shell">
    <section class="panel" aria-labelledby="local-calendar-title">
      <div class="panel__header">
        <h2 id="local-calendar-title">My local calendar</h2>
        <p class="panel__intro">
          Add events that stay in this browser by default. When you want to share them with another service,
          you can trigger an optional sync without leaving this page.
        </p>
      </div>

      <div class="create-event-actions">
        <button
          type="button"
          data-action="toggle-create-event"
          data-label-open="Add event"
          data-label-close="Hide event form"
          data-label-edit-open="Editing event"
          data-label-edit-close="Cancel edit"
          aria-expanded="false"
          aria-controls="create-event-form"
        >Add event</button>
      </div>

      <div class="create-event-form__container" data-create-event-container hidden>
        <form class="create-event-form" id="create-event-form">
          <input type="hidden" name="eventId">
          <div class="create-event-form__row">
            <label class="field">
              <span class="field__label">Title</span>
              <input type="text" name="title" required placeholder="Sprint planning">
            </label>
            <label class="field">
              <span class="field__label">Start</span>
              <input type="datetime-local" name="start" required>
            </label>
            <label class="field">
              <span class="field__label">End</span>
              <input type="datetime-local" name="end" required>
            </label>
          </div>
          <div class="create-event-form__row">
            <label class="field">
              <span class="field__label">Timezone</span>
              <input type="text" name="timeZone" required>
            </label>
            <label class="field">
              <span class="field__label">Description</span>
              <textarea name="description" rows="3" placeholder="Add agenda and dial-in details"></textarea>
            </label>
          </div>

          <div class="create-event-form__row">
            <fieldset class="field">
              <legend class="field__label">Repeat</legend>
              <p class="field__help">Create weekly copies so recurring meetings stay in sync.</p>
              <label class="field field--checkbox">
                <input type="checkbox" name="repeatWeekly">
                <span class="field__label">Repeat every week</span>
              </label>
              <label class="field">
                <span class="field__label">Number of weeks</span>
                <input type="number" name="repeatWeeks" min="1" max="52" value="4">
                <span class="field__help">Includes the first week.</span>
              </label>
            </fieldset>
          </div>

          <fieldset class="create-event-form__reminder">
            <legend>Email reminder</legend>
            <p class="field__help">Choose when to email attendees about this event.</p>
            <div class="create-event-form__row">
              <label class="field">
                <span class="field__label">Send reminder</span>
                <select name="reminderDayOffset">
                  <option value="0">The day of the event</option>
                  <option value="-1">Day before</option>
                </select>
              </label>
              <label class="field">
                <span class="field__label">At</span>
                <input type="time" name="reminderTime" value="10:00">
              </label>
            <label class="field">
              <span class="field__label">Recipients</span>
              <input type="text" name="reminderRecipients" placeholder="team@example.com, guest@example.com">
              <span class="field__help">Comma separate addresses. Defaults to you if left blank.</span>
            </label>
            <label class="field">
              <span class="field__label">Reminder link</span>
              <input type="url" name="reminderLink" placeholder="https://meet.example.com/room">
              <span class="field__help">Optional meeting or watch link to include in reminder emails.</span>
            </label>
            <label class="field">
              <span class="field__label">Reminder message</span>
              <textarea name="reminderMessage" rows="3" placeholder="Add the invite link and quick instructions"></textarea>
              <span class="field__help">Shared in the reminder email along with the event details.</span>
            </label>
            <label class="field field--checkbox">
              <input type="checkbox" name="sendReminderAfterSave">
              <span class="field__label">Send reminder right after saving</span>
              <span class="field__help">Uses the reminder schedule above and recipients to email immediately.</span>
            </label>
          </div>
        </fieldset>

          <fieldset class="create-event-form__sync">
            <legend>Optional sync</legend>
            <p>Select the services that should also receive this event after it is stored locally.</p>
            <label class="chip">
              <input type="checkbox" name="syncProviders" value="google">
              <span>Google</span>
            </label>
            <label class="chip">
              <input type="checkbox" name="syncProviders" value="outlook">
              <span>Outlook</span>
            </label>
          </fieldset>

          <button type="submit">Save event</button>
        </form>
      </div>

      <div class="calendar-view" aria-labelledby="calendar-view-title">
        <div class="calendar-view__header">
          <div>
            <h3 id="calendar-view-title">Monthly overview</h3>
            <p class="calendar-view__subtitle">See your saved events at a glance.</p>
          </div>
          <div class="calendar-view__controls" role="group" aria-label="Change month">
            <button type="button" class="button-secondary" data-calendar-nav="prev" aria-label="Previous month">‹</button>
            <button type="button" class="button-secondary" data-calendar-today>Today</button>
            <button type="button" class="button-secondary" data-calendar-nav="next" aria-label="Next month">›</button>
          </div>
        </div>
        <p class="calendar-view__current" data-calendar-current aria-live="polite"></p>
        <div class="calendar-view__grid" role="grid" aria-describedby="calendar-view-title">
          <div class="calendar-view__grid-inner">
            <div class="calendar-view__day-names" data-calendar-day-names role="row"></div>
            <div class="calendar-view__days" data-calendar-grid role="rowgroup"></div>
          </div>
        </div>
        <div class="calendar-view__details" data-calendar-details hidden>
          <h4 class="calendar-view__details-title" data-calendar-details-title></h4>
          <p class="calendar-view__details-empty" data-calendar-details-empty>No events for this day yet. Use the button below to add one.</p>
          <div class="calendar-view__details-actions" data-calendar-details-actions hidden>
            <button type="button" class="button-secondary" data-action="add-event-for-day">Add event for this day</button>
          </div>
          <ul class="calendar-view__details-list" data-calendar-details-list></ul>
        </div>
      </div>

      <div class="event-results" aria-live="polite">
        <div class="event-results__empty" data-empty>
          <p>No events yet. Add one above or import from Google/Outlook when you're ready.</p>
        </div>
        <ul class="event-results__list" data-event-list></ul>
      </div>

      <div class="log" aria-live="polite" data-log></div>
    </section>

    <section class="panel" aria-labelledby="connections-title">
      <div class="panel__header">
        <h2 id="connections-title">Optional account connections</h2>
        <p class="panel__intro">
          Authenticate with Google or Outlook using OAuth and paste the access token below. We store the
          values locally so you can quickly reconnect while developing the integration.
        </p>
      </div>

      <div class="connection-grid">
        <article class="connection-card" aria-labelledby="google-connection-title">
          <div class="connection-card__header">
            <h3 id="google-connection-title">Google Calendar</h3>
            <span class="connection-card__status" data-status="google">Disconnected</span>
          </div>
          <form class="connection-card__form" data-provider="google">
            <label class="field">
              <span class="field__label">Access token</span>
              <textarea name="accessToken" rows="3" required placeholder="ya29.a0AWY..." aria-describedby="google-token-help"></textarea>
            </label>
            <label class="field">
              <span class="field__label">Calendar ID (optional)</span>
              <input type="text" name="calendarId" placeholder="primary">
            </label>
            <p class="field__help" id="google-token-help">
              Generate tokens via Google OAuth 2.0. Use a test project and enable the Calendar API. Tokens
              are saved in your browser only.
            </p>
            <div class="connection-card__actions">
              <button type="submit">Save connection</button>
              <button type="button" class="button-secondary" data-action="disconnect" data-provider="google">Disconnect</button>
            </div>
          </form>
          <details class="connection-card__details">
            <summary>Need help?</summary>
            <ol>
              <li>Create an OAuth 2.0 client in the Google Cloud console.</li>
              <li>Authorize the playground or your dev app with the <code>https://www.googleapis.com/auth/calendar</code> scope.</li>
              <li>Paste the returned <strong>access_token</strong> here. Refresh tokens can be rotated manually for now.</li>
            </ol>
          </details>
        </article>

        <article class="connection-card" aria-labelledby="outlook-connection-title">
          <div class="connection-card__header">
            <h3 id="outlook-connection-title">Outlook / Microsoft 365</h3>
            <span class="connection-card__status" data-status="outlook">Disconnected</span>
          </div>
          <form class="connection-card__form" data-provider="outlook">
            <label class="field">
              <span class="field__label">Access token</span>
              <textarea name="accessToken" rows="3" required placeholder="EwBwA8l6B..." aria-describedby="outlook-token-help"></textarea>
            </label>
            <label class="field">
              <span class="field__label">Mailbox (optional)</span>
              <input type="email" name="mailbox" placeholder="user@contoso.com">
            </label>
            <p class="field__help" id="outlook-token-help">
              Create an Azure AD app registration with Calendars.ReadWrite delegated permissions and paste the
              access token here. Microsoft Graph endpoints are proxied through our API folder.
            </p>
            <div class="connection-card__actions">
              <button type="submit">Save connection</button>
              <button type="button" class="button-secondary" data-action="disconnect" data-provider="outlook">Disconnect</button>
            </div>
          </form>
          <details class="connection-card__details">
            <summary>Need help?</summary>
            <ol>
              <li>Register a single-page application in Azure.</li>
              <li>Grant delegated permissions for <code>Calendars.ReadWrite</code> and <code>offline_access</code>.</li>
              <li>Use the OAuth 2.0 authorization code flow to fetch tokens, then paste the <strong>access_token</strong> here.</li>
            </ol>
          </details>
        </article>
      </div>
    </section>

    <section class="panel" aria-labelledby="event-sync-title">
      <div class="panel__header">
        <h2 id="event-sync-title">Import from external calendars</h2>
        <p class="panel__intro">
          Pull events from connected providers when you want to copy them into your local calendar. Choose a
          provider below to start an import.
        </p>
      </div>

      <form class="sync-controls" id="event-sync-form">
        <fieldset class="sync-controls__group">
          <legend>Provider</legend>
          <label class="chip">
            <input type="radio" name="provider" value="google" checked>
            <span>Google</span>
          </label>
          <label class="chip">
            <input type="radio" name="provider" value="outlook">
            <span>Outlook</span>
          </label>
        </fieldset>

        <fieldset class="sync-controls__group">
          <legend>Time range</legend>
          <label class="field">
            <span class="field__label">From</span>
            <input type="datetime-local" name="timeMin">
          </label>
          <label class="field">
            <span class="field__label">To</span>
            <input type="datetime-local" name="timeMax">
          </label>
          <label class="field">
            <span class="field__label">Max events</span>
            <input type="number" name="maxResults" min="1" max="100" value="20">
          </label>
        </fieldset>

        <div class="sync-controls__actions">
          <button type="button" data-action="fetch-events">Import events</button>
          <button type="button" data-action="refresh-status">Refresh status</button>
        </div>
      </form>
    </section>
  </main>

  <template id="event-template">
    <li class="event-card">
      <div class="event-card__header">
        <h3 data-field="title"></h3>
        <span class="event-card__provider" data-field="provider"></span>
      </div>
      <dl class="event-card__meta">
        <div>
          <dt>Starts</dt>
          <dd data-field="start"></dd>
        </div>
        <div>
          <dt>Ends</dt>
          <dd data-field="end"></dd>
        </div>
        <div data-reminder-block>
          <dt>Reminder</dt>
          <dd>
            <span data-field="reminder"></span>
            <button type="button" class="button-secondary" data-action="send-reminder">Send now</button>
          </dd>
        </div>
      </dl>
      <p class="event-card__description" data-field="description"></p>
      <div class="event-card__footer">
        <a class="event-card__link" data-field="link" href="#" target="_blank" rel="noreferrer noopener">Open in calendar</a>
        <div class="event-card__footer-actions">
          <button type="button" class="event-card__edit button-secondary" data-action="edit-event">Edit</button>
          <button type="button" class="event-card__delete button-secondary" data-action="delete-event">Remove</button>
        </div>
      </div>
    </li>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="/gun-init.js"></script>
  <script src="/calendar/calendar.js" type="module"></script>
</body>
</html>
