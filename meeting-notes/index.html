<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3DVR - Meeting Attendance & Notes</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="/gun-init.js"></script>
  <script>
    // Create a Gun instance for the meetings workspace so reads/writes persist across sessions and peers
    window.gun = Gun(window.__GUN_PEERS__ || [
      'wss://relay.3dvr.tech/gun',
      'wss://gun-relay-3dvr.fly.dev/gun'
    ]);
  </script>
  <link rel="stylesheet" href="/styles/global.css">
  <style>
    :root {
      --bg: #090b10;
      --panel: #0f131a;
      --panel-strong: #141a24;
      --text: #e8edf7;
      --muted: #9aa3b8;
      --accent: #73cfff;
      --accent-strong: #5ab6ff;
      --success: #6ee7b7;
      --warning: #fcd34d;
      --danger: #f87171;
      --border: #1f2632;
      --radius: 16px;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(88, 207, 255, 0.06), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(123, 255, 196, 0.05), transparent 40%),
        linear-gradient(180deg, #0a0d14 0%, #07090e 60%, #05070b 100%);
      color: var(--text);
    }

    a { color: var(--accent); }
    a:hover { color: var(--accent-strong); }

    .skip-link {
      position: absolute;
      top: -40px;
      left: 16px;
      background: var(--accent);
      color: #041423;
      padding: 10px 14px;
      border-radius: 10px;
      text-decoration: none;
      transition: top 0.2s ease;
      font-weight: 600;
      z-index: 10;
    }

    .skip-link:focus { top: 16px; }

    .meeting-header {
      padding: 18px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: rgba(9, 11, 16, 0.75);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 8;
    }

    .meeting-header__title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .meeting-header__icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, rgba(115, 207, 255, 0.2), rgba(90, 182, 255, 0.25));
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      font-size: 20px;
    }

    .meeting-header__text h1 {
      margin: 0;
      font-size: clamp(1.3rem, 2vw, 1.7rem);
    }

    .meeting-header__text p {
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .meeting-header__links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill-link {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .pill-link:hover { border-color: var(--accent); color: var(--accent); }

    main {
      padding: clamp(16px, 4vw, 32px);
      max-width: 1240px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .meeting-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }

    .panel {
      background: linear-gradient(145deg, rgba(20, 26, 36, 0.92), rgba(12, 15, 22, 0.92));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      letter-spacing: -0.01em;
    }

    .panel p { margin: 0; color: var(--muted); }

    form { display: grid; gap: 10px; }

    label { font-weight: 600; }

    input, textarea, select, button {
      font: inherit;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .input, .select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .input:focus, .select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 3px rgba(115, 207, 255, 0.2);
    }

    .button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #041423;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .button:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2); }

    .button-secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .button-danger {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.9), rgba(239, 68, 68, 0.9));
      color: #041423;
      border: none;
    }

    .button-ghost {
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      border: 1px solid var(--border);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .button[aria-disabled="true"],
    .button:disabled,
    .button-ghost[aria-disabled="true"] {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }

    .meeting-list {
      display: grid;
      gap: 12px;
      margin: 12px 0 0;
    }

    .meeting-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: var(--panel);
      color: var(--text);
      display: grid;
      gap: 10px;
    }

    .meeting-card__title { margin: 0; font-weight: 700; font-size: 1.05rem; }
    .meeting-card__meta { margin: 0; color: var(--muted); font-size: 0.95rem; }

    .meeting-card__actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(115, 207, 255, 0.12);
      color: var(--accent);
      border: 1px solid rgba(115, 207, 255, 0.3);
      font-weight: 700;
      font-size: 0.9rem;
      width: fit-content;
    }

    .empty-copy { margin: 0; color: var(--muted); }
  </style>
</head>
<body>
  <a class="skip-link" href="#mainContent">Skip to main content</a>

  <header class="meeting-header">
    <div class="meeting-header__title">
      <div class="meeting-header__icon" aria-hidden="true">üóíÔ∏è</div>
      <div class="meeting-header__text">
        <h1>Meeting Attendance & Notes</h1>
        <p>Track sessions, share links, and clean up past events.</p>
      </div>
    </div>
    <div class="meeting-header__links">
      <a class="pill-link" href="/index.html">üè† Portal Home</a>
      <a class="pill-link" href="/portal.3dvr.tech/video/">üé• Video Meeting</a>
    </div>
  </header>

  <main id="mainContent">
    <div class="meeting-grid">
      <section class="panel">
        <h2>Create a meeting</h2>
        <p>Set the session details so teammates can join and capture notes.</p>
        <form id="meetingForm">
          <div class="field">
            <label for="meetingTitle">Meeting title</label>
            <input class="input" id="meetingTitle" name="title" type="text" required
              placeholder="Weekly sync, client kickoff, design review...">
          </div>
          <div class="field">
            <label for="meetingDate">Date & time</label>
            <input class="input" id="meetingDate" name="datetime" type="datetime-local" required>
          </div>
          <button class="button" type="submit">Add meeting</button>
        </form>
      </section>

      <section class="panel">
        <h2>Meeting overview</h2>
        <p>Open or delete meetings directly from the list.</p>
        <div class="meeting-list" id="meetingList" aria-live="polite"></div>
        <p id="emptyListCopy" class="empty-copy">No meetings yet. Create the first session to start tracking attendance.</p>
      </section>
    </div>
  </main>

  <script>
    const gun = window.gun;
    // Gun graph: meeting-notes -> meetings -> {meetingId} -> {title, datetime, createdAt}
    const meetingsNode = gun.get('meeting-notes').get('meetings');

    const meetingForm = document.getElementById('meetingForm');
    const meetingList = document.getElementById('meetingList');
    const emptyListCopy = document.getElementById('emptyListCopy');

    const meetingsCache = new Map();

    const slugify = (value) => {
      return (value || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-');
    };

    const ensureUniqueMeetingId = (title) => {
      const baseSlug = slugify(title) || 'meeting';
      let candidate = baseSlug;

      while (meetingsCache.has(candidate)) {
        candidate = `${baseSlug}-${Math.random().toString(36).slice(2, 6)}`;
      }

      return candidate;
    };

    const formatDate = (value) => {
      if (!value) return 'Date not set';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    };

    const buildMeetingPageUrl = (meetingId) => {
      const url = new URL(window.location.href);
      url.pathname = '/meeting-notes/meeting.html';
      url.searchParams.set('meeting', meetingId);
      return url.toString();
    };

    const updateEmptyStates = () => {
      emptyListCopy.hidden = meetingList.childElementCount > 0;
    };

    const renderMeetingList = () => {
      meetingList.innerHTML = '';

      Array.from(meetingsCache.entries())
        .sort(([_idA, a], [_idB, b]) => {
          const dateA = new Date(a?.datetime || a?.createdAt || 0).getTime();
          const dateB = new Date(b?.datetime || b?.createdAt || 0).getTime();
          return dateB - dateA;
        })
        .forEach(([id, data]) => {
          const meetingPageUrl = buildMeetingPageUrl(id);

          const card = document.createElement('article');
          card.className = 'meeting-card';
          card.setAttribute('data-meeting-id', id);

          const dateTag = document.createElement('div');
          dateTag.className = 'tag';
          dateTag.textContent = formatDate(data?.datetime);

          const title = document.createElement('h3');
          title.className = 'meeting-card__title';
          title.textContent = data?.title || 'Untitled meeting';

          const meta = document.createElement('p');
          meta.className = 'meeting-card__meta';
          meta.textContent = `Created ${formatDate(data?.createdAt)}`;

          const actions = document.createElement('div');
          actions.className = 'meeting-card__actions';

          const openLink = document.createElement('a');
          openLink.className = 'button button-secondary';
          openLink.href = meetingPageUrl;
          openLink.textContent = 'Open meeting';
          openLink.target = '_blank';
          openLink.rel = 'noopener';

          const copyButton = document.createElement('button');
          copyButton.className = 'button button-ghost';
          copyButton.type = 'button';
          copyButton.textContent = 'Copy link';
          copyButton.addEventListener('click', async () => {
            try {
              await navigator.clipboard.writeText(meetingPageUrl);
              copyButton.textContent = 'Link copied';
              window.setTimeout(() => {
                copyButton.textContent = 'Copy link';
              }, 2000);
            } catch (error) {
              copyButton.textContent = 'Copy not available';
              console.error('Failed to copy meeting link', error);
              window.setTimeout(() => {
                copyButton.textContent = 'Copy link';
              }, 2000);
            }
          });

          const deleteButton = document.createElement('button');
          deleteButton.className = 'button button-danger';
          deleteButton.type = 'button';
          deleteButton.textContent = 'Delete meeting';
          deleteButton.addEventListener('click', () => {
            const confirmation = window.confirm(
              `Delete "${data?.title || 'this meeting'}"? This removes its notes and attendance.`,
            );
            if (!confirmation) return;
            meetingsNode.get(id).put(null);
            meetingsCache.delete(id);
            renderMeetingList();
          });

          actions.appendChild(openLink);
          actions.appendChild(copyButton);
          actions.appendChild(deleteButton);

          card.appendChild(dateTag);
          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(actions);

          meetingList.appendChild(card);
        });

      updateEmptyStates();
    };

    meetingForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const formData = new FormData(meetingForm);
      const title = formData.get('title');
      const datetime = formData.get('datetime');
      const meetingId = ensureUniqueMeetingId(title);
      meetingsNode.get(meetingId).put({
        title,
        datetime,
        createdAt: new Date().toISOString(),
      });
      meetingForm.reset();
    });

    meetingsNode.map().once((data, meetingId) => {
      if (!data || meetingId === '_') return;
      meetingsCache.set(meetingId, data);
      renderMeetingList();
    });

    meetingsNode.map().on((data, meetingId) => {
      if (!data || meetingId === '_') {
        meetingsCache.delete(meetingId);
        renderMeetingList();
        return;
      }
      meetingsCache.set(meetingId, data);
      renderMeetingList();
    });

    updateEmptyStates();
  </script>
</body>
</html>
