<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gun Compat Check</title>
<pre id="log" style="white-space:pre-wrap;padding:12px;font:13px/1.4 ui-monospace,Consolas,monospace"></pre>
<script type="module">
  // ---- UTIL ----
  const log = document.getElementById('log');
  const out = (...args) => {
    log.textContent += args.join(' ') + '\n';
  };

  out('Gun compatibility check starting…');
  out('User agent', navigator.userAgent);

  // ---- CONFIG (Codex replaces {{WSS_RELAY_URL}}) ----
  const PEERS = (window.__GUN_PEERS__ && window.__GUN_PEERS__.length)
    ? window.__GUN_PEERS__
    : [
      'wss://relay.3dvr.tech/gun',
      'wss://gun-relay-3dvr.fly.dev/gun'
    ];

  out('Peers', JSON.stringify(PEERS));

  const resolveGunFactory = moduleResult => {
    if (typeof moduleResult === 'function') return moduleResult;
    if (moduleResult && typeof moduleResult.default === 'function') return moduleResult.default;
    if (moduleResult && typeof moduleResult.Gun === 'function') return moduleResult.Gun;
    if (moduleResult?.default && typeof moduleResult.default.Gun === 'function') return moduleResult.default.Gun;
    if (typeof window !== 'undefined' && typeof window.Gun === 'function') return window.Gun;
    return null;
  };

  const loadGun = async () => {
    let mod;
    try {
      mod = await import('https://cdn.jsdelivr.net/npm/gun/gun.js');
    } catch (err) {
      out('IMPORT ERR', err?.message || err);
    }

    const GunCtor = resolveGunFactory(mod);
    if (typeof GunCtor !== 'function') {
      const keys = mod ? Object.keys(mod).join(',') : 'none';
      throw new Error(`Gun constructor missing (module keys: ${keys})`);
    }
    return GunCtor;
  };

  const run = async () => {
    let Gun;
    try {
      Gun = await loadGun();
    } catch (err) {
      out('IMPORT ERR', err?.message || err);
      return;
    }

    let gun;
    try {
      gun = Gun({ peers: PEERS, axe: true, radisk: false, localStorage: false });
    } catch (err) {
      out('INIT ERR', err?.message || err);
      return;
    }

    // connectivity signals
    let connected = false;
    setTimeout(() => {
      if (!connected) out('WARN: no peer open after 3000ms');
    }, 3000);
    gun.on('hi', peer => {
      connected = true;
      out('HI', peer?.url || '');
    });
    gun.on('bye', peer => out('BYE', peer?.url || ''));

    const ROOT = 'compat:test';
    const key = `ts:${Date.now()}:${Math.random().toString(36).slice(2)}`;
    const sample = { key, ua: navigator.userAgent, when: Date.now() };

    try {
      const db = gun.get(ROOT);
      db.get('roundtrip').get(key).put(sample, ack => {
        if (ack?.err) {
          out('PUT ERR', ack.err);
          return;
        }
        out('PUT OK', key);
        db.get('roundtrip').get(key).once(val => {
          out('READ BACK', JSON.stringify(val));
          out(val ? 'SUCCESS ✅' : 'FAILED ❌');
        });
      });
    } catch (err) {
      out('RUNTIME ERR', err?.message || err);
    }
  };

  run().catch(err => out('UNCAUGHT', err?.message || err));
</script>
