<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3DVR CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://fav.farm/ðŸ§ " />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/axe.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">
  <header class="bg-gray-950/70 border-b border-white/10">
    <div class="max-w-5xl mx-auto px-4 py-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="text-xs font-semibold tracking-[0.32em] text-teal-400 uppercase">Sales toolkit</p>
        <h1 class="text-3xl font-bold">3DVR CRM</h1>
        <p class="text-sm text-gray-300">Log deal progress, then jump into contacts and training without losing context.</p>
        <p class="text-xs text-gray-400 mt-2">This workspace is shared so the whole team can see who has been contacted and when.</p>
      </div>
      <nav class="flex flex-wrap gap-2 text-sm">
        <a href="../sales/index.html" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded transition">Sales home</a>
        <a href="../sales/training/" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded transition">Training playbook</a>
        <a href="../contacts/index.html" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded transition">Contacts workspace</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <section class="grid gap-4 md:grid-cols-2">
      <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-2">Shared context</h2>
        <p class="text-sm text-gray-300">This CRM uses the same 3DVR GUN relay as the contacts workspace. Tag people the same way so both apps stay aligned.</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <a href="../contacts/index.html" class="bg-teal-600 hover:bg-teal-500 text-white px-3 py-2 rounded">Open contacts</a>
          <a href="../sales/training/" class="bg-sky-600 hover:bg-sky-500 text-white px-3 py-2 rounded">Review training</a>
        </div>
      </div>
      <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-2">Deal pulse</h2>
        <p class="text-sm text-gray-300">Track how many records you have overall versus what is visible after filtering.</p>
        <div class="mt-4 grid grid-cols-2 gap-3 text-center text-sm text-gray-300">
          <div class="bg-gray-900/60 border border-white/5 rounded-lg py-3">
            <div class="text-2xl font-semibold" id="totalCount">0</div>
            <div>Total records</div>
          </div>
          <div class="bg-gray-900/60 border border-white/5 rounded-lg py-3">
            <div class="text-2xl font-semibold" id="visibleCount">0</div>
            <div>Visible now</div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-[320px,1fr]">
      <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-xl font-semibold">Add CRM record</h2>
            <p class="text-sm text-gray-300">Capture notes or deal details without leaving the list.</p>
          </div>
          <button id="openCrmCreate" type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">New record</button>
        </div>
      </div>
      <div class="space-y-6">
        <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
          <label for="filter" class="block text-sm text-gray-300 mb-2">Search workspace</label>
          <input id="filter" type="search" placeholder="Filter by name, email, tags, or notes" class="w-full p-2 rounded text-black" />
        </div>
        <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
            <h2 class="text-xl font-semibold">Contacts</h2>
            <span class="text-xs uppercase tracking-[0.32em] text-gray-400">Live</span>
          </div>
          <div id="crmDuplicateSummary" class="hidden bg-amber-900/40 border border-amber-500/30 rounded-lg p-3 text-sm text-amber-100 mb-4"></div>
          <div id="contactList" class="space-y-4"></div>
          <div id="emptyState" class="text-sm text-gray-400 hidden">No contacts yet. Add someone from the form or sync from the contacts app.</div>
        </div>
      </div>
    </section>
  </main>

  <div id="crmCreateOverlay" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm px-4 py-8 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="crmCreateTitle">
    <div class="w-full max-w-2xl mx-auto bg-gray-900/95 border border-white/10 rounded-2xl shadow-2xl p-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div class="space-y-1">
          <p class="text-xs uppercase tracking-[0.32em] text-sky-300">New CRM record</p>
          <h2 id="crmCreateTitle" class="text-2xl font-semibold">Create record</h2>
          <p class="text-sm text-gray-300">Fill in deal context so the whole team stays aligned.</p>
        </div>
        <button id="closeCrmCreate" type="button" class="self-end text-sm text-gray-300 hover:text-white">Close</button>
      </div>
      <form id="contactForm" class="mt-6 grid gap-3">
        <div class="grid gap-2 md:grid-cols-2">
          <input type="text" id="name" placeholder="Name" class="w-full p-2 rounded text-black" />
          <input type="email" id="email" placeholder="Email" class="w-full p-2 rounded text-black" />
          <input type="text" id="company" placeholder="Company" class="w-full p-2 rounded text-black" />
          <input type="text" id="phone" placeholder="Phone" class="w-full p-2 rounded text-black" />
          <input type="text" id="role" placeholder="Role (client, lead...)" class="w-full p-2 rounded text-black" />
          <input type="text" id="tags" placeholder="Tags (comma separated)" class="w-full p-2 rounded text-black" />
          <select id="status" class="w-full p-2 rounded text-black">
            <option value="">Status (optional)</option>
            <option>Lead</option>
            <option>Prospect</option>
            <option>Active</option>
            <option>Negotiating</option>
            <option>Won</option>
            <option>Lost</option>
          </select>
          <input type="date" id="nextFollowUp" class="w-full p-2 rounded text-black" />
        </div>
        <textarea id="notes" placeholder="Notes" class="w-full p-2 rounded text-black"></textarea>
        <div class="flex gap-2">
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Save</button>
          <button type="button" id="cancelCrmCreate" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="crmDetailOverlay" class="hidden fixed inset-0 z-40 bg-black/70 backdrop-blur-sm px-4 py-8 overflow-y-auto">
    <div id="crmDetailCard" class="w-full max-w-2xl mx-auto bg-gray-900/95 border border-white/10 rounded-2xl shadow-2xl p-6 relative">
      <button id="closeCrmDetail" type="button" class="absolute top-4 right-4 text-sm text-gray-300 hover:text-white">Close</button>
      <div class="space-y-5">
        <div class="space-y-1">
          <p class="text-xs uppercase tracking-[0.32em] text-sky-300">CRM record</p>
          <h2 id="crmDetailName" class="text-2xl font-semibold">Name</h2>
          <p id="crmDetailSummary" class="text-sm text-gray-300">Summary</p>
        </div>
        <div id="crmDetailTags" class="hidden"></div>
        <div id="crmDetailNotes" class="hidden"></div>
        <div id="crmDetailMeta" class="grid gap-2 text-sm text-gray-300"></div>
        <div id="crmDetailWorkspace" class="text-sm text-gray-300"></div>
        <div id="crmDetailActions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <script>
    const gun = Gun(['https://gun-relay-3dvr.fly.dev/gun']);
    const user = gun.user();
    try {
      user.recall({ sessionStorage: true, localStorage: true });
    } catch (err) {
      console.warn('Unable to recall user session', err);
    }

    const ls = localStorage;
    const signedIn = ls.getItem('signedIn') === 'true';
    const alias = ls.getItem('alias') || '';
    const password = ls.getItem('password') || '';

    const crmRecords = gun.get('3dvr-crm');
    const CONTACT_BUTTON_ADD_LABEL = 'Add to contacts';
    const CONTACT_BUTTON_OPEN_LABEL = 'Open in contacts';
    const form = document.getElementById('contactForm');
    const list = document.getElementById('contactList');
    const filterInput = document.getElementById('filter');
    const totalCountEl = document.getElementById('totalCount');
    const visibleCountEl = document.getElementById('visibleCount');
    const emptyState = document.getElementById('emptyState');
    const duplicateSummaryEl = document.getElementById('crmDuplicateSummary');
    const crmCreateOverlay = document.getElementById('crmCreateOverlay');
    const openCrmCreateBtn = document.getElementById('openCrmCreate');
    const closeCrmCreateBtn = document.getElementById('closeCrmCreate');
    const cancelCrmCreateBtn = document.getElementById('cancelCrmCreate');
    const params = new URLSearchParams(window.location.search);
    const focusContactId = params.get('contact');
    let focusApplied = false;
    const focusClasses = ['ring-2', 'ring-sky-400', 'ring-offset-2', 'ring-offset-gray-900'];
    let contactsWorkspace = null;
    let contactsWorkspaceListener = null;
    let contactsSpaceKey = 'public-demo';
    let contactWorkspaceIndex = {};
    const contactsWorkspaceWaiters = [];

    function sanitizeRecord(data) {
      if (!data || typeof data !== 'object') return {};
      const clean = {};
      Object.entries(data).forEach(([key, value]) => {
        if (key === '_' || typeof value === 'function') return;
        clean[key] = value;
      });
      return clean;
    }

    function getContactButtonLabel(record, id) {
      return findContactInWorkspace(record, id)
        ? CONTACT_BUTTON_OPEN_LABEL
        : CONTACT_BUTTON_ADD_LABEL;
    }
    const crmIndex = {};
    const crmDuplicateExpandedState = new Map();
    const crmDuplicateMetaById = new Map();
    const crmDuplicatePrimaryById = new Map();
    let crmRenderTimer = null;
    const crmDetailOverlay = document.getElementById('crmDetailOverlay');
    const crmDetailName = document.getElementById('crmDetailName');
    const crmDetailSummary = document.getElementById('crmDetailSummary');
    const crmDetailTags = document.getElementById('crmDetailTags');
    const crmDetailNotes = document.getElementById('crmDetailNotes');
    const crmDetailMeta = document.getElementById('crmDetailMeta');
    const crmDetailWorkspace = document.getElementById('crmDetailWorkspace');
    const crmDetailActions = document.getElementById('crmDetailActions');
    const closeCrmDetailBtn = document.getElementById('closeCrmDetail');

    function openCrmCreateOverlay() {
      if (!crmCreateOverlay) return;
      crmCreateOverlay.classList.remove('hidden');
      const firstField = crmCreateOverlay.querySelector('input, textarea, select');
      if (firstField) {
        requestAnimationFrame(() => firstField.focus());
      }
    }

    function closeCrmCreateOverlay() {
      if (!crmCreateOverlay) return;
      crmCreateOverlay.classList.add('hidden');
    }

    if (openCrmCreateBtn) {
      openCrmCreateBtn.addEventListener('click', () => {
        openCrmCreateOverlay();
      });
    }

    if (closeCrmCreateBtn) {
      closeCrmCreateBtn.addEventListener('click', () => {
        closeCrmCreateOverlay();
      });
    }

    if (cancelCrmCreateBtn) {
      cancelCrmCreateBtn.addEventListener('click', () => {
        form?.reset();
        closeCrmCreateOverlay();
      });
    }

    if (crmCreateOverlay) {
      crmCreateOverlay.addEventListener('click', event => {
        if (event.target === crmCreateOverlay) {
          closeCrmCreateOverlay();
        }
      });
    }

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape' && crmCreateOverlay && !crmCreateOverlay.classList.contains('hidden')) {
        closeCrmCreateOverlay();
      }
    });

    function waitForContactsWorkspace(timeout = 4000) {
      if (contactsWorkspace) return Promise.resolve(contactsWorkspace);
      return new Promise(resolve => {
        const waiter = node => {
          if (timer) clearTimeout(timer);
          resolve(node);
        };
        const timer = timeout ? setTimeout(() => {
          const index = contactsWorkspaceWaiters.indexOf(waiter);
          if (index >= 0) {
            contactsWorkspaceWaiters.splice(index, 1);
          }
          resolve(null);
        }, timeout) : null;
        contactsWorkspaceWaiters.push(waiter);
      });
    }

    function setContactsWorkspace(node, spaceKey = 'public-demo') {
      if (contactsWorkspaceListener && typeof contactsWorkspaceListener.off === 'function') {
        try {
          contactsWorkspaceListener.off();
        } catch (err) {
          console.warn('Failed to detach contacts workspace listener', err);
        }
      }
      contactsWorkspaceListener = null;
      contactsWorkspace = node;
      contactsSpaceKey = spaceKey;
      contactWorkspaceIndex = {};
      if (node) {
        contactsWorkspaceListener = node.map().on((data, contactId) => {
          if (!contactId) return;
          if (!data) {
            delete contactWorkspaceIndex[contactId];
            return;
          }
          contactWorkspaceIndex[contactId] = { ...(contactWorkspaceIndex[contactId] || {}), ...data, id: contactId };
        });
      }
      while (contactsWorkspaceWaiters.length) {
        const resolve = contactsWorkspaceWaiters.shift();
        try {
          if (typeof resolve === 'function') {
            resolve(node);
          }
        } catch (err) {
          console.warn('Failed to notify contacts workspace waiter', err);
        }
      }
    }

    function usePersonalContacts() {
      setContactsWorkspace(user.get('contacts'), 'personal');
    }

    function usePublicContacts() {
      setContactsWorkspace(gun.get('contacts-public'), 'public-demo');
    }

    if (typeof user.on === 'function') {
      user.on('auth', () => {
        usePersonalContacts();
      });
    }

    if (user.is) {
      usePersonalContacts();
    } else if (signedIn && alias && password) {
      user.auth(alias, password, ack => {
        if (ack && ack.err) {
          console.warn('CRM auth failed', ack.err);
          usePublicContacts();
        } else {
          usePersonalContacts();
        }
      });
    } else {
      usePublicContacts();
    }

    const getFieldValue = id => (document.getElementById(id)?.value || '').trim();

    form.addEventListener('submit', e => {
      e.preventDefault();
      const id = Date.now().toString();
      const now = new Date().toISOString();
      const contact = {
        id,
        contactId: id,
        name: getFieldValue('name'),
        email: getFieldValue('email'),
        company: getFieldValue('company'),
        phone: getFieldValue('phone'),
        role: getFieldValue('role'),
        tags: getFieldValue('tags'),
        status: getFieldValue('status'),
        nextFollowUp: getFieldValue('nextFollowUp'),
        notes: getFieldValue('notes'),
        lastContacted: '',
        activityCount: 0,
        source: 'CRM workspace',
        created: now,
        updated: now
      };
      crmRecords.get(id).put(contact);
      form.reset();
      closeCrmCreateOverlay();
    });

    crmRecords.map().on((data, id) => {
      if (!id) return;
      if (!data) {
        delete crmIndex[id];
      } else {
        const sanitized = sanitizeRecord(data);
        crmIndex[id] = { ...(crmIndex[id] || {}), ...sanitized, id };
      }
      scheduleRender();
    });

    function scheduleRender() {
      clearTimeout(crmRenderTimer);
      crmRenderTimer = setTimeout(renderList, 40);
    }

    function renderList() {
      const records = Object.values(crmIndex);
      const sorted = records.slice().sort((a, b) => {
        const aStamp = a.updated || a.created || '';
        const bStamp = b.updated || b.created || '';
        if (aStamp === bStamp) {
          return (a.name || '').localeCompare(b.name || '');
        }
        return bStamp.localeCompare(aStamp);
      });
      const collapsed = collapseCrmDuplicates(sorted);
      list.innerHTML = collapsed.records.map(renderCrmCard).join('');
      collapsed.records.forEach(record => {
        attachCrmCardInteractions(record);
        if (crmDuplicateMetaById.has(record.id)) {
          wireCrmDuplicateControls(record.id);
        }
      });
      applyFilter();
    }

    function collapseCrmDuplicates(records) {
      crmDuplicateMetaById.clear();
      crmDuplicatePrimaryById.clear();
      const groups = computeDuplicateGroups(records);
      const hiddenIds = new Set();
      groups.forEach(group => {
        const ordered = sortCrmDuplicateCandidates(group.items);
        const primary = ordered[0];
        const duplicates = ordered.slice(1);
        const emailSummary = describeEmailDifferences(ordered);
        crmDuplicateMetaById.set(primary.id, {
          name: group.name,
          total: ordered.length,
          records: ordered,
          duplicates,
          emailSummary
        });
        ordered.forEach(item => {
          crmDuplicatePrimaryById.set(item.id, primary.id);
          if (item.id !== primary.id) hiddenIds.add(item.id);
        });
      });
      const seenPrimaries = new Set();
      const result = [];
      records.forEach(record => {
        const primaryId = crmDuplicatePrimaryById.get(record.id);
        if (primaryId) {
          if (record.id === primaryId && !seenPrimaries.has(primaryId)) {
            result.push(record);
            seenPrimaries.add(primaryId);
          }
        } else {
          result.push(record);
        }
      });
      return { records: result, hiddenCount: hiddenIds.size };
    }

    function sortCrmDuplicateCandidates(items) {
      return items.slice().sort((a, b) => {
        const aLinked = a.contactId ? 1 : 0;
        const bLinked = b.contactId ? 1 : 0;
        if (aLinked !== bLinked) return bLinked - aLinked;
        const aStamp = a.updated || a.created || '';
        const bStamp = b.updated || b.created || '';
        if (aStamp !== bStamp) return bStamp.localeCompare(aStamp);
        const aScore = crmDuplicateCompletenessScore(a);
        const bScore = crmDuplicateCompletenessScore(b);
        if (aScore !== bScore) return bScore - aScore;
        return (a.id || '').localeCompare(b.id || '');
      });
    }

    function crmDuplicateCompletenessScore(record) {
      const fields = ['email', 'phone', 'company', 'role', 'tags', 'status', 'notes'];
      return fields.reduce((score, field) => {
        if (record[field]) score += 1;
        return score;
      }, 0);
    }

    function renderCrmCard(record) {
      const id = record.id;
      const displayName = record.name ? safe(record.name) : '(no name)';
      const emailLink = record.email ? `<a href="mailto:${encodeURIComponent(record.email)}" class="text-sky-400 hover:underline">${safe(record.email)}</a>` : '';
      const phoneLink = record.phone ? `<a href="tel:${encodeURIComponent(record.phone)}" class="text-sky-400 hover:underline">${safe(record.phone)}</a>` : '';
      const companyText = record.company ? ` Â· ${safe(record.company)}` : '';
      const roleText = record.role ? ` Â· ${safe(record.role)}` : '';
      const tagsText = record.tags ? `<div class="flex flex-wrap gap-1">${record.tags.split(',').map(tag => tag.trim()).filter(Boolean).map(tag => `<span class="text-xs px-2 py-0.5 rounded bg-white/10">${safe(tag)}</span>`).join('')}</div>` : '';
      const notesText = record.notes ? `<p class="text-sm text-gray-300 whitespace-pre-line">${safe(record.notes)}</p>` : '';
      const stamp = record.updated || record.created;
      const updatedValue = stamp ? `Updated: ${new Date(stamp).toLocaleString()}` : 'Updated: â€”';
      const statusBadge = record.status ? `<span class="text-xs px-2 py-0.5 rounded bg-emerald-700/60 border border-emerald-400/30">${safe(record.status)}</span>` : '';
      const followUp = record.nextFollowUp ? `<span class="text-xs px-2 py-0.5 rounded bg-amber-700/60 border border-amber-400/30">Follow-up ${safe(record.nextFollowUp)}</span>` : '';
      const contactHint = record.email || record.name || '';
      const contactMatch = findContactInWorkspace(record, id);
      const buttonLabel = safe(getContactButtonLabel(record, id));
      const contactTitle = contactMatch
        ? (contactHint
          ? `Open contacts workspace and search for ${contactHint}`
          : 'Open contacts workspace')
        : (contactHint
          ? `Add to contacts workspace and search for ${contactHint}`
          : 'Add to contacts workspace');
      const duplicateInfo = crmDuplicateMetaById.get(id);
      const duplicateBadge = duplicateInfo
        ? `<span class="text-xs px-2 py-0.5 rounded bg-amber-700/60 border border-amber-400/40 text-amber-50">Duplicates Ã—${safe(duplicateInfo.total)}</span>`
        : '';
      const duplicateSection = duplicateInfo ? renderCrmDuplicateSection(record, duplicateInfo) : '';
      const haystackParts = [record.name, record.email, record.company, record.phone, record.role, record.tags, record.status, record.notes];
      if (duplicateInfo) {
        duplicateInfo.records.forEach(item => {
          if (item.id !== id) {
            haystackParts.push(item.name, item.email, item.company, item.phone, item.role, item.tags, item.status, item.notes);
          }
        });
      }
      const haystack = haystackParts.filter(Boolean).join(' ').toLowerCase();
      return `
        <div class="crm-card bg-gray-900/60 border border-white/5 rounded-lg p-4" id="${safeAttr(id)}" data-haystack="${safeAttr(haystack)}" data-created="${safeAttr(record.created || '')}">
          <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
            <div class="space-y-2 md:max-w-xl">
              <div class="flex flex-wrap gap-2 items-center">
                <h3 class="text-lg font-semibold">${displayName}</h3>
                ${statusBadge}
                ${followUp}
                ${duplicateBadge}
              </div>
              <p class="text-sm text-gray-300">${emailLink}${companyText}${roleText}${phoneLink ? ` Â· ${phoneLink}` : ''}</p>
              ${tagsText}
              ${notesText}
              <div class="grid gap-1 text-xs text-gray-400 sm:grid-cols-2">
                <div>Last contacted: ${record.lastContacted ? safe(timeAgo(record.lastContacted)) : 'â€”'}</div>
                <div>Touches: ${safe(typeof record.activityCount === 'number' ? record.activityCount : 0)}</div>
                <div>Next follow-up: ${record.nextFollowUp ? safe(record.nextFollowUp) : 'â€”'}</div>
                <div>${safe(updatedValue)}</div>
              </div>
              ${duplicateSection}
            </div>
            <div class="flex flex-col gap-2 md:w-48">
              <button id="open-contacts-${safeAttr(id)}" onclick="ensureContact('${safeAttr(id)}')" class="bg-teal-600 hover:bg-teal-500 text-white px-3 py-1.5 rounded text-sm" title="${safeAttr(contactTitle)}">${buttonLabel}</button>
              <button onclick="logTouch('${safeAttr(id)}')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded text-sm">Log touch</button>
              <button onclick="quickFollowUp('${safeAttr(id)}')" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded text-sm">+7d follow-up</button>
              <button onclick="editContact('${safeAttr(id)}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-sm">Edit</button>
              <button onclick="deleteContact('${safeAttr(id)}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm">Delete</button>
            </div>
          </div>
        </div>
      `;
    }

    function getCrmDuplicateToggleLabel(meta, expanded) {
      const duplicatesCount = Math.max(0, (meta?.total || 1) - 1);
      if (duplicatesCount === 0) return 'Show duplicates';
      return expanded ? `Hide duplicates (${duplicatesCount})` : `Show duplicates (${duplicatesCount} hidden)`;
    }

    function renderCrmDuplicateSection(record, meta) {
      const expanded = crmDuplicateExpandedState.get(record.id) === true;
      const duplicatesCount = Math.max(0, meta.total - 1);
      const emailDetail = meta.emailSummary && meta.emailSummary.descriptions.length
        ? `${safe(meta.emailSummary.uniqueCount)} email value${meta.emailSummary.uniqueCount === 1 ? '' : 's'} (${meta.emailSummary.descriptions.map(part => safe(part)).join(', ')})`
        : 'No email differences recorded';
      const rows = meta.records.map(item => renderCrmDuplicateRow(item, record.id)).join('');
      return `
        <div class="mt-3 bg-amber-900/30 border border-amber-500/30 rounded-lg p-3 text-amber-50/90">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <p class="text-sm font-semibold">Auto-hidden duplicates</p>
            <button type="button" class="text-xs bg-amber-500/20 hover:bg-amber-500/30 border border-amber-400/40 px-2 py-1 rounded transition" data-crm-duplicate-toggle="${safeAttr(record.id)}" aria-expanded="${expanded ? 'true' : 'false'}">${safe(getCrmDuplicateToggleLabel(meta, expanded))}</button>
          </div>
          <p class="text-xs text-amber-100/80 mt-2">${safe(duplicatesCount)} additional record${duplicatesCount === 1 ? '' : 's'} hidden Â· ${emailDetail}</p>
          <div id="crm-duplicate-panel-${safeAttr(record.id)}" class="mt-3 space-y-2 ${expanded ? '' : 'hidden'}">
            ${rows}
          </div>
        </div>
      `;
    }

    function renderCrmDuplicateRow(record, primaryId) {
      const isPrimary = record.id === primaryId;
      const summaryParts = [];
      if (record.email) summaryParts.push(record.email);
      if (record.phone) summaryParts.push(record.phone);
      const roleCompany = [record.role, record.company].filter(Boolean).join(' @ ');
      if (roleCompany) summaryParts.push(roleCompany);
      if (record.nextFollowUp) summaryParts.push(`Follow-up ${record.nextFollowUp}`);
      if (record.status) summaryParts.push(`Status ${record.status}`);
      const summary = summaryParts.length ? safe(summaryParts.join(' Â· ')) : 'â€”';
      const updatedText = record.updated ? `Updated ${timeAgo(record.updated)}` : 'Updated â€”';
      const badges = [];
      if (isPrimary) badges.push('Shown in list');
      if (record.contactId && record.contactId !== record.id) badges.push('Linked contact');
      const badgeHtml = badges.map(label => `<span class="text-[10px] uppercase tracking-wide bg-white/10 border border-white/20 px-2 py-0.5 rounded">${safe(label)}</span>`).join(' ');
      const actionHtml = isPrimary ? '' : `<button type="button" data-crm-duplicate-open="${safeAttr(record.id)}" class="text-xs bg-gray-800/70 hover:bg-gray-700 border border-white/15 px-2 py-1 rounded">Open details</button>`;
      return `
        <div class="bg-gray-900/50 border border-white/10 rounded-lg p-3 space-y-2">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold text-white/90">${safe(record.name || '(no name)')}</p>
              <p class="text-xs text-gray-300">${summary}</p>
            </div>
            <div class="text-xs text-gray-400 text-right">
              <p>${safe(updatedText)}</p>
              <p>Touches ${safe(typeof record.activityCount === 'number' ? record.activityCount : 0)}</p>
            </div>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="flex flex-wrap gap-1">${badgeHtml}</div>
            ${actionHtml}
          </div>
        </div>
      `;
    }

    function applyCrmDuplicateExpandedState(primaryId) {
      const meta = crmDuplicateMetaById.get(primaryId);
      if (!meta) return;
      const expanded = crmDuplicateExpandedState.get(primaryId) === true;
      const panel = document.getElementById(`crm-duplicate-panel-${primaryId}`);
      const toggle = document.querySelector(`[data-crm-duplicate-toggle="${primaryId}"]`);
      if (panel) {
        panel.classList.toggle('hidden', !expanded);
      }
      if (toggle) {
        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        toggle.textContent = getCrmDuplicateToggleLabel(meta, expanded);
      }
    }

    function toggleCrmDuplicatePanel(primaryId) {
      const meta = crmDuplicateMetaById.get(primaryId);
      if (!meta) return;
      const next = !(crmDuplicateExpandedState.get(primaryId) === true);
      if (next) {
        crmDuplicateExpandedState.set(primaryId, true);
      } else {
        crmDuplicateExpandedState.delete(primaryId);
      }
      applyCrmDuplicateExpandedState(primaryId);
    }

    function wireCrmDuplicateControls(primaryId) {
      const meta = crmDuplicateMetaById.get(primaryId);
      if (!meta) return;
      const toggle = document.querySelector(`[data-crm-duplicate-toggle="${primaryId}"]`);
      if (toggle) {
        toggle.addEventListener('click', evt => {
          evt.stopPropagation();
          toggleCrmDuplicatePanel(primaryId);
        });
      }
      meta.records.forEach(record => {
        if (record.id === primaryId) return;
        const openBtn = document.querySelector(`[data-crm-duplicate-open="${record.id}"]`);
        if (openBtn) {
          openBtn.addEventListener('click', evt => {
            evt.stopPropagation();
            crmDuplicateExpandedState.set(primaryId, true);
            applyCrmDuplicateExpandedState(primaryId);
            openCrmDetail(record.id);
          });
        }
      });
      applyCrmDuplicateExpandedState(primaryId);
    }

    function attachCrmCardInteractions(record) {
      const card = document.getElementById(record.id);
      if (!card) return;
      card.addEventListener('click', evt => {
        if (evt.target.closest('button') || evt.target.closest('a')) return;
        openCrmDetail(record.id);
      });
      card.classList.add('cursor-pointer');
    }

    function applyFocusHighlight() {
      if (!focusContactId) return;
      const cards = list?.querySelectorAll?.('.crm-card') || [];
      cards.forEach(card => {
        focusClasses.forEach(cls => card.classList.remove(cls));
      });
      const targetId = crmDuplicatePrimaryById.get(focusContactId) || focusContactId;
      const card = document.getElementById(targetId);
      if (!card) return;
      focusClasses.forEach(cls => card.classList.add(cls));
      if (targetId !== focusContactId && crmDuplicateMetaById.has(targetId)) {
        crmDuplicateExpandedState.set(targetId, true);
        applyCrmDuplicateExpandedState(targetId);
      }
      if (!focusApplied) {
        focusApplied = true;
        setTimeout(() => {
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }
    }

    async function ensureContact(id) {
      const button = document.getElementById(`open-contacts-${id}`);
      if (!button) return;
      button.disabled = true;
      button.textContent = 'Preparingâ€¦';

      await waitForContactsWorkspace();
      let workspace = contactsWorkspace;
      if (!workspace) {
        button.disabled = false;
        button.textContent = getContactButtonLabel(null, id);
        alert('Contacts workspace is not available right now. Please try again.');
        return;
      }

      button.textContent = 'Checkingâ€¦';
      crmRecords.get(id).once(record => {
        workspace = contactsWorkspace || workspace;
        if (!record || !workspace) {
          button.disabled = false;
          button.textContent = getContactButtonLabel(record, id);
          if (!record) {
            alert('This record is no longer available.');
          } else {
            alert('Contacts workspace is not available right now. Please try again.');
          }
          return;
        }

        const now = new Date().toISOString();
        const crmRecordId = id;
        const existing = findContactInWorkspace(record, id);
        if (existing) {
          button.textContent = 'Openingâ€¦';
          const desiredCrmId = record.id || crmRecordId;
          if (!existing.data || existing.data.crmId !== desiredCrmId) {
            workspace.get(existing.id).put({ crmId: desiredCrmId, syncedFromCrmAt: now });
            if (existing.data) {
              contactWorkspaceIndex[existing.id] = { ...existing.data, crmId: desiredCrmId, syncedFromCrmAt: now };
            }
          }
          crmRecords.get(crmRecordId).put({ contactId: existing.id, syncedToContactsAt: now });
          openContactsWorkspace(existing.id);
          setTimeout(() => {
            button.disabled = false;
            button.textContent = getContactButtonLabel(record, id);
          }, 200);
          return;
        }

        const desiredCrmId = record.id || crmRecordId;
        const contactId = desiredCrmId && !contactWorkspaceIndex[desiredCrmId]
          ? desiredCrmId
          : generateContactId();
        const payload = {
          id: contactId,
          name: record.name || '',
          email: record.email || '',
          phone: record.phone || '',
          company: record.company || '',
          role: record.role || '',
          tags: record.tags || '',
          status: record.status || '',
          nextFollowUp: record.nextFollowUp || '',
          notes: record.notes || '',
          created: record.created || now,
          updated: now,
          lastContacted: record.lastContacted || '',
          activityCount: typeof record.activityCount === 'number' ? record.activityCount : 0,
          crmId: desiredCrmId,
          source: record.source || 'CRM workspace',
          syncedFromCrmAt: now
        };

        button.textContent = 'Addingâ€¦';
        workspace.get(contactId).put(payload, ack => {
          if (ack && ack.err) {
            console.error('Unable to add to contacts workspace', ack.err);
            button.disabled = false;
            button.textContent = getContactButtonLabel(record, id);
            alert('Unable to add this person to contacts right now. Please try again.');
            return;
          }
          contactWorkspaceIndex[contactId] = payload;
          crmRecords.get(crmRecordId).put({ contactId, syncedToContactsAt: now });
          button.textContent = 'Openingâ€¦';
          openContactsWorkspace(contactId);
          setTimeout(() => {
            button.disabled = false;
            button.textContent = getContactButtonLabel(record, id);
          }, 200);
        });
      });
    }

    function findContactInWorkspace(record, keyId) {
      if (!record) return null;
      const directIds = [];
      if (keyId) directIds.push(keyId);
      if (record.id && !directIds.includes(record.id)) directIds.push(record.id);
      if (record.contactId && !directIds.includes(record.contactId)) directIds.push(record.contactId);
      for (const directId of directIds) {
        if (contactWorkspaceIndex[directId]) {
          return { id: directId, data: contactWorkspaceIndex[directId] };
        }
      }

      const crmId = record.id;
      if (crmId) {
        for (const [contactId, data] of Object.entries(contactWorkspaceIndex)) {
          if (data && data.crmId === crmId) {
            return { id: contactId, data };
          }
        }
      }

      const email = normaliseEmail(record.email);
      if (email) {
        for (const [contactId, data] of Object.entries(contactWorkspaceIndex)) {
          if (normaliseEmail(data && data.email) === email) {
            return { id: contactId, data };
          }
        }
      }

      return null;
    }

    function normaliseEmail(value) {
      return (value || '').toString().trim().toLowerCase();
    }

    function generateContactId() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    function openContactsWorkspace(contactId) {
      const url = new URL('../contacts/index.html', window.location.href);
      url.searchParams.set('space', contactsSpaceKey);
      if (contactId) {
        url.searchParams.set('contact', contactId);
      }
      window.location.href = url.toString();
    }

    function editContact(id) {
      const card = document.getElementById(id);
      if (!card) return;
      crmRecords.get(id).once(data => {
        if (!data) return;
        const record = sanitizeRecord(data);
        const statusOptions = ['', 'Lead', 'Prospect', 'Active', 'Negotiating', 'Won', 'Lost'];
        card.innerHTML = `
          <form class="space-y-3" onsubmit="saveEdit(event, '${id}')">
            <div class="grid gap-2 md:grid-cols-2">
              <input id="edit-name-${id}" value="${safeAttr(record.name)}" placeholder="Name" class="w-full p-2 rounded text-black" />
              <input id="edit-email-${id}" value="${safeAttr(record.email)}" placeholder="Email" class="w-full p-2 rounded text-black" />
              <input id="edit-company-${id}" value="${safeAttr(record.company)}" placeholder="Company" class="w-full p-2 rounded text-black" />
              <input id="edit-phone-${id}" value="${safeAttr(record.phone)}" placeholder="Phone" class="w-full p-2 rounded text-black" />
              <input id="edit-role-${id}" value="${safeAttr(record.role)}" placeholder="Role" class="w-full p-2 rounded text-black" />
              <input id="edit-tags-${id}" value="${safeAttr(record.tags)}" placeholder="Tags" class="w-full p-2 rounded text-black" />
              <select id="edit-status-${id}" class="w-full p-2 rounded text-black">
                ${statusOptions.map(status => `<option value="${safeAttr(status)}" ${((record.status || '') === status) ? 'selected' : ''}>${status || 'Status (optional)'}</option>`).join('')}
              </select>
              <input id="edit-next-${id}" type="date" value="${safeAttr((record.nextFollowUp || '').slice(0, 10))}" class="w-full p-2 rounded text-black" />
            </div>
            <textarea id="edit-notes-${id}" class="w-full p-2 rounded text-black" placeholder="Notes">${safe(record.notes)}</textarea>
            <div class="flex gap-2">
              <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded text-sm">Save</button>
              <button type="button" onclick="cancelEdit('${id}')" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-1.5 rounded text-sm">Cancel</button>
            </div>
          </form>
        `;
      });
    }

    function saveEdit(e, id) {
      e.preventDefault();
      const cardEl = document.getElementById(id);
      const created = cardEl && cardEl.dataset ? cardEl.dataset.created : '';
      const current = crmIndex[id] || {};
      const now = new Date().toISOString();
      const updated = {
        ...current,
        id,
        name: document.getElementById(`edit-name-${id}`).value.trim(),
        email: document.getElementById(`edit-email-${id}`).value.trim(),
        company: document.getElementById(`edit-company-${id}`).value.trim(),
        phone: document.getElementById(`edit-phone-${id}`).value.trim(),
        role: document.getElementById(`edit-role-${id}`).value.trim(),
        tags: document.getElementById(`edit-tags-${id}`).value.trim(),
        status: document.getElementById(`edit-status-${id}`).value.trim(),
        nextFollowUp: document.getElementById(`edit-next-${id}`).value.trim(),
        notes: document.getElementById(`edit-notes-${id}`).value.trim(),
        updated: now,
        created: current.created || created || now
      };
      crmRecords.get(id).put(updated);
    }

    function cancelEdit(id) {
      crmRecords.get(id).once(data => {
        if (!data) return;
        const sanitized = sanitizeRecord(data);
        crmIndex[id] = { ...(crmIndex[id] || {}), ...sanitized, id };
        scheduleRender();
      });
    }

    function deleteContact(id) {
      crmRecords.get(id).put(null);
    }

    function logTouch(id) {
      const record = sanitizeRecord(crmIndex[id]);
      if (!record || Object.keys(record).length === 0) return;
      const now = new Date().toISOString();
      const touchesRaw = Number.parseInt(record.activityCount, 10);
      const touches = Number.isNaN(touchesRaw) ? 0 : touchesRaw;
      const next = {
        ...record,
        id,
        contactId: record.contactId || record.id || id,
        lastContacted: now,
        activityCount: touches + 1,
        updated: now,
        created: record.created || now
      };
      crmRecords.get(id).put(next);
    }

    function quickFollowUp(id) {
      const record = sanitizeRecord(crmIndex[id]);
      if (!record || Object.keys(record).length === 0) return;
      const base = record.nextFollowUp ? new Date(record.nextFollowUp) : new Date();
      if (Number.isNaN(base.getTime())) {
        base.setTime(Date.now());
      }
      base.setDate(base.getDate() + 7);
      const now = new Date().toISOString();
      const next = {
        ...record,
        id,
        contactId: record.contactId || record.id || id,
        nextFollowUp: base.toISOString().slice(0, 10),
        updated: now,
        created: record.created || now
      };
      crmRecords.get(id).put(next);
    }

    function applyFilter() {
      const query = ((filterInput && filterInput.value) || '').toLowerCase().trim();
      const cards = Array.from(list.querySelectorAll('[data-haystack]'));
      let visible = 0;
      cards.forEach(card => {
        const haystack = card.dataset.haystack || '';
        const hidden = query && !haystack.includes(query);
        card.classList.toggle('hidden', hidden);
        if (!hidden) visible++;
      });
      updateCounts(Object.keys(crmIndex).length, visible);
      updateDuplicateSummary();
      applyFocusHighlight();
    }

    function updateCounts(total, visible) {
      if (totalCountEl) totalCountEl.textContent = total;
      if (visibleCountEl) visibleCountEl.textContent = visible;
      if (!emptyState) return;
      if (total === 0) {
        emptyState.textContent = 'No contacts yet. Add someone from the form or sync from the contacts app.';
        emptyState.classList.remove('hidden');
      } else if (visible === 0) {
        emptyState.textContent = 'No contacts match your filter yet.';
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }
    }

    function computeDuplicateGroups(records) {
      const groups = new Map();
      records.forEach(record => {
        const rawName = (record.name || '').trim();
        const key = rawName.toLowerCase() || '__no_name__';
        const display = rawName || '(no name)';
        if (!groups.has(key)) {
          groups.set(key, { name: display, items: [] });
        } else if (display !== '(no name)' && groups.get(key).name === '(no name)') {
          groups.get(key).name = display;
        }
        groups.get(key).items.push(record);
      });
      return Array.from(groups.values())
        .filter(group => group.items.length > 1)
        .sort((a, b) => b.items.length - a.items.length);
    }

    function describeEmailDifferences(items) {
      const stats = new Map();
      let missing = 0;
      items.forEach(record => {
        const email = (record.email || '').trim();
        if (email) {
          const key = email.toLowerCase();
          if (!stats.has(key)) {
            stats.set(key, { label: email, count: 0 });
          }
          stats.get(key).count += 1;
        } else {
          missing += 1;
        }
      });
      const parts = Array.from(stats.values())
        .sort((a, b) => b.count - a.count)
        .map(part => `${part.label}Ã—${part.count}`);
      if (missing) {
        parts.push(`(no email)Ã—${missing}`);
      }
      return {
        uniqueCount: stats.size + (missing ? 1 : 0),
        descriptions: parts
      };
    }

    function updateDuplicateSummary() {
      if (!duplicateSummaryEl) return;
      const groups = computeDuplicateGroups(Object.values(crmIndex));
      if (groups.length === 0) {
        duplicateSummaryEl.classList.add('hidden');
        duplicateSummaryEl.innerHTML = '';
        return;
      }

      const totalFlagged = groups.reduce((sum, group) => sum + group.items.length, 0);
      const maxGroups = 5;
      const displayGroups = groups.slice(0, maxGroups);
      const listItems = displayGroups.map(group => {
        const emailSummary = describeEmailDifferences(group.items);
        const label = `${group.items.length} record${group.items.length === 1 ? '' : 's'}`;
        const emailDetail = emailSummary.descriptions.length
          ? ` Â· ${emailSummary.uniqueCount} email value${emailSummary.uniqueCount === 1 ? '' : 's'} (${emailSummary.descriptions.map(part => safe(part)).join(', ')})`
          : '';
        return `<li class="list-disc list-inside">${safe(group.name)} â€” ${safe(label)}${emailDetail}</li>`;
      }).join('');

      const moreGroups = groups.length - displayGroups.length;
      const moreNote = moreGroups > 0
        ? `<li class="list-disc list-inside text-xs text-amber-200/80">+${moreGroups} more group${moreGroups === 1 ? '' : 's'} with duplicates</li>`
        : '';

      duplicateSummaryEl.classList.remove('hidden');
      duplicateSummaryEl.innerHTML = `
        <p class="text-xs uppercase tracking-[0.32em] text-amber-200/70">Possible duplicates</p>
        <p class="text-xs text-amber-100/80 mt-1">${safe(groups.length)} group${groups.length === 1 ? '' : 's'} covering ${safe(totalFlagged)} record${totalFlagged === 1 ? '' : 's'}.</p>
        <ul class="mt-2 space-y-1 text-sm text-amber-100/90">${listItems}${moreNote}</ul>
      `;
    }

    function openCrmDetail(id) {
      const record = crmIndex[id];
      if (!record) return;
      const summary = [];
      if (record.email) {
        summary.push(`<a class="underline hover:no-underline" href="mailto:${encodeURIComponent(record.email)}">${safe(record.email)}</a>`);
      }
      if (record.role) {
        summary.push(safe(record.role));
      }
      if (record.company) {
        summary.push(safe(record.company));
      }
      if (record.phone) {
        summary.push(`<a class="underline hover:no-underline" href="tel:${encodeURIComponent(record.phone)}">${safe(record.phone)}</a>`);
      }

      crmDetailName.textContent = record.name ? record.name : '(no name)';
      crmDetailSummary.innerHTML = summary.join(' Â· ') || 'â€”';

      if (record.tags) {
        const tagHtml = record.tags.split(',').map(tag => tag.trim()).filter(Boolean)
          .map(tag => `<span class="text-xs px-2 py-0.5 rounded bg-white/10">${safe(tag)}</span>`).join(' ');
        crmDetailTags.innerHTML = `<div class="flex flex-wrap gap-1">${tagHtml}</div>`;
        crmDetailTags.classList.remove('hidden');
      } else {
        crmDetailTags.classList.add('hidden');
        crmDetailTags.innerHTML = '';
      }

      if (record.notes) {
        crmDetailNotes.innerHTML = `<div class="bg-gray-800/70 border border-white/10 rounded-lg p-3 text-sm text-gray-200 whitespace-pre-wrap">${safe(record.notes)}</div>`;
        crmDetailNotes.classList.remove('hidden');
      } else {
        crmDetailNotes.classList.add('hidden');
        crmDetailNotes.innerHTML = '';
      }

      const metaRows = [
        ['Status', record.status || 'â€”'],
        ['Next follow-up', record.nextFollowUp || 'â€”'],
        ['Last contacted', record.lastContacted ? `${timeAgo(record.lastContacted)} Â· ${new Date(record.lastContacted).toLocaleString()}` : 'â€”'],
        ['Touches', typeof record.activityCount === 'number' ? record.activityCount : 0],
        ['Created', record.created ? new Date(record.created).toLocaleString() : 'â€”'],
        ['Updated', record.updated ? new Date(record.updated).toLocaleString() : 'â€”']
      ];
      crmDetailMeta.innerHTML = metaRows.map(([label, value]) => `
        <div class="flex justify-between gap-3">
          <span class="text-gray-400">${safe(label)}</span>
          <span class="font-medium text-white/90 text-right">${safe(value)}</span>
        </div>
      `).join('');

      const workspaceMatch = findWorkspaceContact(record);
      const detailButtonLabel = getContactButtonLabel(record, id);
      if (workspaceMatch) {
        const wsSummary = [];
        if (workspaceMatch.email) wsSummary.push(workspaceMatch.email);
        if (workspaceMatch.company) wsSummary.push(workspaceMatch.company);
        crmDetailWorkspace.innerHTML = `
          <div class="bg-teal-900/40 border border-teal-500/30 rounded-lg p-4">
            <p class="text-sm font-semibold text-teal-200">Linked contacts workspace entry</p>
            <p class="text-xs text-teal-100/80 mt-1">${safe(workspaceMatch.name || '(no name)')}</p>
            ${wsSummary.length ? `<p class="text-xs text-teal-100/70 mt-2">${safe(wsSummary.join(' Â· '))}</p>` : ''}
          </div>
        `;
      } else {
        crmDetailWorkspace.innerHTML = `
          <div class="bg-gray-800/80 border border-white/10 rounded-lg p-4">
            <p class="text-sm font-semibold text-gray-100">No linked contact yet</p>
            <p class="text-xs text-gray-400 mt-1">Use "${CONTACT_BUTTON_ADD_LABEL}" to find or create a matching person.</p>
          </div>
        `;
      }

      crmDetailActions.innerHTML = `
        <button id="crm-detail-open-${id}" class="bg-teal-600 hover:bg-teal-500 text-white text-sm px-3 py-1.5 rounded">${detailButtonLabel}</button>
        <button id="crm-detail-touch-${id}" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm px-3 py-1.5 rounded">Log touch</button>
        <button id="crm-detail-follow-${id}" class="bg-amber-500 hover:bg-amber-600 text-white text-sm px-3 py-1.5 rounded">+7d follow-up</button>
        <button id="crm-detail-edit-${id}" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-3 py-1.5 rounded">Edit</button>
        <button id="crm-detail-delete-${id}" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1.5 rounded">Delete</button>
      `;

      const ensureId = record.contactId || id;
      document.getElementById(`crm-detail-open-${id}`)?.addEventListener('click', () => {
        ensureContact(ensureId);
        closeCrmDetail();
      });
      document.getElementById(`crm-detail-touch-${id}`)?.addEventListener('click', () => {
        logTouch(id);
        setTimeout(() => openCrmDetail(id), 120);
      });
      document.getElementById(`crm-detail-follow-${id}`)?.addEventListener('click', () => {
        quickFollowUp(id);
        setTimeout(() => openCrmDetail(id), 120);
      });
      document.getElementById(`crm-detail-edit-${id}`)?.addEventListener('click', () => {
        closeCrmDetail();
        editContact(id);
      });
      document.getElementById(`crm-detail-delete-${id}`)?.addEventListener('click', () => {
        if (confirm('Delete this CRM record?')) {
          closeCrmDetail();
          deleteContact(id);
        }
      });

      crmDetailOverlay.classList.remove('hidden');
      crmDetailOverlay.scrollTop = 0;
    }

    function closeCrmDetail() {
      crmDetailOverlay.classList.add('hidden');
    }

    function findWorkspaceContact(record) {
      if (!record) return null;
      const directId = record.contactId || record.id;
      if (directId && contactWorkspaceIndex[directId]) {
        return contactWorkspaceIndex[directId];
      }
      if (record.email) {
        const email = record.email.toLowerCase();
        return Object.values(contactWorkspaceIndex).find(entry => (entry.email || '').toLowerCase() === email) || null;
      }
      return null;
    }

    closeCrmDetailBtn.addEventListener('click', closeCrmDetail);
    crmDetailOverlay.addEventListener('click', evt => {
      if (evt.target === crmDetailOverlay) closeCrmDetail();
    });
    document.addEventListener('keydown', evt => {
      if (evt.key === 'Escape' && !crmDetailOverlay.classList.contains('hidden')) {
        closeCrmDetail();
      }
    });

    if (filterInput) {
      filterInput.addEventListener('input', applyFilter);
    }

    function timeAgo(iso) {
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return 'â€”';
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 30) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    function safe(value) {
      return String(value == null ? '' : value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function safeAttr(value) {
      return safe(value).replace(/"/g, '&quot;');
    }

    applyFilter();
  </script>
</body>
</html>
