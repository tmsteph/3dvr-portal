<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3DVR CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://fav.farm/ðŸ§ " />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">
  <header class="bg-gray-950/70 border-b border-white/10">
    <div class="max-w-5xl mx-auto px-4 py-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="text-xs font-semibold tracking-[0.32em] text-teal-400 uppercase">Sales toolkit</p>
        <h1 class="text-3xl font-bold">3DVR CRM</h1>
        <p class="text-sm text-gray-300">Log deal progress, then jump into contacts and training without losing context.</p>
        <p class="text-xs text-gray-400 mt-2">This workspace is shared so the whole team can see who has been contacted and when.</p>
      </div>
      <nav class="flex flex-wrap gap-2 text-sm">
        <a href="../sales/index.html" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded transition">Sales home</a>
        <a href="../sales/training/" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded transition">Training playbook</a>
        <a href="../contacts/index.html" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded transition">Contacts workspace</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <section class="grid gap-4 md:grid-cols-2">
      <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-2">Shared context</h2>
        <p class="text-sm text-gray-300">This CRM uses the same 3DVR GUN relay as the contacts workspace. Tag people the same way so both apps stay aligned.</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <a href="../contacts/index.html" class="bg-teal-600 hover:bg-teal-500 text-white px-3 py-2 rounded">Open contacts</a>
          <a href="../sales/training/" class="bg-sky-600 hover:bg-sky-500 text-white px-3 py-2 rounded">Review training</a>
        </div>
      </div>
      <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-2">Deal pulse</h2>
        <p class="text-sm text-gray-300">Track how many records you have overall versus what is visible after filtering.</p>
        <div class="mt-4 grid grid-cols-2 gap-3 text-center text-sm text-gray-300">
          <div class="bg-gray-900/60 border border-white/5 rounded-lg py-3">
            <div class="text-2xl font-semibold" id="totalCount">0</div>
            <div>Total records</div>
          </div>
          <div class="bg-gray-900/60 border border-white/5 rounded-lg py-3">
            <div class="text-2xl font-semibold" id="visibleCount">0</div>
            <div>Visible now</div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-[320px,1fr]">
      <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
        <h2 class="text-xl font-semibold mb-3">Add contact</h2>
        <form id="contactForm" class="grid gap-2">
          <input type="text" id="name" placeholder="Name" class="w-full p-2 rounded text-black" />
          <input type="email" id="email" placeholder="Email" class="w-full p-2 rounded text-black" />
          <input type="text" id="role" placeholder="Role (client, lead...)" class="w-full p-2 rounded text-black" />
          <input type="text" id="tags" placeholder="Tags (comma separated)" class="w-full p-2 rounded text-black" />
          <textarea id="notes" placeholder="Notes" class="w-full p-2 rounded text-black"></textarea>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Save</button>
        </form>
      </div>
      <div class="space-y-6">
        <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
          <label for="filter" class="block text-sm text-gray-300 mb-2">Search workspace</label>
          <input id="filter" type="search" placeholder="Filter by name, email, tags, or notes" class="w-full p-2 rounded text-black" />
        </div>
        <div class="bg-gray-800/60 border border-white/10 rounded-xl p-5">
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
            <h2 class="text-xl font-semibold">Contacts</h2>
            <span class="text-xs uppercase tracking-[0.32em] text-gray-400">Live</span>
          </div>
          <div id="contactList" class="space-y-4"></div>
          <div id="emptyState" class="text-sm text-gray-400 hidden">No contacts yet. Add someone from the form or sync from the contacts app.</div>
        </div>
      </div>
    </section>
  </main>

  <div id="crmDetailOverlay" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm px-4 py-8 overflow-y-auto">
    <div id="crmDetailCard" class="max-w-3xl mx-auto bg-gray-900/95 border border-white/10 rounded-2xl shadow-2xl p-6 relative">
      <button id="closeCrmDetail" type="button" class="absolute top-4 right-4 text-sm text-gray-300 hover:text-white">Close</button>
      <div class="space-y-5">
        <div class="space-y-1">
          <p class="text-xs uppercase tracking-[0.32em] text-sky-300">CRM record</p>
          <h2 id="crmDetailName" class="text-2xl font-semibold">Name</h2>
          <p id="crmDetailSummary" class="text-sm text-gray-300">Summary</p>
        </div>
        <div id="crmDetailTags" class="hidden"></div>
        <div id="crmDetailNotes" class="hidden"></div>
        <div id="crmDetailMeta" class="grid gap-2 text-sm text-gray-300"></div>
        <div id="crmDetailWorkspace" class="text-sm text-gray-300"></div>
        <div id="crmDetailActions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <script>
    const gun = Gun({
      peers: ['https://gun-relay-3dvr.fly.dev/gun'],
      localStorage: false,
      radisk: false
    });

    const crmRecords = gun.get('3dvr-crm');
    const contactsWorkspace = gun.get('contacts-public');
    const form = document.getElementById('contactForm');
    const list = document.getElementById('contactList');
    const filterInput = document.getElementById('filter');
    const totalCountEl = document.getElementById('totalCount');
    const visibleCountEl = document.getElementById('visibleCount');
    const emptyState = document.getElementById('emptyState');
    const params = new URLSearchParams(window.location.search);
    const focusContactId = params.get('contact');
    let focusApplied = false;
    const focusClasses = ['ring-2', 'ring-sky-400', 'ring-offset-2', 'ring-offset-gray-900'];
    const contactWorkspaceIndex = {};
    const crmIndex = {};
    const crmDetailOverlay = document.getElementById('crmDetailOverlay');
    const crmDetailName = document.getElementById('crmDetailName');
    const crmDetailSummary = document.getElementById('crmDetailSummary');
    const crmDetailTags = document.getElementById('crmDetailTags');
    const crmDetailNotes = document.getElementById('crmDetailNotes');
    const crmDetailMeta = document.getElementById('crmDetailMeta');
    const crmDetailWorkspace = document.getElementById('crmDetailWorkspace');
    const crmDetailActions = document.getElementById('crmDetailActions');
    const closeCrmDetailBtn = document.getElementById('closeCrmDetail');

    contactsWorkspace.map().on((data, contactId) => {
      if (!contactId) return;
      if (!data) {
        delete contactWorkspaceIndex[contactId];
        return;
      }
      contactWorkspaceIndex[contactId] = { ...(contactWorkspaceIndex[contactId] || {}), ...data, id: contactId };
    });

    form.onsubmit = e => {
      e.preventDefault();
      const id = Date.now().toString();
      const contact = {
        id,
        contactId: id,
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        role: form.role.value.trim(),
        tags: form.tags.value.trim(),
        notes: form.notes.value.trim(),
        created: new Date().toISOString(),
        updated: new Date().toISOString()
      };
      crmRecords.get(id).put(contact);
      form.reset();
    };

    crmRecords.map().on((data, id) => {
      if (!data) {
        delete crmIndex[id];
        const existing = document.getElementById(id);
        if (existing) existing.remove();
        applyFilter();
        return;
      }

      crmIndex[id] = { ...(crmIndex[id] || {}), ...data, id };
      let card = document.getElementById(id);
      if (!card) {
        card = document.createElement('div');
        card.id = id;
        card.className = 'bg-gray-900/60 border border-white/5 rounded-lg p-4';
        list.appendChild(card);
      }

      renderCard(card, data, id);
      applyFilter();
    });

    function renderCard(card, data, id) {
      const displayName = data.name ? safe(data.name) : '(no name)';
      const emailLink = data.email ? `<a href="mailto:${encodeURIComponent(data.email)}" class="text-sky-400 hover:underline">${safe(data.email)}</a>` : '';
      const roleText = data.role ? ` Â· ${safe(data.role)}` : '';
      const tagsText = data.tags ? `<p class="text-xs uppercase tracking-[0.3em] text-gray-400">${safe(data.tags)}</p>` : '';
      const notesText = data.notes ? `<p class="text-sm text-gray-300 whitespace-pre-line">${safe(data.notes)}</p>` : '';
      const stamp = data.updated || data.created;
      const updatedText = stamp ? `<p class="text-xs text-gray-500">Updated ${new Date(stamp).toLocaleString()}</p>` : '';
      const contactHint = data.email || data.name || '';
      const contactTitle = contactHint ? `Open contacts workspace and search for ${contactHint}` : 'Open contacts workspace';

      card.innerHTML = `
        <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
          <div class="space-y-2">
            <h3 class="text-lg font-semibold">${displayName}</h3>
            <p class="text-sm text-gray-300">${emailLink}${roleText}</p>
            ${tagsText}
            ${notesText}
            ${updatedText}
          </div>
          <div class="flex flex-col gap-2 md:w-40">
            <button id="open-contacts-${id}" onclick="ensureContact('${id}')" class="bg-teal-600 hover:bg-teal-500 text-white px-3 py-1.5 rounded text-sm" title="${safeAttr(contactTitle)}">Open in contacts</button>
            <button onclick="editContact('${id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-sm">Edit</button>
            <button onclick="deleteContact('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm">Delete</button>
          </div>
        </div>
      `;

      card.dataset.haystack = [data.name, data.email, data.role, data.tags, data.notes].filter(Boolean).join(' ').toLowerCase();
      card.dataset.created = data.created || '';
      card.classList.remove('hidden');
      if (focusContactId && id === focusContactId) {
        focusClasses.forEach(cls => card.classList.add(cls));
        if (!focusApplied) {
          setTimeout(() => {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
          focusApplied = true;
        }
      } else {
        focusClasses.forEach(cls => card.classList.remove(cls));
      }

      card.onclick = e => {
        if (e.target.closest('button') || e.target.closest('a')) return;
        openCrmDetail(id);
      };
      card.classList.add('cursor-pointer');
    }

    function ensureContact(id) {
      const button = document.getElementById(`open-contacts-${id}`);
      if (!button) return;
      button.disabled = true;
      button.textContent = 'Checkingâ€¦';

      crmRecords.get(id).once(record => {
        if (!record) {
          button.disabled = false;
          button.textContent = 'Open in contacts';
          alert('This record is no longer available.');
          return;
        }

        const now = new Date().toISOString();
        const crmRecordId = id;
        const existing = findContactInWorkspace(record, id);
        if (existing) {
          button.textContent = 'Openingâ€¦';
          const desiredCrmId = record.id || crmRecordId;
          if (!existing.data || existing.data.crmId !== desiredCrmId) {
            contactsWorkspace.get(existing.id).put({ crmId: desiredCrmId, syncedFromCrmAt: now });
            if (existing.data) {
              contactWorkspaceIndex[existing.id] = { ...existing.data, crmId: desiredCrmId, syncedFromCrmAt: now };
            }
          }
          crmRecords.get(crmRecordId).put({ contactId: existing.id, syncedToContactsAt: now });
          openContactsWorkspace(existing.id);
          setTimeout(() => {
            button.disabled = false;
            button.textContent = 'Open in contacts';
          }, 200);
          return;
        }

        const desiredCrmId = record.id || crmRecordId;
        const contactId = desiredCrmId && !contactWorkspaceIndex[desiredCrmId]
          ? desiredCrmId
          : generateContactId();
        const payload = {
          id: contactId,
          name: record.name || '',
          email: record.email || '',
          phone: record.phone || '',
          company: record.company || '',
          role: record.role || '',
          tags: record.tags || '',
          status: record.status || '',
          nextFollowUp: record.nextFollowUp || '',
          notes: record.notes || '',
          created: record.created || now,
          updated: now,
          lastContacted: record.lastContacted || '',
          activityCount: typeof record.activityCount === 'number' ? record.activityCount : 0,
          crmId: desiredCrmId,
          source: record.source || 'CRM workspace',
          syncedFromCrmAt: now
        };

        button.textContent = 'Addingâ€¦';
        contactsWorkspace.get(contactId).put(payload, ack => {
          if (ack && ack.err) {
            console.error('Unable to add to contacts workspace', ack.err);
            button.disabled = false;
            button.textContent = 'Open in contacts';
            alert('Unable to add this person to contacts right now. Please try again.');
            return;
          }
          contactWorkspaceIndex[contactId] = payload;
          crmRecords.get(crmRecordId).put({ contactId, syncedToContactsAt: now });
          button.textContent = 'Openingâ€¦';
          openContactsWorkspace(contactId);
          setTimeout(() => {
            button.disabled = false;
            button.textContent = 'Open in contacts';
          }, 200);
        });
      });
    }

    function findContactInWorkspace(record, keyId) {
      if (!record) return null;
      const directIds = [];
      if (keyId) directIds.push(keyId);
      if (record.id && !directIds.includes(record.id)) directIds.push(record.id);
      if (record.contactId && !directIds.includes(record.contactId)) directIds.push(record.contactId);
      for (const directId of directIds) {
        if (contactWorkspaceIndex[directId]) {
          return { id: directId, data: contactWorkspaceIndex[directId] };
        }
      }

      const crmId = record.id;
      if (crmId) {
        for (const [contactId, data] of Object.entries(contactWorkspaceIndex)) {
          if (data && data.crmId === crmId) {
            return { id: contactId, data };
          }
        }
      }

      const email = normaliseEmail(record.email);
      if (email) {
        for (const [contactId, data] of Object.entries(contactWorkspaceIndex)) {
          if (normaliseEmail(data && data.email) === email) {
            return { id: contactId, data };
          }
        }
      }

      return null;
    }

    function normaliseEmail(value) {
      return (value || '').toString().trim().toLowerCase();
    }

    function generateContactId() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    function openContactsWorkspace(contactId) {
      const url = new URL('../contacts/index.html', window.location.href);
      url.searchParams.set('space', 'public-demo');
      url.searchParams.set('contact', contactId);
      window.location.href = url.toString();
    }

    function editContact(id) {
      const card = document.getElementById(id);
      if (!card) return;
      crmRecords.get(id).once(data => {
        if (!data) return;
        card.innerHTML = `
          <form class="space-y-3" onsubmit="saveEdit(event, '${id}')">
            <input id="edit-name-${id}" value="${safeAttr(data.name)}" placeholder="Name" class="w-full p-2 rounded text-black" />
            <input id="edit-email-${id}" value="${safeAttr(data.email)}" placeholder="Email" class="w-full p-2 rounded text-black" />
            <input id="edit-role-${id}" value="${safeAttr(data.role)}" placeholder="Role" class="w-full p-2 rounded text-black" />
            <input id="edit-tags-${id}" value="${safeAttr(data.tags)}" placeholder="Tags" class="w-full p-2 rounded text-black" />
            <textarea id="edit-notes-${id}" class="w-full p-2 rounded text-black" placeholder="Notes">${safe(data.notes)}</textarea>
            <div class="flex gap-2">
              <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded text-sm">Save</button>
              <button type="button" onclick="cancelEdit('${id}')" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-1.5 rounded text-sm">Cancel</button>
            </div>
          </form>
        `;
      });
    }

    function saveEdit(e, id) {
      e.preventDefault();
      const cardEl = document.getElementById(id);
      const created = cardEl && cardEl.dataset ? cardEl.dataset.created : '';
      const updated = {
        id,
        name: document.getElementById(`edit-name-${id}`).value.trim(),
        email: document.getElementById(`edit-email-${id}`).value.trim(),
        role: document.getElementById(`edit-role-${id}`).value.trim(),
        tags: document.getElementById(`edit-tags-${id}`).value.trim(),
        notes: document.getElementById(`edit-notes-${id}`).value.trim(),
        updated: new Date().toISOString(),
        created: created || new Date().toISOString()
      };
      crmRecords.get(id).put(updated);
    }

    function cancelEdit(id) {
      crmRecords.get(id).once(data => {
        if (!data) return;
        const card = document.getElementById(id);
        if (card) {
          renderCard(card, data, id);
          applyFilter();
        }
      });
    }

    function deleteContact(id) {
      crmRecords.get(id).put(null);
      const card = document.getElementById(id);
      if (card) card.remove();
      applyFilter();
    }

    function applyFilter() {
      const query = ((filterInput && filterInput.value) || '').toLowerCase().trim();
      const cards = Array.from(list.querySelectorAll('[data-haystack]'));
      let visible = 0;
      cards.forEach(card => {
        const haystack = card.dataset.haystack || '';
        const hidden = query && !haystack.includes(query);
        card.classList.toggle('hidden', hidden);
        if (!hidden) visible++;
      });
      updateCounts(cards.length, visible);
    }

    function updateCounts(total, visible) {
      if (totalCountEl) totalCountEl.textContent = total;
      if (visibleCountEl) visibleCountEl.textContent = visible;
      if (!emptyState) return;
      if (total === 0) {
        emptyState.textContent = 'No contacts yet. Add someone from the form or sync from the contacts app.';
        emptyState.classList.remove('hidden');
      } else if (visible === 0) {
        emptyState.textContent = 'No contacts match your filter yet.';
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }
    }

    function openCrmDetail(id) {
      const record = crmIndex[id];
      if (!record) return;
      const summary = [];
      if (record.email) {
        summary.push(`<a class="underline hover:no-underline" href="mailto:${encodeURIComponent(record.email)}">${safe(record.email)}</a>`);
      }
      if (record.role) {
        summary.push(safe(record.role));
      }

      crmDetailName.textContent = record.name ? record.name : '(no name)';
      crmDetailSummary.innerHTML = summary.join(' Â· ') || 'â€”';

      if (record.tags) {
        const tagHtml = record.tags.split(',').map(tag => tag.trim()).filter(Boolean)
          .map(tag => `<span class="text-xs px-2 py-0.5 rounded bg-white/10">${safe(tag)}</span>`).join(' ');
        crmDetailTags.innerHTML = `<div class="flex flex-wrap gap-1">${tagHtml}</div>`;
        crmDetailTags.classList.remove('hidden');
      } else {
        crmDetailTags.classList.add('hidden');
        crmDetailTags.innerHTML = '';
      }

      if (record.notes) {
        crmDetailNotes.innerHTML = `<div class="bg-gray-800/70 border border-white/10 rounded-lg p-3 text-sm text-gray-200 whitespace-pre-wrap">${safe(record.notes)}</div>`;
        crmDetailNotes.classList.remove('hidden');
      } else {
        crmDetailNotes.classList.add('hidden');
        crmDetailNotes.innerHTML = '';
      }

      const metaRows = [
        ['Created', record.created ? new Date(record.created).toLocaleString() : 'â€”'],
        ['Updated', record.updated ? new Date(record.updated).toLocaleString() : 'â€”']
      ];
      crmDetailMeta.innerHTML = metaRows.map(([label, value]) => `
        <div class="flex justify-between gap-3">
          <span class="text-gray-400">${safe(label)}</span>
          <span class="font-medium text-white/90 text-right">${safe(value)}</span>
        </div>
      `).join('');

      const workspaceMatch = findWorkspaceContact(record);
      if (workspaceMatch) {
        const wsSummary = [];
        if (workspaceMatch.email) wsSummary.push(workspaceMatch.email);
        if (workspaceMatch.company) wsSummary.push(workspaceMatch.company);
        crmDetailWorkspace.innerHTML = `
          <div class="bg-teal-900/40 border border-teal-500/30 rounded-lg p-4">
            <p class="text-sm font-semibold text-teal-200">Linked contacts workspace entry</p>
            <p class="text-xs text-teal-100/80 mt-1">${safe(workspaceMatch.name || '(no name)')}</p>
            ${wsSummary.length ? `<p class="text-xs text-teal-100/70 mt-2">${safe(wsSummary.join(' Â· '))}</p>` : ''}
          </div>
        `;
      } else {
        crmDetailWorkspace.innerHTML = `
          <div class="bg-gray-800/80 border border-white/10 rounded-lg p-4">
            <p class="text-sm font-semibold text-gray-100">No linked contact yet</p>
            <p class="text-xs text-gray-400 mt-1">Use "Open in contacts" to find or create a matching person.</p>
          </div>
        `;
      }

      crmDetailActions.innerHTML = `
        <button id="crm-detail-open-${id}" class="bg-teal-600 hover:bg-teal-500 text-white text-sm px-3 py-1.5 rounded">Open in contacts</button>
        <button id="crm-detail-edit-${id}" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-3 py-1.5 rounded">Edit</button>
        <button id="crm-detail-delete-${id}" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1.5 rounded">Delete</button>
      `;

      const ensureId = record.contactId || id;
      document.getElementById(`crm-detail-open-${id}`)?.addEventListener('click', () => {
        ensureContact(ensureId);
        closeCrmDetail();
      });
      document.getElementById(`crm-detail-edit-${id}`)?.addEventListener('click', () => {
        closeCrmDetail();
        editContact(id);
      });
      document.getElementById(`crm-detail-delete-${id}`)?.addEventListener('click', () => {
        if (confirm('Delete this CRM record?')) {
          closeCrmDetail();
          deleteContact(id);
        }
      });

      crmDetailOverlay.classList.remove('hidden');
      crmDetailOverlay.scrollTop = 0;
    }

    function closeCrmDetail() {
      crmDetailOverlay.classList.add('hidden');
    }

    function findWorkspaceContact(record) {
      if (!record) return null;
      const directId = record.contactId || record.id;
      if (directId && contactWorkspaceIndex[directId]) {
        return contactWorkspaceIndex[directId];
      }
      if (record.email) {
        const email = record.email.toLowerCase();
        return Object.values(contactWorkspaceIndex).find(entry => (entry.email || '').toLowerCase() === email) || null;
      }
      return null;
    }

    closeCrmDetailBtn.addEventListener('click', closeCrmDetail);
    crmDetailOverlay.addEventListener('click', evt => {
      if (evt.target === crmDetailOverlay) closeCrmDetail();
    });
    document.addEventListener('keydown', evt => {
      if (evt.key === 'Escape' && !crmDetailOverlay.classList.contains('hidden')) {
        closeCrmDetail();
      }
    });

    if (filterInput) {
      filterInput.addEventListener('input', applyFilter);
    }

    function safe(value) {
      return String(value == null ? '' : value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function safeAttr(value) {
      return safe(value).replace(/"/g, '&quot;');
    }

    applyFilter();
  </script>
</body>
</html>
