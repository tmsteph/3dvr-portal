<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mindfulness Breathing Room | 3DVR Portal</title>
  <link rel="stylesheet" href="styles/global.css">
  <style>
    :root {
      color-scheme: dark;
      --cycle-duration: 14000ms;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at 20% 20%, rgba(58, 180, 242, 0.2), transparent 60%),
        radial-gradient(circle at 80% 30%, rgba(94, 234, 212, 0.18), transparent 55%),
        #05070c;
      color: #f8fafc;
      overflow: hidden;
    }
    body::before,
    body::after {
      content: '';
      position: fixed;
      width: 520px;
      height: 520px;
      border-radius: 50%;
      filter: blur(120px);
      opacity: 0.55;
      pointer-events: none;
      z-index: 0;
    }
    body::before {
      top: -200px;
      left: -160px;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.55), transparent 65%);
      animation: breatheGlow var(--cycle-duration) ease-in-out infinite;
    }
    body::after {
      bottom: -220px;
      right: -160px;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.55), transparent 65%);
      animation: breatheGlow var(--cycle-duration) ease-in-out infinite reverse;
    }
    .session-shell {
      position: relative;
      z-index: 1;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 24px 64px;
      gap: 36px;
    }
    header {
      text-align: center;
      max-width: 720px;
    }
    header p {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.24em;
      color: rgba(226, 232, 240, 0.65);
      font-size: 0.85rem;
    }
    header h1 {
      margin: 14px 0 12px;
      font-size: clamp(2.25rem, 5vw, 3.2rem);
      letter-spacing: -0.04em;
    }
    header span {
      display: inline-block;
      margin-top: 8px;
      color: rgba(226, 232, 240, 0.75);
      font-size: 1.05rem;
      line-height: 1.7;
    }
    .breathing-space {
      position: relative;
      width: clamp(320px, 38vw, 760px);
      height: clamp(320px, 38vw, 760px);
      border-radius: 40px;
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.8), rgba(17, 24, 39, 0.65));
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 40px 120px rgba(8, 15, 35, 0.55);
      backdrop-filter: blur(18px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px;
      overflow: hidden;
    }
    .breathing-space::before {
      content: '';
      position: absolute;
      inset: 16px;
      border-radius: 28px;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.18) 0%, rgba(12, 19, 33, 0.6) 65%);
      animation: breathePulse calc(var(--cycle-duration) * 0.75) ease-in-out infinite;
    }
    .count-display {
      position: absolute;
      top: 38px;
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(1.35rem, 3vw, 2.1rem);
      letter-spacing: 0.24em;
      font-weight: 500;
      color: rgba(226, 232, 240, 0.7);
      pointer-events: none;
      opacity: 0.8;
      transition: opacity 0.4s ease;
    }
    .count-display__value {
      display: inline-block;
      opacity: 0.85;
      transform: translateY(0);
    }
    .count-display__value.is-ticking {
      animation: countTick 1s cubic-bezier(0.4, 0, 0.2, 1) both;
    }
    .breath-circle {
      position: relative;
      width: clamp(200px, 22vw, 360px);
      height: clamp(200px, 22vw, 360px);
      border-radius: 50%;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.35), rgba(37, 99, 235, 0.22));
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      transform: scale(var(--target-scale, 1));
      transition: transform var(--transition-duration, 2400ms) cubic-bezier(0.45, 0, 0.55, 1),
        background 0.8s ease, box-shadow 0.8s ease;
    }
    .breath-circle::after {
      content: '';
      position: absolute;
      inset: 22px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.35);
      opacity: 0.65;
      transition: opacity 0.6s ease;
    }
    .breath-circle.inhale {
      --target-scale: 1.16;
      background: radial-gradient(circle, rgba(94, 234, 212, 0.45), rgba(56, 189, 248, 0.32));
    }
    .breath-circle.hold {
      --target-scale: 1.16;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.44), rgba(56, 189, 248, 0.28));
      box-shadow: 0 36px 80px rgba(17, 24, 39, 0.45);
    }
    .breath-circle.exhale {
      --target-scale: 0.86;
      background: radial-gradient(circle, rgba(37, 99, 235, 0.28), rgba(17, 94, 189, 0.22));
    }
    .breath-circle.rest {
      --target-scale: 0.9;
      background: radial-gradient(circle, rgba(46, 117, 221, 0.25), rgba(15, 76, 173, 0.18));
      box-shadow: 0 26px 55px rgba(12, 18, 30, 0.4);
    }
    .breath-circle.rest::after {
      opacity: 0.4;
    }
    .instructions {
      position: absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 64px);
      max-width: 360px;
      text-align: center;
      color: rgba(226, 232, 240, 0.8);
      font-size: 1.05rem;
      line-height: 1.6;
    }
    .instructions h2 {
      margin: 0 0 8px;
      font-size: 1.25rem;
      letter-spacing: 0.04em;
      color: #f8fafc;
    }
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .controls button,
    .controls select {
      appearance: none;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(15, 23, 42, 0.6);
      color: #f8fafc;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
    }
    .controls button:hover,
    .controls button:focus,
    .controls select:hover,
    .controls select:focus {
      background: rgba(56, 189, 248, 0.22);
      border-color: rgba(94, 234, 212, 0.45);
      outline: none;
      transform: translateY(-1px);
    }
    footer {
      padding: 28px 24px;
      text-align: center;
      font-size: 0.9rem;
      color: rgba(226, 232, 240, 0.65);
    }
    @keyframes breatheGlow {
      0%,
      100% {
        transform: scale(0.92);
        opacity: 0.45;
      }
      50% {
        transform: scale(1.08);
        opacity: 0.65;
      }
    }
    @keyframes breathePulse {
      0%,
      100% {
        transform: scale(0.85);
        opacity: 0.5;
      }
      50% {
        transform: scale(1.08);
        opacity: 0.85;
      }
    }
    @media (min-width: 1024px) {
      header h1 {
        font-size: clamp(2.8rem, 4vw, 4rem);
      }
      .session-shell {
        gap: 44px;
      }
    }
    @media (max-width: 640px) {
      .session-shell {
        padding-top: 36px;
        gap: 28px;
      }
      .count-display {
        top: 28px;
        letter-spacing: 0.2em;
      }
      .breathing-space {
        border-radius: 24px;
      }
      .instructions {
        bottom: 24px;
        font-size: 1rem;
      }
      .controls {
        flex-direction: column;
      }
      .controls button,
      .controls select {
        width: 100%;
      }
    }
    @keyframes countTick {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }
      30% {
        opacity: 1;
        transform: translateY(0);
      }
      70% {
        opacity: 0.95;
        transform: translateY(0);
      }
      100% {
        opacity: 0.75;
        transform: translateY(6px);
      }
    }
    @media (prefers-reduced-motion: reduce) {
      body::before,
      body::after,
      .breathing-space::before,
      .breath-circle {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#meditationFlow">Skip to breathing guidance</a>
  <div class="session-shell">
    <header>
      <p>3DVR mindfulness studio</p>
      <h1>Mindfulness Breathing Room</h1>
      <span>Follow the gentle cues for as many rounds as you need. Set your cadence, press play, and let the cycle guide you
        back to center.</span>
    </header>
    <div class="breathing-space" role="application" aria-labelledby="meditationFlow">
      <div id="countDisplay" class="count-display" aria-hidden="true">
        <span class="count-display__value">&mdash;</span>
      </div>
      <div id="breathCircle" class="breath-circle inhale" aria-hidden="true"></div>
      <div id="meditationFlow" class="instructions" aria-live="polite">
        <h2 id="phaseName">Inhale</h2>
        <p id="phasePrompt">Breathe in slowly through your nose and fill your lungs.</p>
      </div>
    </div>
    <div class="controls">
      <button type="button" id="toggleSession">Start session</button>
      <select id="paceControl" aria-label="Select breathing pace">
        <option value="slow">Slow &amp; restorative (6 / 2 / 6 / 2)</option>
        <option value="balanced" selected>Balanced rhythm (4 / 4 / 4 / 2)</option>
        <option value="energizing">Energizing focus (3 / 3 / 3 / 1)</option>
      </select>
    </div>
  </div>
  <footer>
    Tip: Pair the breathing room with soft instrumental music or brown noise to deepen focus.
  </footer>
  <script>
    const phasesByPace = {
      slow: [
        {
          label: 'Inhale',
          prompt: 'Draw a long breath in through your nose for six counts.',
          duration: 6000,
          transitionDuration: 3600,
          className: 'inhale'
        },
        {
          label: 'Hold',
          prompt: 'Hold gently and soften your shoulders for two counts.',
          duration: 2000,
          transitionDuration: 500,
          className: 'hold'
        },
        {
          label: 'Exhale',
          prompt: 'Exhale through the mouth for six counts, let the jaw release.',
          duration: 6000,
          transitionDuration: 3600,
          className: 'exhale'
        },
        {
          label: 'Rest',
          prompt: 'Pause and notice how you feel before the next wave.',
          duration: 2000,
          transitionDuration: 600,
          className: 'rest'
        }
      ],
      balanced: [
        {
          label: 'Inhale',
          prompt: 'Breathe in slowly through your nose and fill your lungs.',
          duration: 4000,
          transitionDuration: 2400,
          className: 'inhale'
        },
        {
          label: 'Hold',
          prompt: 'Hold softly and scan for any tension you can let go.',
          duration: 4000,
          transitionDuration: 500,
          className: 'hold'
        },
        {
          label: 'Exhale',
          prompt: 'Release the breath through the mouth and soften the chest.',
          duration: 4000,
          transitionDuration: 2400,
          className: 'exhale'
        },
        {
          label: 'Rest',
          prompt: 'Let the breath settle for two counts before you begin again.',
          duration: 2000,
          transitionDuration: 600,
          className: 'rest'
        }
      ],
      energizing: [
        {
          label: 'Inhale',
          prompt: 'Sip a quick inhale through the nose for three counts.',
          duration: 3000,
          transitionDuration: 1800,
          className: 'inhale'
        },
        {
          label: 'Hold',
          prompt: 'Hold lightly and lift through the crown of your head.',
          duration: 3000,
          transitionDuration: 500,
          className: 'hold'
        },
        {
          label: 'Exhale',
          prompt: 'Breathe out with control for three counts, feel grounded.',
          duration: 3000,
          transitionDuration: 1800,
          className: 'exhale'
        },
        {
          label: 'Rest',
          prompt: 'Take a soft pause for one count before the next inhale.',
          duration: 1000,
          transitionDuration: 450,
          className: 'rest'
        }
      ]
    };

    const breathCircle = document.getElementById('breathCircle');
    const phaseName = document.getElementById('phaseName');
    const phasePrompt = document.getElementById('phasePrompt');
    const toggleSession = document.getElementById('toggleSession');
    const paceControl = document.getElementById('paceControl');
    const countDisplay = document.getElementById('countDisplay');
    const countValue = countDisplay ? countDisplay.querySelector('.count-display__value') : null;

    let currentPaceKey = paceControl.value;
    let phases = phasesByPace[currentPaceKey];
    let phaseIndex = 0;
    let timeoutId = null;
    let isRunning = false;
    let hasStarted = false;
    const motionPreference = window.matchMedia('(prefers-reduced-motion: reduce)');
    let counterAnimationId = null;
    let counterTimeoutId = null;
    let lastDisplayedSecond = 0;
    const wakeLockSupported = 'wakeLock' in navigator;
    let wakeLock = null;

    async function requestWakeLock() {
      if (!wakeLockSupported || wakeLock) {
        return;
      }
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          wakeLock = null;
          if (isRunning && !document.hidden) {
            requestWakeLock();
          }
        });
      } catch (error) {
        wakeLock = null;
        console.warn('Unable to acquire screen wake lock', error);
      }
    }

    async function releaseWakeLock() {
      if (!wakeLockSupported || !wakeLock) {
        return;
      }
      try {
        await wakeLock.release();
      } catch (error) {
        console.warn('Unable to release screen wake lock', error);
      } finally {
        wakeLock = null;
      }
    }

    function updateCountText(value, animate = true) {
      if (!countValue) {
        return;
      }
      if (!animate) {
        countValue.classList.remove('is-ticking');
        countValue.textContent = value;
        return;
      }
      countValue.classList.remove('is-ticking');
      countValue.textContent = value;
      void countValue.offsetWidth;
      countValue.classList.add('is-ticking');
    }

    function setToggleLabel() {
      if (!hasStarted) {
        toggleSession.textContent = 'Start session';
      } else if (isRunning) {
        toggleSession.textContent = 'Pause session';
      } else {
        toggleSession.textContent = 'Resume session';
      }
    }

    function stopCounter() {
      if (counterAnimationId !== null) {
        window.cancelAnimationFrame(counterAnimationId);
        counterAnimationId = null;
      }
      if (counterTimeoutId !== null) {
        window.clearTimeout(counterTimeoutId);
        counterTimeoutId = null;
      }
      if (countValue) {
        countValue.classList.remove('is-ticking');
      }
      lastDisplayedSecond = 0;
    }

    function setIdleCount() {
      if (!countDisplay) {
        return;
      }
      stopCounter();
      updateCountText('â€”', false);
      countDisplay.style.opacity = 0.8;
      lastDisplayedSecond = 0;
    }

    function startCounter(duration) {
      if (!countDisplay) {
        return;
      }
      stopCounter();
      countDisplay.style.opacity = 1;
      const start = performance.now();
      const totalSeconds = Math.max(1, Math.round(duration / 1000));
      updateCountText('1');
      lastDisplayedSecond = 1;
      const updateCount = (now) => {
        const elapsed = Math.min(now - start, duration);
        const seconds = Math.floor(elapsed / 1000) + 1;
        if (seconds !== lastDisplayedSecond && seconds <= totalSeconds) {
          lastDisplayedSecond = seconds;
          updateCountText(String(seconds));
        }
        if (elapsed < duration) {
          counterAnimationId = window.requestAnimationFrame(updateCount);
        }
      };
      counterAnimationId = window.requestAnimationFrame(updateCount);
      counterTimeoutId = window.setTimeout(() => {
        stopCounter();
        updateCountText(String(totalSeconds), false);
      }, duration);
    }

    function applyPhase(phase) {
      breathCircle.className = `breath-circle ${phase.className}`;
      breathCircle.style.setProperty('--transition-duration', `${phase.transitionDuration || phase.duration}ms`);
      phaseName.textContent = phase.label;
      phasePrompt.textContent = phase.prompt;
      if (isRunning) {
        startCounter(phase.duration);
      } else {
        setIdleCount();
      }
    }

    function showIdlePhase() {
      const exhalePhase = phases.find((phase) => phase.className === 'exhale');
      if (exhalePhase) {
        applyPhase(exhalePhase);
      } else if (phases.length) {
        applyPhase(phases[0]);
      }
      if (!isRunning) {
        setIdleCount();
      }
    }

    function scheduleNextPhase() {
      const phase = phases[phaseIndex];
      applyPhase(phase);
      timeoutId = window.setTimeout(() => {
        phaseIndex = (phaseIndex + 1) % phases.length;
        if (isRunning) {
          scheduleNextPhase();
        }
      }, phase.duration);
    }

    function startSession() {
      clearTimeout(timeoutId);
      stopCounter();
      isRunning = true;
      hasStarted = true;
      setToggleLabel();
      requestWakeLock();
      scheduleNextPhase();
    }

    function pauseSession() {
      isRunning = false;
      clearTimeout(timeoutId);
      stopCounter();
      setToggleLabel();
      releaseWakeLock();
    }

    toggleSession.addEventListener('click', () => {
      if (isRunning) {
        pauseSession();
      } else {
        startSession();
      }
    });

    paceControl.addEventListener('change', (event) => {
      currentPaceKey = event.target.value;
      phases = phasesByPace[currentPaceKey];
      phaseIndex = 0;
      updateCycleDuration();
      if (isRunning) {
        startSession();
      } else {
        showIdlePhase();
        setToggleLabel();
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        pauseSession();
      } else if (isRunning) {
        requestWakeLock();
      }
    });

    function updateCycleDuration() {
      const totalDuration = phases.reduce((sum, phase) => sum + phase.duration, 0);
      document.documentElement.style.setProperty('--cycle-duration', `${totalDuration}ms`);
    }

    function handleMotionPreference(event) {
      if (event.matches) {
        if (isRunning) {
          pauseSession();
        } else {
          setToggleLabel();
        }
      } else if (!isRunning && !hasStarted) {
        startSession();
      }
    }

    if (typeof motionPreference.addEventListener === 'function') {
      motionPreference.addEventListener('change', handleMotionPreference);
    } else if (typeof motionPreference.addListener === 'function') {
      motionPreference.addListener(handleMotionPreference);
    }

    window.addEventListener('pagehide', releaseWakeLock);
    window.addEventListener('beforeunload', releaseWakeLock);

    showIdlePhase();
    updateCycleDuration();

    if (!motionPreference.matches) {
      window.requestAnimationFrame(() => {
        window.requestAnimationFrame(() => {
          startSession();
        });
      });
    } else {
      setToggleLabel();
    }
  </script>
</body>
</html>
