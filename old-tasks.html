<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>3DVR - Task Board</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="gun-init.js"></script>
<script src="score.js"></script>
<link rel="stylesheet" href="styles/global.css">
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #e9f0f5;
  color: #222;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}

a {
  color: #66c2b0;
  text-decoration: underline;
  margin-bottom: 20px;
  display: inline-block;
}

h1 {
  text-align: center;
  color: #333;
  margin-top: 0;
  font-size: 2.4rem;
}

.score-card {
  max-width: 920px;
  margin: 10px auto 24px;
  padding: 14px 16px;
  background: #f7fbff;
  border: 1px solid #d9e5ee;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.score-meta {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.score-meta strong {
  color: #1f3a56;
}

.score-value {
  display: inline-flex;
  align-items: baseline;
  gap: 6px;
  font-size: 1.6rem;
  font-weight: 800;
  color: #0c7f6f;
  padding: 8px 14px;
  background: #e6f6f1;
  border-radius: 12px;
  border: 1px solid #bfe5da;
}

.score-value small {
  font-size: 0.9rem;
  font-weight: 600;
  color: #1f3a56;
}

.score-card[data-ready="true"] .score-value {
  animation: pulse-in 180ms ease-out;
}

@keyframes pulse-in {
  from {
    transform: scale(0.97);
    opacity: 0.9;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

#new-task {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

input, button, select {
  padding: 10px;
  font-size: 1rem;
  border-radius: 8px;
  border: none;
}

input {
  flex-grow: 1;
  max-width: 400px;
}

select {
  min-width: 140px;
  background: #ffffff;
  color: #333;
  border: 1px solid #d1d9de;
}

button {
  background: #66c2b0;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

button:hover {
  background: #5ca0d3;
}

#tasks {
  display: grid;
  gap: 15px;
  max-width: 800px;
  margin: auto;
}

.task {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  color: #333;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  position: relative;
  font-size: 1.1rem;
}

.task .meta {
  margin-top: 8px;
  color: #666;
  font-size: 0.95rem;
}

.priority {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 20px;
  background: #eef4f7;
  color: #334;
  font-size: 0.95rem;
  font-weight: 600;
}

.priority-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.priority-critical .priority-dot {
  background: #d93737;
}

.priority-high .priority-dot {
  background: #e58f00;
}

.priority-medium .priority-dot {
  background: #66c2b0;
}

.priority-low .priority-dot {
  background: #5ca0d3;
}

.priority-backlog .priority-dot {
  background: #8c95a1;
}

.task-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-top: 10px;
}

.complete {
  position: absolute;
  top: 10px;
  right: 60px;
  cursor: pointer;
  background: #0f9b81;
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 10px;
  font-weight: 700;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
}

.complete:hover {
  background: #0c826b;
}

.priority-select {
  min-width: 120px;
  padding: 6px 8px;
  border: 1px solid #d1d9de;
  background: #fff;
  color: #333;
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
</style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">üè† Portal</a>
  <a href="notes/">üìù Shared Notes</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ GitHub</a>
</div>

<h1>‚úÖ Task Board</h1>

<section class="score-card" id="score-card" aria-live="polite" aria-label="Task score status">
  <div class="score-meta">
    <strong>Earn score as you stay on top of tasks</strong>
    <span>+5 for new tasks, +25 for completions. Shared across your devices via Gun.</span>
  </div>
  <div class="score-value" id="score-value" aria-label="Current score">
    <span>0</span>
    <small>score</small>
  </div>
</section>

<div id="new-task">
  <input type="text" id="task-input" placeholder="New Task...">
  <select id="priority-input" aria-label="Task priority">
    <option value="Critical">Critical</option>
    <option value="High">High</option>
    <option value="Medium" selected>Medium</option>
    <option value="Low">Low</option>
    <option value="Backlog">Backlog</option>
  </select>
  <button onclick="addTask()">Add Task</button>
</div>

<div class="controls" aria-label="Task sorting and filters">
  <label>
    <span class="sr-only">Sort tasks</span>
    <select id="sort-mode" aria-label="Sort tasks">
      <option value="chronological" selected>Newest first</option>
      <option value="oldest">Oldest first</option>
      <option value="priority">Priority then newest</option>
    </select>
  </label>
  <label>
    <span class="sr-only">Filter by priority</span>
    <select id="priority-filter" aria-label="Filter by priority">
      <option value="All" selected>All priorities</option>
      <option value="Critical">Critical only</option>
      <option value="High">High only</option>
      <option value="Medium">Medium only</option>
      <option value="Low">Low only</option>
      <option value="Backlog">Backlog only</option>
    </select>
  </label>
</div>

<div id="tasks"></div>

<script>
// Setup GUN with the 3DVR relay
const gun = Gun({
  peers: window.__GUN_PEERS__ || [
    'wss://relay.3dvr.tech/gun',
    'wss://gun-relay-3dvr.fly.dev/gun'
  ]
});

const portalRoot = gun.get('3dvr-portal');
const portalUser = gun.user();
const scoreManager = window.ScoreSystem && typeof window.ScoreSystem.getManager === 'function'
  ? window.ScoreSystem.getManager({ gun, user: portalUser, portalRoot })
  : null;

const SCORE_FOR_CREATE = 5;
const SCORE_FOR_COMPLETE = 25;

function sanitizeScoreDisplay(value) {
  if (window.ScoreSystem && typeof window.ScoreSystem.sanitizeScore === 'function') {
    return window.ScoreSystem.sanitizeScore(value);
  }
  const numeric = typeof value === 'number' ? value : Number(value);
  if (!Number.isFinite(numeric)) return 0;
  return Math.max(0, Math.round(numeric));
}

function updateScoreDisplay(value) {
  const safeScore = sanitizeScoreDisplay(value);
  const scoreValueEl = document.getElementById('score-value');
  const scoreCardEl = document.getElementById('score-card');
  if (scoreValueEl) {
    const numberEl = scoreValueEl.querySelector('span');
    if (numberEl) numberEl.textContent = safeScore;
  }
  if (scoreCardEl) {
    scoreCardEl.setAttribute('data-ready', 'true');
  }
}

if (window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
  window.ScoreSystem.ensureGuestIdentity();
}

if (scoreManager && typeof scoreManager.subscribe === 'function') {
  scoreManager.subscribe(updateScoreDisplay);
  if (typeof scoreManager.whenReady === 'function') {
    scoreManager.whenReady().then(updateScoreDisplay);
  }
} else {
  updateScoreDisplay(0);
}

function awardScore(amount) {
  if (!scoreManager || typeof scoreManager.increment !== 'function') return;
  scoreManager.increment(amount);
}

const PRIORITY_LEVELS = ['Critical', 'High', 'Medium', 'Low', 'Backlog'];

// Tasks stored in Gun as { text, priority, createdAt } for shared visibility across sessions.
const tasks = gun.get('3dvr-tasks');

let sortMode = 'chronological';
let priorityFilter = 'All';

function timeAgoOrFullDate(timestamp) {
  const now = Date.now();
  const diff = Math.floor((now - timestamp) / 1000);
  if (diff < 60) return `${diff}s ago`;
  const mins = Math.floor(diff / 60);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const date = new Date(timestamp);
  return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function getCreatedAt(task) {
  return typeof task.createdAt === 'number' && Number.isFinite(task.createdAt)
    ? task.createdAt
    : 0;
}

function getPriority(task) {
  const priority = typeof task.priority === 'string' ? task.priority : '';
  return PRIORITY_LEVELS.includes(priority) ? priority : 'Medium';
}

function priorityWeight(priority) {
  const index = PRIORITY_LEVELS.indexOf(priority);
  return index === -1 ? PRIORITY_LEVELS.indexOf('Medium') : index;
}

function createPrioritySelect(selectedPriority, taskId) {
  const select = document.createElement('select');
  select.className = 'priority-select';
  select.setAttribute('aria-label', 'Edit task priority');
  PRIORITY_LEVELS.forEach(level => {
    const option = document.createElement('option');
    option.value = level;
    option.textContent = level;
    if (level === selectedPriority) {
      option.selected = true;
    }
    select.appendChild(option);
  });
  select.onchange = event => {
    const newPriority = event.target.value;
    tasks.get(taskId).put({ priority: newPriority });
  };
  return select;
}

// Add new task
function addTask() {
  const text = document.getElementById('task-input').value.trim();
  const priority = document.getElementById('priority-input').value;
  if (!text) return;
  tasks.set({ text, priority, createdAt: Date.now() });
  document.getElementById('task-input').value = '';
  awardScore(SCORE_FOR_CREATE);
}

document.getElementById('sort-mode').onchange = event => {
  sortMode = event.target.value;
  renderTasks();
};

document.getElementById('priority-filter').onchange = event => {
  priorityFilter = event.target.value;
  renderTasks();
};

// Store and render tasks
const taskList = {};

tasks.map().on((task, id) => {
  if (!task) {
    document.getElementById(id)?.remove();
    delete taskList[id];
    return;
  }
  taskList[id] = task;
  renderTasks();
});

function renderTasks() {
  const container = document.getElementById('tasks');
  container.innerHTML = '';
  Object.entries(taskList)
    .filter(([, task]) => {
      const priority = getPriority(task);
      return priorityFilter === 'All' || priority === priorityFilter;
    })
    .sort((a, b) => {
      if (sortMode === 'priority') {
        const priorityDiff = priorityWeight(getPriority(a[1])) - priorityWeight(getPriority(b[1]));
        if (priorityDiff !== 0) return priorityDiff;
        return getCreatedAt(b[1]) - getCreatedAt(a[1]);
      }
      if (sortMode === 'oldest') {
        return getCreatedAt(a[1]) - getCreatedAt(b[1]);
      }
      return getCreatedAt(b[1]) - getCreatedAt(a[1]);
    })
    .forEach(([id, task]) => {
      const div = document.createElement('div');
      div.className = 'task';
      div.id = id;
      const createdAt = getCreatedAt(task);
      const timestamp = createdAt ? timeAgoOrFullDate(createdAt) : 'Just now';
      const priority = getPriority(task);

      const textDiv = document.createElement('div');
      textDiv.className = 'task-text';
      textDiv.textContent = task.text;

      const priorityBadge = document.createElement('div');
      priorityBadge.className = `priority priority-${priority.toLowerCase()}`;
      const dot = document.createElement('span');
      dot.className = 'priority-dot';
      dot.setAttribute('aria-hidden', 'true');
      const label = document.createElement('span');
      label.className = 'priority-label';
      label.textContent = `${priority} priority`;
      priorityBadge.appendChild(dot);
      priorityBadge.appendChild(label);

      const metaRow = document.createElement('div');
      metaRow.className = 'task-meta';
      metaRow.appendChild(priorityBadge);
      metaRow.appendChild(createPrioritySelect(priority, id));

      const metaText = document.createElement('div');
      metaText.className = 'meta';
      metaText.textContent = `Added ${timestamp}`;
      metaRow.appendChild(metaText);

      const completeBtn = document.createElement('button');
      completeBtn.className = 'complete';
      completeBtn.type = 'button';
      completeBtn.textContent = 'Complete';
      completeBtn.setAttribute('aria-label', 'Complete task and earn score');
      completeBtn.onclick = () => {
        tasks.get(id).put(null);
        awardScore(SCORE_FOR_COMPLETE);
      };

      div.appendChild(textDiv);
      div.appendChild(metaRow);
      div.appendChild(completeBtn);
      container.appendChild(div);
    });
}
</script>

</body>
</html>
