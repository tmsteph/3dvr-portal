<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>3DVR - Task Board</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="gun-init.js"></script>
<link rel="stylesheet" href="styles/global.css">
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #e9f0f5;
  color: #222;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}

a {
  color: #66c2b0;
  text-decoration: underline;
  margin-bottom: 20px;
  display: inline-block;
}

h1 {
  text-align: center;
  color: #333;
  margin-top: 0;
  font-size: 2.4rem;
}

#new-task {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

input, button, select {
  padding: 10px;
  font-size: 1rem;
  border-radius: 8px;
  border: none;
}

input {
  flex-grow: 1;
  max-width: 400px;
}

select {
  min-width: 140px;
  background: #ffffff;
  color: #333;
  border: 1px solid #d1d9de;
}

button {
  background: #66c2b0;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

button:hover {
  background: #5ca0d3;
}

#tasks {
  display: grid;
  gap: 15px;
  max-width: 800px;
  margin: auto;
}

.task {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  color: #333;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  position: relative;
  font-size: 1.1rem;
}

.task .delete {
  position: absolute;
  top: 10px;
  right: 15px;
  cursor: pointer;
  color: red;
  font-weight: bold;
}

.task .meta {
  margin-top: 8px;
  color: #666;
  font-size: 0.95rem;
}

.priority {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 20px;
  background: #eef4f7;
  color: #334;
  font-size: 0.95rem;
  font-weight: 600;
}

.priority-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.priority-critical .priority-dot {
  background: #d93737;
}

.priority-high .priority-dot {
  background: #e58f00;
}

.priority-medium .priority-dot {
  background: #66c2b0;
}

.priority-low .priority-dot {
  background: #5ca0d3;
}

.priority-backlog .priority-dot {
  background: #8c95a1;
}

.task-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-top: 10px;
}

.priority-select {
  min-width: 120px;
  padding: 6px 8px;
  border: 1px solid #d1d9de;
  background: #fff;
  color: #333;
}

.assignment-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 12px;
}

.assignment-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.assign-input {
  flex: 1;
  min-width: 200px;
  max-width: 260px;
  border: 1px solid #d1d9de;
  background: #fff;
  color: #333;
}

.assignment {
  font-weight: 600;
  color: #334;
}

.edit-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
}

.edit-input {
  flex: 1;
  min-width: 260px;
  max-width: 100%;
  border: 1px solid #d1d9de;
  background: #fff;
  color: #333;
}

.name-label input {
  min-width: 220px;
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.backup-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  align-items: center;
}

.backup-info {
  font-size: 0.95rem;
  color: #334;
}
</style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">üè† Portal</a>
  <a href="notes/">üìù Shared Notes</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ GitHub</a>
</div>

<h1>‚úÖ Task Board</h1>

<div id="new-task">
  <input type="text" id="task-input" placeholder="New Task...">
  <select id="priority-input" aria-label="Task priority">
    <option value="Critical">Critical</option>
    <option value="High">High</option>
    <option value="Medium" selected>Medium</option>
    <option value="Low">Low</option>
    <option value="Backlog">Backlog</option>
  </select>
  <input type="text" id="assignee-input" placeholder="Assignee (optional)">
  <button onclick="addTask()">Add Task</button>
</div>

<div class="controls" aria-label="Your identity">
  <label class="name-label" for="user-name">
    <span class="sr-only">Your display name</span>
    <input type="text" id="user-name" placeholder="Your name" aria-label="Your display name">
  </label>
  <button id="save-name">Save Name</button>
</div>

<div class="controls" aria-label="Task sorting and filters">
  <label>
    <span class="sr-only">Sort tasks</span>
    <select id="sort-mode" aria-label="Sort tasks">
      <option value="chronological" selected>Newest first</option>
      <option value="oldest">Oldest first</option>
      <option value="priority">Priority then newest</option>
    </select>
  </label>
  <label>
    <span class="sr-only">Filter by priority</span>
    <select id="priority-filter" aria-label="Filter by priority">
      <option value="All" selected>All priorities</option>
      <option value="Critical">Critical only</option>
      <option value="High">High only</option>
      <option value="Medium">Medium only</option>
      <option value="Low">Low only</option>
      <option value="Backlog">Backlog only</option>
    </select>
  </label>
</div>

<div class="controls" aria-label="Backup and restore tasks">
  <div class="backup-row">
    <button id="download-backup">Download Backup</button>
    <button id="restore-backup">Restore Backup</button>
    <input type="file" id="backup-file" accept="application/json" hidden aria-label="Upload task backup">
    <div class="backup-info">Keep a backup JSON so you can reimport tasks later.</div>
  </div>
</div>

<div id="tasks"></div>

<script>
// Setup GUN with the 3DVR relay
const gun = Gun({
  peers: window.__GUN_PEERS__ || [
    'wss://relay.3dvr.tech/gun',
    'wss://gun-relay-3dvr.fly.dev/gun'
  ]
});

const PRIORITY_LEVELS = ['Critical', 'High', 'Medium', 'Low', 'Backlog'];
const USERNAME_STORAGE_KEY = '3dvr-task-board-username';
const BACKUP_FILENAME = '3dvr-task-board-backup.json';

// Tasks stored in Gun as { text, priority, createdAt, assignedTo } for shared visibility across sessions.
const tasks = gun.get('3dvr-tasks');

let sortMode = 'chronological';
let priorityFilter = 'All';
let currentUserName = '';

function loadUserName() {
  if (typeof localStorage === 'undefined') {
    return '';
  }
  const stored = localStorage.getItem(USERNAME_STORAGE_KEY);
  return typeof stored === 'string' ? stored : '';
}

function saveUserName(name) {
  currentUserName = name.trim();
  if (typeof localStorage !== 'undefined') {
    localStorage.setItem(USERNAME_STORAGE_KEY, currentUserName);
  }
  const input = document.getElementById('user-name');
  if (input) {
    input.value = currentUserName;
  }
  renderTasks();
}

function timeAgoOrFullDate(timestamp) {
  const now = Date.now();
  const diff = Math.floor((now - timestamp) / 1000);
  if (diff < 60) return `${diff}s ago`;
  const mins = Math.floor(diff / 60);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const date = new Date(timestamp);
  return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function getCreatedAt(task) {
  return typeof task.createdAt === 'number' && Number.isFinite(task.createdAt)
    ? task.createdAt
    : 0;
}

function getTaskText(task) {
  return typeof task.text === 'string' ? task.text.trim() : '';
}

function getPriority(task) {
  const priority = typeof task.priority === 'string' ? task.priority : '';
  return PRIORITY_LEVELS.includes(priority) ? priority : 'Medium';
}

function getAssignee(task) {
  return typeof task.assignedTo === 'string' ? task.assignedTo.trim() : '';
}

function getCreatedOrNow(task) {
  const timestamp = getCreatedAt(task);
  return timestamp || Date.now();
}

function priorityWeight(priority) {
  const index = PRIORITY_LEVELS.indexOf(priority);
  return index === -1 ? PRIORITY_LEVELS.indexOf('Medium') : index;
}

function createPrioritySelect(selectedPriority, taskId) {
  const select = document.createElement('select');
  select.className = 'priority-select';
  select.setAttribute('aria-label', 'Edit task priority');
  PRIORITY_LEVELS.forEach(level => {
    const option = document.createElement('option');
    option.value = level;
    option.textContent = level;
    if (level === selectedPriority) {
      option.selected = true;
    }
    select.appendChild(option);
  });
  select.onchange = event => {
    const newPriority = event.target.value;
    tasks.get(taskId).put({ priority: newPriority });
  };
  return select;
}

function normalizeTask(task) {
  const text = getTaskText(task) || 'Untitled task';
  return {
    text,
    priority: getPriority(task),
    assignedTo: getAssignee(task),
    createdAt: getCreatedOrNow(task)
  };
}

function buildBackupPayload() {
  const entries = Object.entries(taskList)
    .map(([id, task]) => ({ id, ...normalizeTask(task) }));
  return {
    exportedAt: Date.now(),
    tasks: entries
  };
}

function downloadBackup() {
  const payload = buildBackupPayload();
  const blob = new Blob([JSON.stringify(payload, null, 2)], {
    type: 'application/json'
  });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = BACKUP_FILENAME;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function restoreFromBackup(file) {
  const reader = new FileReader();
  reader.onload = event => {
    try {
      const data = JSON.parse(event.target.result);
      if (!data || !Array.isArray(data.tasks)) return;
      data.tasks.forEach(entry => {
        if (!entry || typeof entry !== 'object') return;
        const normalized = normalizeTask(entry);
        if (entry.id && typeof entry.id === 'string') {
          tasks.get(entry.id).put(normalized);
        } else {
          tasks.set(normalized);
        }
      });
    } catch (error) {
      console.error('Failed to restore backup', error);
    }
  };
  reader.readAsText(file);
}

function handleRestoreClick() {
  const fileInput = document.getElementById('backup-file');
  fileInput.value = '';
  fileInput.click();
}

// Add new task
function addTask() {
  const text = document.getElementById('task-input').value.trim();
  const priority = document.getElementById('priority-input').value;
  const assignedTo = document.getElementById('assignee-input').value.trim();
  if (!text) return;
  tasks.set({ text, priority, createdAt: Date.now(), assignedTo });
  document.getElementById('task-input').value = '';
  document.getElementById('assignee-input').value = '';
}

function updateTaskText(taskId, newText) {
  const trimmed = newText.trim();
  if (!trimmed) return;
  tasks.get(taskId).put({ text: trimmed });
}

document.getElementById('sort-mode').onchange = event => {
  sortMode = event.target.value;
  renderTasks();
};

document.getElementById('priority-filter').onchange = event => {
  priorityFilter = event.target.value;
  renderTasks();
};

document.getElementById('download-backup').onclick = () => {
  downloadBackup();
};

document.getElementById('restore-backup').onclick = () => {
  handleRestoreClick();
};

document.getElementById('backup-file').addEventListener('change', event => {
  const [file] = event.target.files || [];
  if (file) {
    restoreFromBackup(file);
  }
});

// Store and render tasks
const taskList = {};

document.getElementById('save-name').onclick = () => {
  const name = document.getElementById('user-name').value;
  saveUserName(name);
};

document.getElementById('user-name').addEventListener('keydown', event => {
  if (event.key === 'Enter') {
    event.preventDefault();
    saveUserName(event.target.value);
  }
});

currentUserName = loadUserName();
document.getElementById('user-name').value = currentUserName;

tasks.map().on((task, id) => {
  if (!task) {
    document.getElementById(id)?.remove();
    delete taskList[id];
    return;
  }
  taskList[id] = task;
  renderTasks();
});

function renderTasks() {
  const container = document.getElementById('tasks');
  container.innerHTML = '';
  Object.entries(taskList)
    .filter(([, task]) => {
      const priority = getPriority(task);
      return priorityFilter === 'All' || priority === priorityFilter;
    })
    .sort((a, b) => {
      if (sortMode === 'priority') {
        const priorityDiff = priorityWeight(getPriority(a[1])) - priorityWeight(getPriority(b[1]));
        if (priorityDiff !== 0) return priorityDiff;
        return getCreatedAt(b[1]) - getCreatedAt(a[1]);
      }
      if (sortMode === 'oldest') {
        return getCreatedAt(a[1]) - getCreatedAt(b[1]);
      }
      return getCreatedAt(b[1]) - getCreatedAt(a[1]);
    })
    .forEach(([id, task]) => {
      const div = document.createElement('div');
      div.className = 'task';
      div.id = id;
      const createdAt = getCreatedAt(task);
      const timestamp = createdAt ? timeAgoOrFullDate(createdAt) : 'Just now';
      const priority = getPriority(task);
      const assignee = getAssignee(task);
      const taskText = getTaskText(task);

      const textDiv = document.createElement('div');
      textDiv.className = 'task-text';
      textDiv.textContent = taskText || 'Untitled task';

      const editRow = document.createElement('div');
      editRow.className = 'edit-row';

      const editLabel = document.createElement('label');
      editLabel.className = 'sr-only';
      editLabel.setAttribute('for', `edit-${id}`);
      editLabel.textContent = 'Edit task text';

      const editInput = document.createElement('input');
      editInput.type = 'text';
      editInput.className = 'edit-input';
      editInput.id = `edit-${id}`;
      editInput.value = taskText;
      editInput.placeholder = 'Update task description';
      editInput.onkeydown = event => {
        if (event.key === 'Enter') {
          event.preventDefault();
          updateTaskText(id, editInput.value);
        }
      };

      const saveEditButton = document.createElement('button');
      saveEditButton.textContent = 'Update Task';
      saveEditButton.onclick = () => updateTaskText(id, editInput.value);

      editRow.appendChild(editLabel);
      editRow.appendChild(editInput);
      editRow.appendChild(saveEditButton);

      const priorityBadge = document.createElement('div');
      priorityBadge.className = `priority priority-${priority.toLowerCase()}`;
      const dot = document.createElement('span');
      dot.className = 'priority-dot';
      dot.setAttribute('aria-hidden', 'true');
      const label = document.createElement('span');
      label.className = 'priority-label';
      label.textContent = `${priority} priority`;
      priorityBadge.appendChild(dot);
      priorityBadge.appendChild(label);

      const metaRow = document.createElement('div');
      metaRow.className = 'task-meta';
      metaRow.appendChild(priorityBadge);
      metaRow.appendChild(createPrioritySelect(priority, id));

      const assignment = document.createElement('div');
      assignment.className = 'meta assignment';
      assignment.textContent = assignee ? `Assigned to ${assignee}` : 'Unassigned';

      const assignmentControls = document.createElement('div');
      assignmentControls.className = 'assignment-controls';

      const assignInput = document.createElement('input');
      assignInput.type = 'text';
      assignInput.className = 'assign-input';
      assignInput.value = assignee;
      assignInput.placeholder = 'Assign to name';
      assignInput.setAttribute('aria-label', 'Assign task to user');

      const assignButton = document.createElement('button');
      assignButton.textContent = 'Assign';
      assignButton.onclick = () => {
        tasks.get(id).put({ assignedTo: assignInput.value.trim() });
      };

      const claimButton = document.createElement('button');
      claimButton.textContent = currentUserName ? 'Claim as Me' : 'Set name to claim';
      claimButton.disabled = !currentUserName;
      claimButton.onclick = () => {
        if (!currentUserName) return;
        tasks.get(id).put({ assignedTo: currentUserName });
      };

      const clearButton = document.createElement('button');
      clearButton.textContent = 'Unassign';
      clearButton.onclick = () => {
        tasks.get(id).put({ assignedTo: '' });
        assignInput.value = '';
      };

      assignmentControls.appendChild(assignInput);
      assignmentControls.appendChild(assignButton);
      assignmentControls.appendChild(claimButton);
      assignmentControls.appendChild(clearButton);

      const metaText = document.createElement('div');
      metaText.className = 'meta';
      metaText.textContent = `Added ${timestamp}`;
      metaRow.appendChild(metaText);

      const assignmentRow = document.createElement('div');
      assignmentRow.className = 'assignment-row';
      assignmentRow.appendChild(assignment);
      assignmentRow.appendChild(assignmentControls);

      const deleteBtn = document.createElement('span');
      deleteBtn.className = 'delete';
      deleteBtn.textContent = 'üóë';
      deleteBtn.onclick = () => tasks.get(id).put(null);

      div.appendChild(textDiv);
      div.appendChild(editRow);
      div.appendChild(metaRow);
      div.appendChild(assignmentRow);
      div.appendChild(deleteBtn);
      container.appendChild(div);
    });
}
</script>

</body>
</html>
