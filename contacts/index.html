<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3DVR Contacts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://fav.farm/üß†" />
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/axe.js"></script>
  <script src="../score.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-10 backdrop-blur bg-gray-900/90 border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="../index.html" class="text-sm text-gray-300 hover:text-white">‚Üê Portal</a>
      <h1 class="text-xl sm:text-2xl font-bold">Contacts <span class="text-teal-400">¬∑ 3DVR</span></h1>
      <span id="spaceBadge" class="hidden text-xs px-2 py-1 rounded bg-white/10">personal</span>
      <div class="ms-auto flex items-center gap-2">
        <span id="userDisplay" class="text-sm text-gray-300"></span>
        <button id="btnLogout" class="hidden bg-rose-600 hover:bg-rose-700 text-white text-sm px-3 py-1.5 rounded">Log out</button>
      </div>
    </div>
  </header>

  <a
    id="floatingIdentity"
    href="../profile.html#profile"
    title="View your profile"
    class="fixed bottom-4 right-4 sm:top-4 sm:bottom-auto sm:right-4 z-30 inline-flex items-center gap-3 rounded-2xl border border-white/15 bg-gray-900/90 px-4 py-3 text-sm text-white shadow-xl shadow-black/30 backdrop-blur"
  >
    <div class="flex flex-col leading-tight">
      <span id="floatingIdentityName" class="font-semibold">üë§ Guest</span>
      <span id="floatingIdentityScore" class="text-xs text-teal-300">‚≠ê 0</span>
    </div>
    <span class="text-xs text-gray-300">Profile ‚Üí</span>
  </a>

  <div id="syncStatus" class="max-w-6xl mx-auto px-4 pt-3 text-sm text-amber-300 hidden">
    Changes pending sync. They'll upload automatically when online.
  </div>

  <main class="max-w-6xl mx-auto p-4 grid gap-6 md:grid-cols-[320px,1fr]">

    <!-- Settings / Space / Backup -->
    <section class="bg-gray-800/60 rounded-xl p-4 border border-white/10">
      <h2 class="text-lg font-semibold mb-2">Space</h2>
      <p class="text-sm text-gray-300 mb-3">
        Store your personal and professional contacts here. Entries default to your private space; switch below if you
        want to collaborate in a shared list.
      </p>
      <select id="spaceSelect" class="w-full p-2 rounded text-black">
        <option value="personal" selected>Personal (private to your account)</option>
        <option value="org-3dvr">Org: 3DVR (shared demo)</option>
        <option value="public-demo">Public demo (guest)</option>
      </select>
      <p class="text-xs text-gray-400 mt-2">
        Signed-in users save to <code>user.get('contacts')</code>. ‚ÄúOrg: 3DVR‚Äù and ‚ÄúPublic demo‚Äù
        are shared (unencrypted) spaces for quick collaboration/testing.
      </p>

      <hr class="my-4 border-white/10">

      <h3 class="text-base font-semibold mb-2">Backup</h3>
      <div class="flex flex-wrap gap-2">
        <button id="btnExportJSON" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded">Export JSON</button>
        <button id="btnExportCSV" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded">Export CSV</button>
        <label class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded cursor-pointer">
          Import JSON
          <input id="importFile" type="file" accept="application/json" class="hidden">
        </label>
        <label class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded cursor-pointer">
          Upload contacts
          <input id="bulkImport" type="file" accept=".csv,.vcf,text/csv,text/vcard,text/x-vcard" class="hidden" multiple>
        </label>
      </div>
      <p class="mt-2 text-xs text-gray-400">
        Export a CSV or vCard file from Apple Contacts, Android/Google, Gmail, or Outlook and upload it here.
      </p>

      <hr class="my-4 border-white/10">

      <h3 class="text-base font-semibold mb-2">Signed-in status</h3>
      <p class="text-sm text-gray-300" id="signedStatus">Checking‚Ä¶</p>
      <button id="btnGoSignIn" class="mt-2 bg-teal-700 hover:bg-teal-800 px-3 py-2 rounded hidden">Go to Sign-In</button>
    </section>

    <!-- Right column -->
    <section class="grid gap-6">
      <!-- Add Contact -->
      <div class="bg-gray-800/60 rounded-xl p-4 border border-white/10">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">Add Contact</h2>
            <p class="text-sm text-gray-300">Capture new relationships without leaving your list.</p>
          </div>
          <button id="openCreateContact" type="button" class="bg-teal-600 hover:bg-teal-700 px-4 py-2 rounded text-sm font-medium">
            New contact
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-gray-800/60 rounded-xl p-4 border border-white/10">
        <div class="grid gap-2 md:grid-cols-[1fr,200px,200px] items-end">
          <div>
            <label class="text-sm text-gray-300">Search</label>
            <input id="search" placeholder="Name, email, company, tags‚Ä¶" class="w-full p-2 rounded text-black" />
          </div>
          <div>
            <label class="text-sm text-gray-300">Status</label>
            <select id="filterStatus" class="w-full p-2 rounded text-black">
              <option value="">Any</option>
              <option>Lead</option><option>Prospect</option><option>Active</option>
              <option>Paused</option><option>Lost</option><option>Friend</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-300">Follow-up</label>
            <select id="filterFollow" class="w-full p-2 rounded text-black">
              <option value="">All</option>
              <option value="overdue">Overdue</option>
              <option value="today">Due today</option>
              <option value="week">Due this week</option>
              <option value="none">No follow-up</option>
            </select>
          </div>
        </div>
      </div>

      <!-- List -->
      <div class="bg-gray-800/60 rounded-xl p-4 border border-white/10">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Contacts</h2>
          <div id="count" class="text-sm text-gray-300"></div>
        </div>
        <div id="duplicateSummary" class="hidden bg-amber-900/40 border border-amber-500/30 rounded-lg p-3 text-sm text-amber-100 mb-4"></div>
        <div id="contactList" class="grid gap-3"></div>
        <div class="mt-4 flex items-center justify-center gap-2">
          <button id="prevPage" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm disabled:opacity-40" disabled>Prev</button>
          <span id="pageInfo" class="text-sm text-gray-300">1/1</span>
          <button id="nextPage" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm disabled:opacity-40" disabled>Next</button>
        </div>
      </div>
    </section>
  </main>

  <div id="createContactOverlay" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm px-4 py-8 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="createContactTitle">
    <div class="w-full max-w-2xl mx-auto bg-gray-900/95 border border-white/10 rounded-2xl shadow-2xl p-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div class="space-y-1">
          <p class="text-xs uppercase tracking-[0.32em] text-teal-300">New contact</p>
          <h2 id="createContactTitle" class="text-2xl font-semibold">Create contact</h2>
          <p class="text-sm text-gray-300">Enter details and save them to your current space.</p>
        </div>
        <button id="closeCreateContact" type="button" class="self-end text-sm text-gray-300 hover:text-white">Close</button>
      </div>
      <form id="contactForm" class="mt-6 grid gap-2 md:grid-cols-2">
        <input id="name" class="p-2 rounded text-black" placeholder="Name" />
        <input id="email" class="p-2 rounded text-black" placeholder="Email" type="email" />
        <input id="phone" class="p-2 rounded text-black" placeholder="Phone" />
        <input id="company" class="p-2 rounded text-black" placeholder="Company" />
        <input id="role" class="p-2 rounded text-black" placeholder="Role (lead, client, friend‚Ä¶)" />
        <input id="tags" class="p-2 rounded text-black" placeholder="Tags (comma separated)" />
        <select id="status" class="p-2 rounded text-black">
          <option value="">Status (optional)</option>
          <option>Lead</option>
          <option>Prospect</option>
          <option>Active</option>
          <option>Paused</option>
          <option>Lost</option>
          <option>Friend</option>
        </select>
        <input id="nextFollowUp" type="date" class="p-2 rounded text-black" />
        <textarea id="notes" class="md:col-span-2 p-2 rounded text-black" placeholder="Notes"></textarea>
        <div class="md:col-span-2 flex gap-2">
          <button type="submit" class="bg-teal-600 hover:bg-teal-700 px-4 py-2 rounded">Save</button>
          <button type="button" id="btnReset" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <div id="contactDetailOverlay" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm px-4 py-8 overflow-y-auto">
    <div id="contactDetailCard" class="w-full max-w-2xl mx-auto bg-gray-900/95 border border-white/10 rounded-2xl shadow-2xl p-6 relative">
      <button id="closeContactDetail" type="button" class="absolute top-4 right-4 text-sm text-gray-300 hover:text-white">Close</button>
      <div class="space-y-5">
        <div class="space-y-1">
          <p class="text-xs uppercase tracking-[0.32em] text-teal-300">Contact detail</p>
          <h2 id="contactDetailName" class="text-2xl font-semibold">Name</h2>
          <p id="contactDetailSummary" class="text-sm text-gray-300">Summary</p>
        </div>
        <div id="contactDetailTags" class="hidden"></div>
        <div id="contactDetailNotes" class="hidden"></div>
        <div id="contactDetailMeta" class="grid gap-2 text-sm text-gray-300"></div>
        <div id="contactDetailLinks" class="text-sm text-gray-300"></div>
        <div id="contactDetailActions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-4 py-8 text-center text-sm text-gray-400">
    Linked with 3DVR Portal auth. Roadmap: calendar bridge, org ACL, email sequences.
  </footer>

<script>
/* ---------- Gun & session reuse ---------- */
const gun = Gun(['https://gun-relay-3dvr.fly.dev/gun']);
const user = gun.user();
const crmRecords = gun.get('3dvr-crm');
const portalRoot = gun.get('3dvr-portal');
const guestsRoot = gun.get('3dvr-guests');
const scoreManager = window.ScoreSystem && typeof window.ScoreSystem.getManager === 'function'
  ? window.ScoreSystem.getManager({ gun, user, portalRoot })
  : null;
const CACHE_PREFIX = 'contacts:cache:';
const QUEUE_PREFIX = 'contacts:pending:';
const CONTACT_FIELDS = [
  'id',
  'name',
  'email',
  'phone',
  'company',
  'role',
  'tags',
  'status',
  'nextFollowUp',
  'notes',
  'created',
  'updated',
  'lastContacted',
  'activityCount',
  'crmId',
  'syncedFromContactsAt',
  'syncedToCRMAt'
];

// Reuse portal's localStorage flags:
const ls = localStorage;
const legacySignedIn = ls.getItem('signedIn') === 'true';
const legacyGuest = ls.getItem('guest') === 'true';
const storedAlias = ls.getItem('alias') || '';
const storedUsername = ls.getItem('username') || '';
const storedPassword = ls.getItem('password') || '';
const authState = window.ScoreSystem && typeof window.ScoreSystem.computeAuthState === 'function'
  ? window.ScoreSystem.computeAuthState()
  : (legacySignedIn
    ? { mode: 'user', alias: storedAlias, username: storedUsername }
    : (legacyGuest
      ? { mode: 'guest' }
      : { mode: 'anon' }));
const signedIn = authState.mode === 'user';
const guest = authState.mode === 'guest';
const alias = signedIn ? (authState.alias || storedAlias) : storedAlias;
const username = signedIn ? (authState.username || storedUsername) : storedUsername;
const password = storedPassword;

// Keep session alive across standalone/browser contexts:
const recallUsed = window.ScoreSystem && typeof window.ScoreSystem.recallUserSession === 'function'
  ? window.ScoreSystem.recallUserSession(user)
  : (() => {
      try {
        user.recall({ sessionStorage: true, localStorage: true });
        return true;
      } catch (err) {
        console.warn('Unable to recall user session', err);
        return false;
      }
    })();

const userDisplay = document.getElementById('userDisplay');
const btnLogout = document.getElementById('btnLogout');
const signedStatus = document.getElementById('signedStatus');
const btnGoSignIn = document.getElementById('btnGoSignIn');
const urlParams = new URLSearchParams(window.location.search);
const requestedSpace = urlParams.get('space');
const focusContactId = urlParams.get('contact');
const focusClasses = ['ring-2', 'ring-emerald-400', 'ring-offset-2', 'ring-offset-gray-900'];
let focusScrollDone = false;

// Silent auth if we have creds from the portal:
if (signedIn) {
  const aliasToUse = alias;
  const usernameToUse = username || aliasToDisplay(aliasToUse);

  function handleSignedIn() {
    onSignedIn(usernameToUse, aliasToUse);
  }

  function handleAuthFailure() {
    if (user.is) {
      handleSignedIn();
      return;
    }
    signedStatus.textContent = 'Couldn\'t reconnect to your private contacts automatically. Viewing Public demo space until you sign in again.';
    btnGoSignIn.classList.remove('hidden');
    setTimeout(() => {
      if (typeof changeSpace === 'function') {
        changeSpace('public-demo', { force: true });
      }
    }, 0);
  }

  if (user.is) {
    handleSignedIn();
  } else if (aliasToUse && password) {
    let resolved = false;
    try {
      user.auth(aliasToUse, password, ack => {
        resolved = true;
        if (ack && ack.err) {
          handleAuthFailure();
        } else {
          handleSignedIn();
        }
      });
    } catch (err) {
      console.warn('Silent auth attempt failed', err);
      resolved = true;
      handleAuthFailure();
    }
    setTimeout(() => {
      if (!resolved) {
        if (user.is) {
          handleSignedIn();
        } else {
          handleAuthFailure();
        }
      }
    }, 1500);
  } else {
    setTimeout(() => {
      if (user.is) {
        handleSignedIn();
      } else {
        handleAuthFailure();
      }
    }, recallUsed ? 800 : 0);
  }
} else if (guest) {
  signedStatus.textContent = 'Guest mode ‚Äî using Public demo space.';
  onGuest();
} else {
  signedStatus.textContent = 'Not signed in. You can still use Public demo space.';
  btnGoSignIn.classList.remove('hidden');
}
btnGoSignIn.addEventListener('click', () => location.href = '../sign-in.html');

btnLogout.addEventListener('click', () => {
  try { user.leave(); } catch {}
  ls.removeItem('signedIn'); ls.removeItem('alias'); ls.removeItem('username'); ls.removeItem('password');
  location.reload();
});

function onSignedIn(username, alias) {
  userDisplay.textContent = `Signed in as ${username} (${alias})`;
  btnLogout.classList.remove('hidden');
  signedStatus.textContent = 'Signed in (personal space available).';
  changeSpace('personal', { force: true });
  flushQueue('personal');
  updateSyncStatus();
}
function onGuest() {
  userDisplay.textContent = 'Guest';
  changeSpace('public-demo', { force: true });
  flushQueue('public-demo');
  updateSyncStatus();
}

/* ---------- Space selection ---------- */
const spaceSelect = document.getElementById('spaceSelect');
const spaceBadge = document.getElementById('spaceBadge');
const allowedSpaces = ['personal', 'org-3dvr', 'public-demo'];

let currentSpace = signedIn ? 'personal' : 'public-demo';
if (requestedSpace && allowedSpaces.includes(requestedSpace)) {
  currentSpace = requestedSpace;
}
spaceSelect.value = currentSpace;
spaceBadge.classList.remove('hidden');
updateSpaceBadge();

spaceSelect.addEventListener('change', () => {
  changeSpace(spaceSelect.value);
});

function spaceLabel(space) {
  if (space === 'personal') return user.is ? 'personal (private)' : 'personal (sign in to unlock)';
  if (space === 'org-3dvr') return 'org: 3dvr';
  if (space === 'public-demo') return 'public demo';
  return space;
}

function updateSpaceBadge() {
  spaceBadge.textContent = spaceLabel(currentSpace);
}

/* ---------- Nodes ---------- */
const ORG_SPACE_KEY = 'org-3dvr-demo'; // shared demo node
function spaceNode(space = currentSpace) {
  if (space === 'personal') {
    if (user.is) return user.get('contacts');
    return null;
  }
  if (space === 'org-3dvr') return gun.get(ORG_SPACE_KEY).get('contacts');
  if (space === 'public-demo') return gun.get('contacts-public');
  return null;
}

/* ---------- Form & UI refs ---------- */
const form = document.getElementById('contactForm');
const syncStatus = document.getElementById('syncStatus');
const listEl = document.getElementById('contactList');
const btnReset = document.getElementById('btnReset');
const searchEl = document.getElementById('search');
const filterStatusEl = document.getElementById('filterStatus');
const filterFollowEl = document.getElementById('filterFollow');
const countEl = document.getElementById('count');
const duplicateSummaryEl = document.getElementById('duplicateSummary');
const prevPageBtn = document.getElementById('prevPage');
const nextPageBtn = document.getElementById('nextPage');
const pageInfo = document.getElementById('pageInfo');
const floatingIdentity = document.getElementById('floatingIdentity');
const floatingIdentityName = document.getElementById('floatingIdentityName');
const floatingIdentityScore = document.getElementById('floatingIdentityScore');
const btnExportJSON = document.getElementById('btnExportJSON');
const btnExportCSV = document.getElementById('btnExportCSV');
const importFile = document.getElementById('importFile');
const bulkImport = document.getElementById('bulkImport');
const createContactOverlay = document.getElementById('createContactOverlay');
const contactDetailOverlay = document.getElementById('contactDetailOverlay');
const contactDetailName = document.getElementById('contactDetailName');
const contactDetailSummary = document.getElementById('contactDetailSummary');
const contactDetailTags = document.getElementById('contactDetailTags');
const contactDetailNotes = document.getElementById('contactDetailNotes');
const contactDetailMeta = document.getElementById('contactDetailMeta');
const contactDetailLinks = document.getElementById('contactDetailLinks');
const contactDetailActions = document.getElementById('contactDetailActions');
const closeContactDetailBtn = document.getElementById('closeContactDetail');
const openCreateContactBtn = document.getElementById('openCreateContact');
const closeCreateContactBtn = document.getElementById('closeCreateContact');

let lastFocusedBeforeCreate = null;

function openCreateContact(){
  if(!createContactOverlay) return;
  lastFocusedBeforeCreate = document.activeElement;
  createContactOverlay.classList.remove('hidden');
  setTimeout(()=>{
    document.getElementById('name')?.focus();
  }, 0);
}

function closeCreateContact(){
  if(!createContactOverlay) return;
  createContactOverlay.classList.add('hidden');
  if (lastFocusedBeforeCreate && typeof lastFocusedBeforeCreate.focus === 'function') {
    lastFocusedBeforeCreate.focus();
  }
}

openCreateContactBtn?.addEventListener('click', openCreateContact);
closeCreateContactBtn?.addEventListener('click', closeCreateContact);
createContactOverlay?.addEventListener('click', evt=>{
  if(evt.target === createContactOverlay) closeCreateContact();
});

/* ---------- State ---------- */
let contactsIndex = {};
let unsubscribers = [];
let page = 1;
let openDetailContactId = null;
const PAGE_SIZE = 20;
const pendingQueues = new Map();
const flushingSpaces = new Set();
const duplicateExpandedState = new Map();
const duplicateMetaById = new Map();
const duplicatePrimaryById = new Map();

let renderTimer = null;
function aliasToDisplay(value) {
  const normalized = typeof value === 'string' ? value.trim() : '';
  if (!normalized) return '';
  if (normalized.includes('@')) {
    return normalized.split('@')[0];
  }
  return normalized;
}

function sanitizeScoreDisplay(value) {
  if (window.ScoreSystem && typeof window.ScoreSystem.sanitizeScore === 'function') {
    return window.ScoreSystem.sanitizeScore(value);
  }
  const numeric = typeof value === 'number' ? value : Number(value);
  if (!Number.isFinite(numeric)) return 0;
  return Math.max(0, Math.round(numeric));
}

if (floatingIdentity && floatingIdentityName && floatingIdentityScore) {
  const isSignedIn = signedIn;
  const isGuest = !isSignedIn && guest;
  let latestDisplayName = '';
  let aliasDisplay = aliasToDisplay(alias);

  function updateIdentityName() {
    let display = '';
    if (latestDisplayName) {
      display = latestDisplayName;
    } else if (isSignedIn) {
      const stored = (localStorage.getItem('username') || '').trim();
      display = stored || aliasDisplay || 'Guest';
    } else if (isGuest) {
      const guestStored = (localStorage.getItem('guestDisplayName') || '').trim();
      display = guestStored || aliasDisplay || 'Guest';
    } else {
      display = aliasDisplay || 'Guest';
    }
    floatingIdentityName.textContent = `üë§ ${display}`;
  }

  function updateIdentityScore(score) {
    floatingIdentityScore.textContent = `‚≠ê ${sanitizeScoreDisplay(score)}`;
  }

  updateIdentityName();
  updateIdentityScore(scoreManager ? scoreManager.getCurrent() : 0);

  if (scoreManager) {
    scoreManager.subscribe(updateIdentityScore);
  }

  if (isSignedIn) {
    try {
      user.get('alias').on(value => {
        aliasDisplay = aliasToDisplay(value);
        updateIdentityName();
      });
      user.get('username').on(name => {
        const normalized = typeof name === 'string' ? name.trim() : '';
        latestDisplayName = normalized;
        if (normalized) {
          localStorage.setItem('username', normalized);
        }
        updateIdentityName();
      });
    } catch (err) {
      console.warn('Failed to bind signed-in identity listeners', err);
    }
  } else if (isGuest) {
    let guestId = '';
    if (window.ScoreSystem && typeof window.ScoreSystem.ensureGuestIdentity === 'function') {
      guestId = window.ScoreSystem.ensureGuestIdentity() || '';
    } else {
      const legacyId = localStorage.getItem('userId');
      if (legacyId && !localStorage.getItem('guestId')) {
        localStorage.setItem('guestId', legacyId);
      }
      if (legacyId) {
        localStorage.removeItem('userId');
      }
      guestId = localStorage.getItem('guestId');
      if (!guestId) {
        guestId = `guest_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('guestId', guestId);
      }
      if (!localStorage.getItem('guestDisplayName')) {
        localStorage.setItem('guestDisplayName', 'Guest');
      }
    }
    if (guestId && guestsRoot) {
      try {
        guestsRoot.get(guestId).get('username').on(name => {
          const normalized = typeof name === 'string' ? name.trim() : '';
          latestDisplayName = normalized;
          if (normalized) {
            localStorage.setItem('guestDisplayName', normalized);
          }
          updateIdentityName();
        });
      } catch (err) {
        console.warn('Failed to bind guest identity listener', err);
      }
    }
  }
}
function scheduleRender(){
  clearTimeout(renderTimer);
  renderTimer = setTimeout(updateList, 40);
}

function cacheKey(space){
  return `${CACHE_PREFIX}${space}`;
}

function queueKey(space){
  return `${QUEUE_PREFIX}${space}`;
}

function sanitizeContactRecord(source = {}, fallbackId){
  const result = {};
  CONTACT_FIELDS.forEach(field => {
    if (source[field] !== undefined) {
      result[field] = source[field];
    }
  });
  if (!result.id) {
    result.id = source.id || fallbackId || '';
  }
  if (!result.created && source.created) {
    result.created = source.created;
  }
  if (!result.updated && source.updated) {
    result.updated = source.updated;
  }
  return result.id ? result : null;
}

function readSpaceCache(space){
  try {
    const raw = ls.getItem(cacheKey(space));
    if (!raw) return {};
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return {};
    return parsed.reduce((acc, item) => {
      const clean = sanitizeContactRecord(item, item && item.id);
      if (clean && clean.id) {
        acc[clean.id] = clean;
      }
      return acc;
    }, {});
  } catch (err) {
    console.warn('Failed to read contacts cache', err);
    return {};
  }
}

function writeSpaceCache(space, index){
  try {
    const values = Object.values(index || {}).map(item => sanitizeContactRecord(item, item && item.id)).filter(Boolean);
    ls.setItem(cacheKey(space), JSON.stringify(values));
  } catch (err) {
    console.warn('Failed to write contacts cache', err);
  }
}

function getQueue(space){
  if (!pendingQueues.has(space)){
    try {
      const raw = ls.getItem(queueKey(space));
      const parsed = raw ? JSON.parse(raw) : [];
      const queue = Array.isArray(parsed) ? parsed : [];
      pendingQueues.set(space, queue);
    } catch (err) {
      console.warn('Failed to read pending queue', err);
      pendingQueues.set(space, []);
    }
  }
  return pendingQueues.get(space);
}

function saveQueue(space){
  try {
    const queue = getQueue(space);
    ls.setItem(queueKey(space), JSON.stringify(queue));
  } catch (err) {
    console.warn('Failed to persist pending queue', err);
  }
  updateSyncStatus();
}

function queuePending(op){
  const queue = getQueue(op.space);
  const entry = {
    ...op,
    data: op.data ? JSON.parse(JSON.stringify(op.data)) : null,
    timestamp: Date.now()
  };
  queue.push(entry);
  saveQueue(op.space);
}

function updateSyncStatus(){
  if (!syncStatus) return;
  let pending = 0;
  allowedSpaces.forEach(space => {
    pending += getQueue(space).length;
  });
  if (pending > 0){
    syncStatus.textContent = pending === 1
      ? '1 change pending sync. It will upload automatically when online.'
      : `${pending} changes pending sync. They will upload automatically when online.`;
    syncStatus.classList.remove('hidden');
  } else {
    syncStatus.classList.add('hidden');
  }
}

function commitOperation(op, { skipQueue = false } = {}){
  const node = spaceNode(op.space);
  if (!node){
    if (!skipQueue){
      queuePending(op);
    }
    return Promise.resolve(false);
  }
  return new Promise(resolve => {
    let settled = false;
    try {
      node.get(op.id).put(op.type === 'del' ? null : op.data, ack => {
        settled = true;
        if (ack && ack.err){
          console.error('Gun write failed', ack.err);
          if (!skipQueue){
            queuePending(op);
          }
          resolve(false);
          return;
        }
        resolve(true);
      });
    } catch (err) {
      console.error('Gun write threw', err);
      if (!skipQueue){
        queuePending(op);
      }
      resolve(false);
      return;
    }
    setTimeout(() => {
      if (settled) return;
      console.warn('Gun write timed out', op);
      if (!skipQueue){
        queuePending(op);
      }
      resolve(false);
    }, 4000);
  });
}

function flushQueue(space){
  if (flushingSpaces.has(space)) return;
  const queue = getQueue(space);
  if (!queue.length) return;
  const node = spaceNode(space);
  if (!node){
    updateSyncStatus();
    return;
  }
  flushingSpaces.add(space);
  const attempt = () => {
    if (!queue.length){
      flushingSpaces.delete(space);
      updateSyncStatus();
      return;
    }
    const current = queue[0];
    commitOperation(current, { skipQueue: true }).then(success => {
      if (success){
        queue.shift();
        saveQueue(space);
        setTimeout(attempt, 60);
      } else {
        flushingSpaces.delete(space);
        updateSyncStatus();
      }
    });
  };
  attempt();
}

function flushAllQueues(){
  allowedSpaces.forEach(space => flushQueue(space));
  updateSyncStatus();
}

function nowISO(){ return new Date().toISOString(); }
function ymd(d){ return d.toISOString().slice(0,10); }
/* ---------- Space attach ---------- */
allowedSpaces.forEach(space => getQueue(space));
updateSyncStatus();
window.addEventListener('online', flushAllQueues);

changeSpace(currentSpace, { force: true });
flushAllQueues();

function changeSpace(space, opts = {}) {
  const next = space || 'public-demo';
  const prev = currentSpace;
  currentSpace = next;
  spaceSelect.value = currentSpace;
  updateSpaceBadge();
  if (!opts.force && prev === currentSpace) return;
  tearDownSpace();
  page = 1;
  contactsIndex = readSpaceCache(currentSpace);
  updateList();
  attachSpace();
  flushQueue(currentSpace);
  updateSyncStatus();
}

function tearDownSpace(){
  unsubscribers.forEach(fn => {
    try {
      if (typeof fn === 'function') fn();
    } catch (err) {
      console.warn('Failed to tear down contacts listener', err);
    }
  });
  unsubscribers = [];
}
function attachSpace(){
  const node = spaceNode();
  if (!node) {
    return;
  }
  const sub = node.map().on((data, id) => {
    if (!id) return;
    if (!data) {
      if (contactsIndex[id]) {
        delete contactsIndex[id];
        writeSpaceCache(currentSpace, contactsIndex);
        scheduleRender();
      }
      return;
    }
    const merged = sanitizeContactRecord({ ...(contactsIndex[id] || {}), ...data }, id);
    if (!merged) {
      if (contactsIndex[id]) {
        delete contactsIndex[id];
        writeSpaceCache(currentSpace, contactsIndex);
        scheduleRender();
      }
      return;
    }
    contactsIndex[id] = merged;
    writeSpaceCache(currentSpace, contactsIndex);
    scheduleRender();
  });
  unsubscribers.push(() => {
    try {
      sub.off();
    } catch (err) {
      console.warn('Failed to detach contacts subscription', err);
    }
  });
}

/* ---------- Create / Update / Delete ---------- */
form.addEventListener('submit', e => {
  e.preventDefault();
  const id = createId();
  const contact = sanitizeContactRecord({
    id,
    name: gi('name'),
    email: gi('email'),
    phone: gi('phone'),
    company: gi('company'),
    role: gi('role'),
    tags: gi('tags'),
    status: gv('status'),
    nextFollowUp: gv('nextFollowUp'),
    notes: gv('notes'),
    created: nowISO(),
    updated: nowISO(),
    lastContacted: '',
    activityCount: 0
  }, id);
  if (!contact) return;
  contactsIndex[id] = contact;
  writeSpaceCache(currentSpace, contactsIndex);
  scheduleRender();
  commitOperation({ type: 'put', space: currentSpace, id, data: contact }).then(() => {
    flushQueue(currentSpace);
  });
  updateSyncStatus();
  if (scoreManager) {
    scoreManager.increment(10);
  }
  form.reset();
  closeCreateContact();
});
btnReset.addEventListener('click', ()=>{
  form.reset();
  document.getElementById('name')?.focus();
});

function updateContact(id, patch, { awardPoints = false } = {}){
  const timestamp = (patch && patch.updated) || nowISO();
  const merged = sanitizeContactRecord({ ...(contactsIndex[id] || {}), ...patch, id, updated: timestamp }, id);
  if (!merged) return;
  if (!merged.updated) {
    merged.updated = timestamp;
  }
  contactsIndex[id] = merged;
  writeSpaceCache(currentSpace, contactsIndex);
  scheduleRender();
  if(openDetailContactId === id && contactDetailOverlay && !contactDetailOverlay.classList.contains('hidden')){
    openContactDetail(id);
  }
  commitOperation({ type: 'put', space: currentSpace, id, data: merged }).then(() => {
    flushQueue(currentSpace);
  });
  updateSyncStatus();
  if (awardPoints && scoreManager) {
    scoreManager.increment(1);
  }
}
function deleteContact(id){
  if (!contactsIndex[id]) return;
  delete contactsIndex[id];
  writeSpaceCache(currentSpace, contactsIndex);
  scheduleRender();
  commitOperation({ type: 'del', space: currentSpace, id }).then(() => {
    flushQueue(currentSpace);
  });
  updateSyncStatus();
}

function addContactToCrm(id){
  const contact = contactsIndex[id];
  if(!contact) return;
  const buttons = [`crm-${id}`, `detail-crm-${id}`].map(eid).filter(Boolean);
  const setButtonState = (text, disabled) => {
    buttons.forEach(btn => {
      if(text != null) btn.textContent = text;
      if(typeof disabled === 'boolean') btn.disabled = disabled;
    });
  };
  setButtonState('Linking‚Ä¶', true);

  const now = nowISO();
  const crmId = contact.crmId || contact.id || createId();
  const payload = {
    id: crmId,
    contactId: contact.id || crmId,
    name: contact.name || '',
    email: contact.email || '',
    phone: contact.phone || '',
    company: contact.company || '',
    role: contact.role || '',
    tags: contact.tags || '',
    status: contact.status || '',
    nextFollowUp: contact.nextFollowUp || '',
    notes: contact.notes || '',
    lastContacted: contact.lastContacted || '',
    activityCount: typeof contact.activityCount === 'number' ? contact.activityCount : 0,
    source: contact.source || 'Contacts workspace',
    created: contact.created || now,
    updated: now,
    syncedFromContactsAt: now
  };

  let settled = false;
  const timer = setTimeout(() => {
    if(settled) return;
    settled = true;
    console.warn('Timed out adding contact to CRM', id);
    setButtonState('Add to CRM', false);
    alert('Unable to add this contact to the CRM right now. Please try again.');
  }, 5000);

  crmRecords.get(crmId).put(payload, ack => {
    if(settled) return;
    settled = true;
    clearTimeout(timer);
    if(ack && ack.err){
      console.error('Failed to add contact to CRM', ack.err);
      setButtonState('Add to CRM', false);
      alert('Unable to add this contact to the CRM right now. Please try again.');
      return;
    }
    setButtonState('Linked!', true);
    updateContact(id, { crmId, syncedToCRMAt: now });
  });
}

/* ---------- Filters & pagination ---------- */
searchEl.addEventListener('input', debounce(()=>{ page=1; updateList(); }, 200));
filterStatusEl.addEventListener('change', ()=>{ page=1; updateList(); });
filterFollowEl.addEventListener('change', ()=>{ page=1; updateList(); });

prevPageBtn.addEventListener('click', ()=>{ if(page>1){ page--; updateList(); }});
nextPageBtn.addEventListener('click', ()=>{ page++; updateList(); });

function applyFilters(items){
  const q = searchEl.value.trim().toLowerCase();
  const fS = filterStatusEl.value;
  const fF = filterFollowEl.value;
  const today = new Date(); today.setHours(0,0,0,0);

  return items.filter(c=>{
    const hay = `${c.name||''} ${c.email||''} ${c.phone||''} ${c.company||''} ${c.role||''} ${c.tags||''} ${c.notes||''}`.toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(fS && (c.status||'') !== fS) return false;

    if(fF){
      const nf = c.nextFollowUp ? new Date(c.nextFollowUp) : null;
      if(fF==='none'){ if(nf) return false; }
      if(fF==='overdue'){ if(!nf || nf >= today) return false; }
      if(fF==='today'){
        if(!nf) return false;
        const d0 = new Date(nf); d0.setHours(0,0,0,0);
        if(d0.getTime() !== today.getTime()) return false;
      }
      if(fF==='week'){
        if(!nf) return false;
        const end = new Date(today); end.setDate(end.getDate()+7);
        if(!(nf >= today && nf <= end)) return false;
      }
    }
    return true;
  }).sort((a,b)=>{
    const aNF = a.nextFollowUp || '';
    const bNF = b.nextFollowUp || '';
    if(aNF && bNF && aNF !== bNF) return aNF < bNF ? -1 : 1;
    if(aNF && !bNF) return -1;
    if(!aNF && bNF) return 1;
    return (b.updated||'').localeCompare(a.updated||'');
  });
}

function updateList(){
  const all = Object.values(contactsIndex);
  const filtered = applyFilters(all);
  const { records: collapsed, hiddenCount } = collapseDuplicates(filtered);
  const total = collapsed.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(page > totalPages) page = totalPages;
  if(focusContactId && !focusScrollDone){
    const focusIndex = collapsed.findIndex(c=>c.id === (duplicatePrimaryById.get(focusContactId) || focusContactId));
    if(focusIndex >= 0){
      const focusPage = Math.floor(focusIndex / PAGE_SIZE) + 1;
      if(page !== focusPage){
        page = focusPage;
      }
    }
  }

  const start = (page-1)*PAGE_SIZE;
  const pageItems = collapsed.slice(start, start + PAGE_SIZE);

  listEl.innerHTML = pageItems.map(renderCard).join('') || `<p class="text-gray-400">No contacts yet.</p>`;

  pageItems.forEach(c=>{
    eid(`edit-${c.id}`)?.addEventListener('click', evt=>{ evt.stopPropagation(); openEdit(c.id); });
    eid(`del-${c.id}`)?.addEventListener('click', evt=>{ evt.stopPropagation(); confirmDelete(c.id); });
    if(!c.crmId){
      eid(`crm-${c.id}`)?.addEventListener('click', evt=>{ evt.stopPropagation(); addContactToCrm(c.id); });
    }
    const card = document.getElementById(c.id);
    if(card){
      card.addEventListener('click', evt=>{
        if(evt.target.closest('button') || evt.target.closest('a')) return;
        openContactDetail(c.id);
      });
      card.classList.add('cursor-pointer');
    }
    if(duplicateMetaById.has(c.id)){
      wireDuplicateControls(c.id);
    }
  });

  const duplicateNote = hiddenCount > 0 ? ` ¬∑ ${hiddenCount} duplicate${hiddenCount===1?'':'s'} auto-hidden` : '';
  countEl.textContent = `${filtered.length} record${filtered.length===1?'':'s'} ‚Üí ${total} contact${total===1?'':'s'}${duplicateNote} ¬∑ page ${page}/${totalPages}`;
  pageInfo.textContent = `${page}/${totalPages}`;
  prevPageBtn.disabled = (page<=1);
  nextPageBtn.disabled = (page>=totalPages);
  updateDuplicateSummary(all);
  highlightFocusedContact();
}

function collapseDuplicates(records){
  duplicateMetaById.clear();
  duplicatePrimaryById.clear();
  const groups = computeDuplicateGroups(records);
  const hiddenIds = new Set();
  groups.forEach(group => {
    const ordered = sortDuplicateCandidates(group.items);
    const primary = ordered[0];
    const duplicates = ordered.slice(1);
    const emailSummary = describeEmailDifferences(ordered);
    duplicateMetaById.set(primary.id, {
      name: group.name,
      total: ordered.length,
      records: ordered,
      duplicates,
      emailSummary
    });
    ordered.forEach(item => {
      duplicatePrimaryById.set(item.id, primary.id);
      if(item.id !== primary.id){
        hiddenIds.add(item.id);
      }
    });
  });

  const seenPrimaries = new Set();
  const result = [];
  records.forEach(record => {
    const primaryId = duplicatePrimaryById.get(record.id);
    if(primaryId){
      if(record.id === primaryId && !seenPrimaries.has(primaryId)){
        result.push(record);
        seenPrimaries.add(primaryId);
      }
    } else {
      result.push(record);
    }
  });

  return {
    records: result,
    hiddenCount: hiddenIds.size
  };
}

function sortDuplicateCandidates(items){
  return items.slice().sort((a,b)=>{
    const aLinked = a.crmId ? 1 : 0;
    const bLinked = b.crmId ? 1 : 0;
    if(aLinked !== bLinked) return bLinked - aLinked;
    const aUpdated = a.updated || a.created || '';
    const bUpdated = b.updated || b.created || '';
    if(aUpdated !== bUpdated) return bUpdated.localeCompare(aUpdated);
    const aScore = duplicateCompletenessScore(a);
    const bScore = duplicateCompletenessScore(b);
    if(aScore !== bScore) return bScore - aScore;
    return (a.id||'').localeCompare(b.id||'');
  });
}

function duplicateCompletenessScore(record){
  const fields = ['email','phone','company','role','tags','status','notes'];
  return fields.reduce((score, field)=>{
    if(record[field]) score += 1;
    return score;
  }, 0);
}

function computeDuplicateGroups(records){
  const groups = new Map();
  records.forEach(contact => {
    const rawName = (contact.name || '').trim();
    const key = (rawName.toLowerCase() || '__no_name__');
    const display = rawName || '(no name)';
    if(!groups.has(key)){
      groups.set(key, { name: display, items: [] });
    } else if(display !== '(no name)' && groups.get(key).name === '(no name)'){
      groups.get(key).name = display;
    }
    groups.get(key).items.push(contact);
  });
  return Array.from(groups.values()).filter(group => group.items.length > 1)
    .sort((a,b)=>b.items.length - a.items.length);
}

function describeEmailDifferences(items){
  const stats = new Map();
  let missing = 0;
  items.forEach(contact => {
    const email = (contact.email || '').trim();
    if(email){
      const key = email.toLowerCase();
      if(!stats.has(key)){
        stats.set(key, { label: email, count: 0 });
      }
      stats.get(key).count += 1;
    } else {
      missing += 1;
    }
  });
  const parts = Array.from(stats.values()).sort((a,b)=>b.count - a.count)
    .map(part => `${part.label}√ó${part.count}`);
  if(missing){
    parts.push(`(no email)√ó${missing}`);
  }
  return {
    uniqueCount: stats.size + (missing ? 1 : 0),
    descriptions: parts
  };
}

function updateDuplicateSummary(records){
  if(!duplicateSummaryEl) return;
  const groups = computeDuplicateGroups(records);
  if(groups.length === 0){
    duplicateSummaryEl.classList.add('hidden');
    duplicateSummaryEl.innerHTML = '';
    return;
  }

  const totalFlagged = groups.reduce((sum, group)=>sum + group.items.length, 0);
  const maxGroups = 5;
  const displayGroups = groups.slice(0, maxGroups);
  const listItems = displayGroups.map(group => {
    const emailSummary = describeEmailDifferences(group.items);
    const label = `${group.items.length} record${group.items.length===1?'':'s'}`;
    const emailDetail = emailSummary.descriptions.length
      ? ` ¬∑ ${emailSummary.uniqueCount} email value${emailSummary.uniqueCount===1?'':'s'} (${emailSummary.descriptions.map(part => hx(part)).join(', ')})`
      : '';
    return `<li class="list-disc list-inside">${hx(group.name)} ‚Äî ${hx(label)}${emailDetail}</li>`;
  }).join('');

  const moreGroups = groups.length - displayGroups.length;
  const moreNote = moreGroups > 0
    ? `<li class="list-disc list-inside text-xs text-amber-200/80">+${moreGroups} more group${moreGroups===1?'':'s'} with duplicates</li>`
    : '';

  duplicateSummaryEl.classList.remove('hidden');
  duplicateSummaryEl.innerHTML = `
    <p class="text-xs uppercase tracking-[0.32em] text-amber-200/70">Possible duplicates</p>
    <p class="text-xs text-amber-100/80 mt-1">${hx(groups.length)} group${groups.length===1?'':'s'} covering ${hx(totalFlagged)} record${totalFlagged===1?'':'s'}.</p>
    <ul class="mt-2 space-y-1 text-sm text-amber-100/90">${listItems}${moreNote}</ul>
  `;
}

function highlightFocusedContact(){
  if(!focusContactId) return;
  const cards = listEl?.querySelectorAll?.('.contact-card') || [];
  cards.forEach(cardEl => {
    focusClasses.forEach(cls => cardEl.classList.remove(cls));
  });
  const targetId = duplicatePrimaryById.get(focusContactId) || focusContactId;
  const card = document.getElementById(targetId);
  if(!card) return;
  focusClasses.forEach(cls => card.classList.add(cls));
  if(targetId !== focusContactId && duplicateMetaById.has(targetId)){
    duplicateExpandedState.set(targetId, true);
    applyDuplicateExpandedState(targetId);
  }
  if(!focusScrollDone){
    focusScrollDone = true;
    setTimeout(()=>{
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  }
}

function getDuplicateToggleLabel(meta, expanded){
  const duplicatesCount = Math.max(0, (meta?.total || 1) - 1);
  if(duplicatesCount === 0) return 'Show duplicates';
  return expanded
    ? `Hide duplicates (${duplicatesCount})`
    : `Show duplicates (${duplicatesCount} hidden)`;
}

function applyDuplicateExpandedState(primaryId){
  const meta = duplicateMetaById.get(primaryId);
  if(!meta) return;
  const expanded = duplicateExpandedState.get(primaryId) === true;
  const panel = document.getElementById(`duplicate-panel-${primaryId}`);
  const toggle = document.querySelector(`[data-duplicate-toggle="${primaryId}"]`);
  if(panel){
    panel.classList.toggle('hidden', !expanded);
  }
  if(toggle){
    toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    toggle.textContent = getDuplicateToggleLabel(meta, expanded);
  }
}

function toggleDuplicatePanel(primaryId){
  const meta = duplicateMetaById.get(primaryId);
  if(!meta) return;
  const currentlyExpanded = duplicateExpandedState.get(primaryId) === true;
  const next = !currentlyExpanded;
  if(next){
    duplicateExpandedState.set(primaryId, true);
  } else {
    duplicateExpandedState.delete(primaryId);
  }
  applyDuplicateExpandedState(primaryId);
}

function wireDuplicateControls(primaryId){
  const meta = duplicateMetaById.get(primaryId);
  if(!meta) return;
  const toggle = document.querySelector(`[data-duplicate-toggle="${primaryId}"]`);
  if(toggle){
    toggle.addEventListener('click', evt=>{
      evt.stopPropagation();
      toggleDuplicatePanel(primaryId);
    });
  }
  meta.records.forEach(record => {
    if(record.id === primaryId) return;
    const openBtn = document.querySelector(`[data-duplicate-open="${record.id}"]`);
    if(openBtn){
      openBtn.addEventListener('click', evt=>{
        evt.stopPropagation();
        duplicateExpandedState.set(primaryId, true);
        applyDuplicateExpandedState(primaryId);
        openContactDetail(record.id);
      });
    }
  });
  applyDuplicateExpandedState(primaryId);
}

function renderDuplicateSection(contact, meta){
  const expanded = duplicateExpandedState.get(contact.id) === true;
  const duplicatesCount = Math.max(0, meta.total - 1);
  const emailDetail = meta.emailSummary && meta.emailSummary.descriptions.length
    ? `${hx(meta.emailSummary.uniqueCount)} email value${meta.emailSummary.uniqueCount===1?'':'s'} (${meta.emailSummary.descriptions.map(part => hx(part)).join(', ')})`
    : 'No email differences recorded';
  const rows = meta.records.map(record => renderDuplicateRow(record, contact.id)).join('');
  return `
    <div class="mt-3 bg-amber-900/30 border border-amber-500/30 rounded-lg p-3 text-amber-50/90">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <p class="text-sm font-semibold">Auto-hidden duplicates</p>
        <button type="button" class="text-xs bg-amber-500/20 hover:bg-amber-500/30 border border-amber-400/40 px-2 py-1 rounded transition" data-duplicate-toggle="${contact.id}" aria-expanded="${expanded?'true':'false'}">${hx(getDuplicateToggleLabel(meta, expanded))}</button>
      </div>
      <p class="text-xs text-amber-100/80 mt-2">${hx(duplicatesCount)} additional record${duplicatesCount===1?'':'s'} hidden ¬∑ ${emailDetail}</p>
      <div id="duplicate-panel-${contact.id}" class="mt-3 space-y-2 ${expanded?'':'hidden'}">
        ${rows}
      </div>
    </div>
  `;
}

function renderDuplicateRow(record, primaryId){
  const isPrimary = record.id === primaryId;
  const summaryParts = [];
  if(record.email) summaryParts.push(record.email);
  if(record.phone) summaryParts.push(record.phone);
  const roleCompany = [record.role, record.company].filter(Boolean).join(' @ ');
  if(roleCompany) summaryParts.push(roleCompany);
  if(record.nextFollowUp) summaryParts.push(`Follow-up ${record.nextFollowUp}`);
  if(record.status) summaryParts.push(`Status ${record.status}`);
  const summary = summaryParts.length ? hx(summaryParts.join(' ¬∑ ')) : '‚Äî';
  const updatedText = record.updated ? `Updated ${ago(record.updated)}` : 'Updated ‚Äî';
  const badges = [];
  if(isPrimary) badges.push('Shown in list');
  if(record.crmId) badges.push('CRM linked');
  const badgeHtml = badges.map(label => `<span class="text-[10px] uppercase tracking-wide bg-white/10 border border-white/20 px-2 py-0.5 rounded">${hx(label)}</span>`).join(' ');
  const actionHtml = isPrimary ? '' : `<button type="button" data-duplicate-open="${record.id}" class="text-xs bg-gray-800/70 hover:bg-gray-700 border border-white/15 px-2 py-1 rounded">Open details</button>`;
  return `
    <div class="bg-gray-900/50 border border-white/10 rounded-lg p-3 space-y-2">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div>
          <p class="text-sm font-semibold text-white/90">${hx(record.name || '(no name)')}</p>
          <p class="text-xs text-gray-300">${summary}</p>
        </div>
        <div class="text-xs text-gray-400 text-right">
          <p>${hx(updatedText)}</p>
          <p>Touches ${hx(typeof record.activityCount === 'number' ? record.activityCount : 0)}</p>
        </div>
      </div>
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="flex flex-wrap gap-1">${badgeHtml}</div>
        ${actionHtml}
      </div>
    </div>
  `;
}

/* ---------- Card UI ---------- */
function renderCard(c){
  const overdue = c.nextFollowUp && new Date(c.nextFollowUp) < new Date(new Date().toDateString());
  const today = c.nextFollowUp && new Date(c.nextFollowUp).toDateString() === new Date().toDateString();
  const tags = (c.tags||'').split(',').map(t=>t.trim()).filter(Boolean)
    .map(t=>`<span class="text-xs px-2 py-0.5 rounded bg-white/10">${hx(t)}</span>`).join(' ');
  const hasCrmLink = !!(c.crmId);
  const email = c.email ? `<a class="underline hover:no-underline" href="mailto:${encodeURIComponent(c.email)}">${hx(c.email)}</a>` : '';
  const phone = c.phone ? `<a class="underline hover:no-underline" href="tel:${encodeURIComponent(c.phone)}">${hx(c.phone)}</a>` : '';
  const crmAction = hasCrmLink
    ? `<a href="../crm/index.html?contact=${encodeURIComponent(c.crmId)}" class="bg-sky-700/60 hover:bg-sky-600 px-3 py-1.5 rounded text-sm border border-sky-300/40 text-sky-100 transition" title="Open this contact in the CRM" target="_blank" rel="noopener">Open CRM</a>`
    : `<button type="button" id="crm-${c.id}" class="bg-sky-600 hover:bg-sky-500 px-3 py-1.5 rounded text-sm border border-sky-300/40 text-white transition">Add to CRM</button>`;
  const duplicateInfo = duplicateMetaById.get(c.id);
  const duplicateBadge = duplicateInfo
    ? `<span class="text-xs px-2 py-0.5 rounded bg-amber-700/60 border border-amber-400/40 text-amber-50">Duplicates √ó${hx(duplicateInfo.total)}</span>`
    : '';

  return `
  <div class="contact-card bg-gray-800 p-4 rounded-lg border border-white/10" id="${c.id}">
    <div class="flex flex-col sm:flex-row gap-3 sm:items-start">
      <div class="flex-1">
        <div class="flex items-center gap-2 flex-wrap">
          <h3 class="text-lg font-bold">${hx(c.name||'(no name)')}</h3>
          ${c.status?`<span class="text-xs px-2 py-0.5 rounded bg-teal-700/60 border border-teal-400/30">${hx(c.status)}</span>`:''}
          ${hasCrmLink?`<span class="text-xs px-2 py-0.5 rounded bg-sky-700/60 border border-sky-400/30">CRM linked</span>`:''}
          ${duplicateBadge}
          ${overdue?`<span class="text-xs px-2 py-0.5 rounded bg-rose-700/60 border border-rose-400/30">Overdue</span>`:(today?`<span class="text-xs px-2 py-0.5 rounded bg-amber-700/60 border border-amber-400/30">Due today</span>`:'')}
        </div>
        <p class="text-sm text-gray-300 mt-0.5">
          ${email}${(email && (c.role||c.company))?' ¬∑ ':''}${hx([c.role,c.company].filter(Boolean).join(' @ '))}
          ${phone?` ¬∑ ${phone}`:''}
        </p>
        ${tags?`<div class="mt-2 flex flex-wrap gap-1">${tags}</div>`:''}
        ${c.notes?`<p class="text-sm text-gray-300 mt-2 whitespace-pre-wrap">${hx(c.notes)}</p>`:''}

        <div class="text-xs text-gray-400 mt-2 grid gap-1 sm:grid-cols-2">
          ${c.lastContacted?`<div>Last contacted: ${ago(c.lastContacted)}</div>`:`<div>Last contacted: ‚Äî</div>`}
          <div>Next follow-up: ${c.nextFollowUp||'‚Äî'}</div>
          <div>Updated: ${c.updated?ago(c.updated):'‚Äî'}</div>
          <div>Touches: ${c.activityCount||0}</div>
        </div>
        ${duplicateInfo ? renderDuplicateSection(c, duplicateInfo) : ''}
      </div>
      <div class="shrink-0 flex flex-wrap gap-2">
        ${crmAction}
        <button id="edit-${c.id}" class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1.5 rounded text-sm">Edit</button>
        <button id="del-${c.id}" class="bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded text-sm">Delete</button>
      </div>
    </div>
  </div>`;
}

function openContactDetail(id){
  const contact = contactsIndex[id];
  if(!contact) return;
  openDetailContactId = id;
  const summaryParts = [];
  if(contact.email){
    summaryParts.push(`<a class="underline hover:no-underline" href="mailto:${encodeURIComponent(contact.email)}">${hx(contact.email)}</a>`);
  }
  const roleCompany = [contact.role, contact.company].filter(Boolean).join(' @ ');
  if(roleCompany){
    summaryParts.push(hx(roleCompany));
  }
  if(contact.phone){
    summaryParts.push(`<a class="underline hover:no-underline" href="tel:${encodeURIComponent(contact.phone)}">${hx(contact.phone)}</a>`);
  }

  contactDetailName.textContent = contact.name || '(no name)';
  contactDetailSummary.innerHTML = summaryParts.join(' ¬∑ ') || '‚Äî';

  const tags = (contact.tags||'').split(',').map(t=>t.trim()).filter(Boolean)
    .map(t=>`<span class="text-xs px-2 py-0.5 rounded bg-white/10">${hx(t)}</span>`).join(' ');
  if(tags){
    contactDetailTags.innerHTML = `<div class="flex flex-wrap gap-1">${tags}</div>`;
    contactDetailTags.classList.remove('hidden');
  } else {
    contactDetailTags.classList.add('hidden');
    contactDetailTags.innerHTML = '';
  }

  if(contact.notes){
    contactDetailNotes.innerHTML = `<div class="bg-gray-800/70 border border-white/10 rounded-lg p-3 text-sm text-gray-200 whitespace-pre-wrap">${hx(contact.notes)}</div>`;
    contactDetailNotes.classList.remove('hidden');
  } else {
    contactDetailNotes.classList.add('hidden');
    contactDetailNotes.innerHTML = '';
  }

  const metaRows = [
    ['Status', contact.status || '‚Äî'],
    ['Next follow-up', contact.nextFollowUp || '‚Äî'],
    ['Last contacted', contact.lastContacted ? `${ago(contact.lastContacted)} ¬∑ ${new Date(contact.lastContacted).toLocaleDateString()}` : '‚Äî'],
    ['Touches', contact.activityCount || 0],
    ['Created', contact.created ? new Date(contact.created).toLocaleString() : '‚Äî'],
    ['Updated', contact.updated ? new Date(contact.updated).toLocaleString() : '‚Äî']
  ];
  contactDetailMeta.innerHTML = metaRows.map(([label, value])=>`
    <div class="flex justify-between gap-3">
      <span class="text-gray-400">${hx(label)}</span>
      <span class="font-medium text-white/90 text-right">${hx(value)}</span>
    </div>
  `).join('');

  if(contact.crmId){
    contactDetailLinks.innerHTML = `
      <div class="bg-sky-900/40 border border-sky-500/30 rounded-lg p-4">
        <p class="text-sm font-semibold text-sky-200">Linked CRM record</p>
        <p class="text-xs text-sky-100/80 mt-1">Synced as <code>${hx(contact.crmId)}</code></p>
        <div class="mt-3 flex flex-wrap gap-2">
          <a href="../crm/index.html?contact=${encodeURIComponent(contact.crmId)}" target="_blank" rel="noopener" class="bg-sky-600 hover:bg-sky-500 text-white text-sm px-3 py-1.5 rounded">Open CRM</a>
        </div>
      </div>
    `;
  } else {
    contactDetailLinks.innerHTML = `
      <div class="bg-gray-800/80 border border-white/10 rounded-lg p-4 space-y-3">
        <div>
          <p class="text-sm font-semibold text-gray-100">Manage shared records in CRM</p>
          <p class="text-xs text-gray-400 mt-1">Head to the CRM workspace to create shared deal tracking entries.</p>
        </div>
        <button type="button" id="detail-crm-${id}" class="bg-sky-600 hover:bg-sky-500 text-white text-sm px-3 py-1.5 rounded">Add to CRM</button>
      </div>
    `;
  }

  contactDetailActions.innerHTML = `
    <button id="detail-edit-${id}" class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1.5 rounded text-sm">Edit</button>
    <button id="detail-delete-${id}" class="bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded text-sm">Delete</button>
  `;

  eid(`detail-crm-${id}`)?.addEventListener('click', ()=>addContactToCrm(id));
  eid(`detail-edit-${id}`)?.addEventListener('click', ()=>openEdit(id));
  eid(`detail-delete-${id}`)?.addEventListener('click', ()=>confirmDelete(id));

  contactDetailOverlay.classList.remove('hidden');
  contactDetailOverlay.scrollTop = 0;
}

function closeContactDetail(){
  contactDetailOverlay.classList.add('hidden');
  openDetailContactId = null;
}

closeContactDetailBtn.addEventListener('click', closeContactDetail);
contactDetailOverlay.addEventListener('click', evt=>{
  if(evt.target === contactDetailOverlay) closeContactDetail();
});
document.addEventListener('keydown', evt=>{
  if(evt.key !== 'Escape') return;
  let handled = false;
  if(createContactOverlay && !createContactOverlay.classList.contains('hidden')){
    closeCreateContact();
    handled = true;
  }
  if(!contactDetailOverlay.classList.contains('hidden')){
    closeContactDetail();
    handled = true;
  }
  if(handled) evt.preventDefault();
});

function openEdit(id){
  const c = contactsIndex[id]; if(!c) return;
  const el = document.getElementById(id);
  el.innerHTML = `
    <form id="editForm-${id}" class="grid gap-2">
      <div class="grid md:grid-cols-2 gap-2">
        ${it(`e-name-${id}`, c.name,'Name')}
        ${it(`e-email-${id}`, c.email,'Email')}
        ${it(`e-phone-${id}`, c.phone,'Phone')}
        ${it(`e-company-${id}`, c.company,'Company')}
        ${it(`e-role-${id}`, c.role,'Role')}
        ${it(`e-tags-${id}`, c.tags,'Tags')}
        <select id="e-status-${id}" class="p-2 rounded text-black">
          ${['','Lead','Prospect','Active','Paused','Lost','Friend'].map(s=>`<option ${s===(c.status||'')?'selected':''}>${s}</option>`).join('')}
        </select>
        <input id="e-next-${id}" type="date" class="p-2 rounded text-black" value="${ha(c.nextFollowUp||'')}">
      </div>
      <textarea id="e-notes-${id}" class="p-2 rounded text-black" rows="4" placeholder="Notes">${hx(c.notes||'')}</textarea>
      <div class="flex gap-2">
        <button class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded" type="submit">Save</button>
        <button type="button" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded" onclick="scheduleRender()">Cancel</button>
      </div>
    </form>`;
  eid(`editForm-${id}`).addEventListener('submit', e=>{
    e.preventDefault();
    updateContact(id, {
      name: gv(`e-name-${id}`),
      email: gv(`e-email-${id}`),
      phone: gv(`e-phone-${id}`),
      company: gv(`e-company-${id}`),
      role: gv(`e-role-${id}`),
      tags: gv(`e-tags-${id}`),
      status: gv(`e-status-${id}`),
      nextFollowUp: gv(`e-next-${id}`),
      notes: gv(`e-notes-${id}`)
    }, { awardPoints: true });
  });
}
function confirmDelete(id){
  const c = contactsIndex[id];
  if(c && confirm(`Delete ${c.name||'this contact'}?`)) deleteContact(id);
}
/* ---------- Export / Import ---------- */
btnExportJSON.addEventListener('click', ()=>{
  const data = Object.values(contactsIndex);
  download(`contacts-${currentSpace}-${Date.now()}.json`, JSON.stringify(data, null, 2), 'application/json');
});
btnExportCSV.addEventListener('click', ()=>{
  const rows = Object.values(contactsIndex);
  const cols = ['id','name','email','phone','company','role','tags','status','nextFollowUp','notes','created','updated','lastContacted','activityCount'];
  const header = cols.join(',');
  const lines = rows.map(r=>cols.map(k=>csvCell(r[k])).join(','));
  download(`contacts-${currentSpace}-${Date.now()}.csv`, [header, ...lines].join('\n'), 'text/csv');
});
importFile.addEventListener('change', async e=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{
    const text = await f.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Invalid JSON');
    arr.forEach(rec=>{
      const id = rec.id || createId();
      const created = rec.created || nowISO();
      const updated = rec.updated || nowISO();
      updateContact(id, { ...rec, id, created, updated });
    });
    alert(`Imported ${arr.length} contacts.`);
  }catch(err){
    alert('Import failed: ' + err.message);
  }finally{
    importFile.value = '';
  }
});

bulkImport.addEventListener('change', async e=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;
  try {
    let total = 0;
    for (const file of files) {
      const text = await file.text();
      const parsed = parseContactFile(text, file.name);
      if(!parsed.length) continue;
      parsed.forEach(rec=>{
        const id = rec.id || createId();
        const created = rec.created || nowISO();
        const updated = rec.updated || nowISO();
        updateContact(id, { ...rec, id, created, updated });
      });
      total += parsed.length;
    }
    alert(total ? `Imported ${total} contact${total===1?'':'s'} from uploaded file(s).` : 'No contacts detected in the uploaded files.');
  } catch(err) {
    console.error(err);
    alert('Upload failed: ' + err.message);
  } finally {
    bulkImport.value = '';
  }
});

/* ---------- Helpers ---------- */
function gi(id){ return (document.getElementById(id)?.value || '').trim(); }
function gv(id){ return (document.getElementById(id)?.value || '').trim(); }
function eid(id){ return document.getElementById(id); }
function it(id, val, ph){ return `<input id="${id}" class="p-2 rounded text-black" value="${ha(val||'')}" placeholder="${ha(ph)}">`; }

function debounce(fn, ms){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function ago(iso){ const d=new Date(iso); const s=((Date.now()-d)/1000)|0;
  if(s<60) return `${s}s ago`; const m=(s/60)|0; if(m<60) return `${m}m ago`;
  const h=(m/60)|0; if(h<24) return `${h}h ago`; const days=(h/24)|0; if(days<30) return `${days}d ago`;
  return d.toLocaleDateString();
}
function hx(str){ return String(str).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function ha(str){ return String(str).replace(/"/g,'&quot;'); }
function csvCell(v){
  if(v==null) return '';
  const s=String(v).replace(/"/g,'""');
  if(/[",\n]/.test(s)) return `"${s}"`; return s;
}
function parseContactFile(text, filename=''){
  const lower = filename.toLowerCase();
  if(lower.endsWith('.vcf') || /BEGIN:VCARD/i.test(text)) return parseVCard(text);
  return parseCSVContacts(text);
}
function createId(){
  if(typeof crypto !== 'undefined' && crypto.randomUUID){
    return crypto.randomUUID();
  }
  return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
}
function parseVCard(text){
  const cards = text.split(/BEGIN:VCARD/i).slice(1).map(chunk=>chunk.split(/END:VCARD/i)[0]||'');
  return cards.map(card=>card.split(/\r?\n/)).map(lines=>{
    const unfolded = [];
    lines.forEach(line=>{
      if(line==null) return;
      if(line.startsWith(' ') || line.startsWith('\t')){
        unfolded[unfolded.length-1] = (unfolded[unfolded.length-1]||'') + line.slice(1);
      } else {
        unfolded.push(line);
      }
    });
    const data = {};
    unfolded.forEach(raw=>{
      if(!raw) return;
      const [keyPart, ...rest] = raw.split(':');
      if(!rest.length) return;
      const value = rest.join(':').trim();
      const key = keyPart.split(';')[0].toUpperCase();
      if(key==='FN') data.name = decodeVCard(value, keyPart);
      if(key==='EMAIL') data.email = decodeVCard(value, keyPart);
      if(key==='TEL') data.phone = decodeVCard(value, keyPart);
      if(key==='ORG') data.company = decodeVCard(value, keyPart);
      if(key==='TITLE') data.role = decodeVCard(value, keyPart);
      if(key==='NOTE') data.notes = decodeVCard(value, keyPart);
    });
    data.tags = '';
    return normalizeImportedContact(data);
  }).filter(Boolean);
}
function decodeVCard(value, meta=''){
  let result = value;
  if(/ENCODING=QUOTED-PRINTABLE/i.test(meta)){
    result = result.replace(/=\r?\n/g, '').replace(/=([0-9A-F]{2})/gi, (_, hex)=>String.fromCharCode(parseInt(hex,16)));
  }
  result = result.replace(/\\n/g, '\n').replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\\\/g,'\\');
  return result.trim();
}
function parseCSVContacts(text){
  const rows = text.split(/\r?\n/).filter(line=>line.trim().length>0);
  if(!rows.length) return [];
  const header = csvSplit(rows.shift());
  const cols = header.map(h=>h.trim().toLowerCase());
  return rows.map(row=>{
    const values = csvSplit(row);
    const data = {};
    cols.forEach((col, idx)=>{
      const val = values[idx]||'';
      const norm = col.replace(/\s+\d+\s*-\s*/g, ' ').trim();
      if(['name','full name'].includes(norm)) data.name = val;
      if(['first name','firstname','given name'].includes(norm)) data.firstName = val;
      if(['last name','lastname','surname','family name'].includes(norm)) data.lastName = val;
      if(norm.includes('email') || norm.includes('e-mail')) data.email = val;
      if(norm.includes('phone')||norm.includes('mobile')||norm.includes('telephone')) data.phone = val;
      if(['company','organization','organisation','org','organization name','organisation name'].includes(norm)) data.company = val;
      if(['title','job title','position','role','organization title','organisation title'].includes(norm)) data.role = val;
      if(norm.includes('note')) data.notes = val;
      if(norm.includes('tag')||norm.includes('label')||norm.includes('group membership')) data.tags = val;
    });
    return normalizeImportedContact(data);
  }).filter(Boolean);
}
function csvSplit(line){
  const result = [];
  let current = '';
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const char = line[i];
    if(inQuotes){
      if(char==='"'){
        if(line[i+1]==='"'){
          current+='"';
          i++;
        } else {
          inQuotes=false;
        }
      } else {
        current+=char;
      }
    } else {
      if(char==='"'){
        inQuotes=true;
      } else if(char===','){
        result.push(current.trim());
        current='';
      } else {
        current+=char;
      }
    }
  }
  result.push(current.trim());
  return result;
}
function normalizeImportedContact(raw){
  if(!raw) return null;
  const name = raw.name || [raw.firstName, raw.lastName].filter(Boolean).join(' ').trim();
  if(!(name || raw.email || raw.phone)) return null;
  return {
    id: createId(),
    name: name || '',
    email: (raw.email||'').trim(),
    phone: (raw.phone||'').trim(),
    company: (raw.company||'').trim(),
    role: (raw.role||'').trim(),
    tags: (raw.tags||'').trim(),
    status: '',
    nextFollowUp: '',
    notes: (raw.notes||'').trim(),
    created: nowISO(),
    updated: nowISO(),
    lastContacted: '',
    activityCount: 0
  };
}
function download(filename, data, type){
  const blob = new Blob([data], {type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

/* Initial render once listeners start */
let firstRenderTimer = setTimeout(updateList, 200);
</script>

</body>
</html>
